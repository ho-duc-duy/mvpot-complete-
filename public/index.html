<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title will be updated by JS -->
    <title
        data-lang-en="MV Concept Generator"
        data-lang-es="Generador de Conceptos MV"
        data-lang-vi="Trình tạo ý tưởng MV"
        data-lang-ja="MVコンセプトジェネレーター"
        data-lang-zhcn="MV概念生成器"
    >MV Concept Generator</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Add common fonts requested by the AI (Optional, improves display if generated) -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&family=Roboto+Mono:wght@400&family=Lora:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">

    <!-- Three.js CDN -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
            }
        }
    </script>
    <!-- JSZip CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>


    <style>
        /* --- NEW DESIGN SYSTEM (Mostly Unchanged) --- */

        /* CSS Variables for Theme */
        :root {
            --bg-dark: #1a1a1d; /* Very dark grey, almost black */
            --bg-card: #2c2c30; /* Slightly lighter card background */
            --bg-card-hover: #35353a;
            --bg-output-area: #222225; /* Slightly darker for contrast with sidebar */
            --text-primary: #f0f0f5; /* Off-white */
            --text-secondary: #a9a9b3; /* Lighter grey */
            --accent-primary: #6a8ee7; /* Soft blue */
            --accent-secondary: #e476e4; /* Soft magenta/purple */
            --accent-gradient: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary)); /* Modified gradient for pricing highlight */
            --border-color: #404045;
            --input-bg-color: #38383d; /* Slightly lighter input background */
            --success-color: #57cc99;
            --warning-color: #ffb703;
            --error-color: #e63946;
            --font-family: 'Poppins', sans-serif;
            --nav-height: 70px;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px; /* Added for pricing card */
            --box-shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.2);
            --box-shadow-glow: 0 0 15px rgba(106, 142, 231, 0.3); /* Glow for accent elements */
             /* Loader Variables */
            --loader-sp: 2.5s; /* Speed for new loader */
            /* Feature Page Specific */
            --sidebar-width: 380px;
            --sidebar-width-md: 320px;
            --sidebar-width-sm: 100%; /* Full width on small screens */
            /* Pricing Page Specific */
            --pricing-highlight-padding: 4px; /* Padding inside highlight border */

        }

        /* Basic Reset & Defaults */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family);
            line-height: 1.7;
            color: var(--text-primary);
            background-color: var(--bg-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scrollbar */
            transition: background-color 0.3s ease;
            position: relative; /* Needed for z-index stacking */
        }
        main {
            flex-grow: 1;
            padding-top: var(--nav-height);
            width: 100%;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- START: 3D Background Canvas --- */
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; display: block; margin: 0; padding: 0;
            pointer-events: none; outline: none;
        }
        /* --- END: 3D Background Canvas --- */

        /* --- START: Floating Images --- */
        #parallax-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
            display: none;
        }

        .parallax-image {
            position: absolute;
            opacity: 0.85;
            transition: opacity 0.5s ease-in-out;
            max-width: 200px;
            height: auto;
            filter: drop-shadow(0px 5px 15px rgba(0,0,0,0.3));
            animation-name: floatAnimation;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            animation-direction: alternate;
        }

        @keyframes floatAnimation {
            0% { transform: translate(0px, 0px) rotate(-1deg); }
            25% { transform: translate(2px, -3px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(1deg); }
            75% { transform: translate(-3px, -2px) rotate(0deg); }
            100% { transform: translate(0px, 0px) rotate(-1deg); }
        }

        #parallax-speaker { top: 20%; left: 10%; max-width: 180px; }
        #parallax-dj { top: 50%; left: 5%; max-width: 220px; }
        #parallax-cutscene { top: 15%; right: 8%; max-width: 150px;}
        #parallax-soundcard { top: 60%; right: 12%; max-width: 160px;}
        #parallax-headphones { top: 35%; right: 15%; max-width: 190px; }
        /* --- END: Floating Images --- */


        /* --- LOADING OVERLAY --- */
        #loading-overlay { position: fixed; inset: 0; background-color: rgba(26, 26, 29, 0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; opacity: 0; transition: opacity 0.4s ease-in-out; }
        #loading-overlay.show { display: flex; opacity: 1; }
        .new-loader-container { width: 100px; height: 100px; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; }
        .new-loader-content { width: 50vmin; height: 50vmin; max-width: 100%; max-height: 100%; position: relative; display: flex; align-items: center; justify-content: center; transform: scale(0.2); animation: spin-all calc(var(--loader-sp) * 2) linear 0s infinite; }
        .new-loader-circle { --ar: var(--accent-primary); --dt: var(--accent-secondary); --shadow: drop-shadow(0vmin 0vmin 0.5vmin rgba(0,0,0,0.5)) drop-shadow(0vmin 0.5vmin 0.5vmin rgba(0,0,0,0.3)); --cross: linear-gradient(0deg, #fff0 calc(50% - 1px), rgba(255,255,255,0.2) calc(50% - 0.5px) calc(50% + 0.5px), #fff0 calc(50% + 1px)), linear-gradient(90deg, #fff0 calc(50% - 1px), rgba(255,255,255,0.2) calc(50% - 0.5px) calc(50% + 0.5px), #fff0 calc(50% + 1px)); --in: 80%; border: 6vmin solid var(--ar); width: var(--in); height: var(--in); border-radius: 100%; position: absolute; box-sizing: border-box; border-top-color: #fff0; border-left-color: #fff0; top: 15vmin; right: -10vmin; animation: spin-bot var(--loader-sp) ease 0s infinite; background-image: var(--cross), radial-gradient(var(--dt) 5.5vmin, #fff0 calc(5.5vmin + 1px)); background-repeat: no-repeat; background-size: 3vmin 1vmin, 1vmin 3vmin, 100% 100%; filter: var(--shadow); }
        .new-loader-circle:nth-child(2) { --in: 60%; top: -2vmin; animation: spin-top var(--loader-sp) ease 0s infinite; transform: rotate(-45deg); background-image: var(--cross), radial-gradient(var(--dt) 1.25vmin, #fff0 calc(1.25vmin + 1px)); right: -4vmin; filter: hue-rotate(15deg) var(--shadow); background-size: 1.4vmin 1vmin, 1vmin 1.4vmin, 100% 100%; }
        .new-loader-circle:nth-child(3) { --in: 100%; top: -5vmin; left: -13vmin; transform: rotate(175deg); animation: spin-left var(--loader-sp) ease calc(var(--loader-sp) / 4) infinite; background-image: var(--cross), radial-gradient(var(--dt) 9vmin, #fff0 calc(9vmin + 1px)); filter: hue-rotate(30deg) var(--shadow); background-size: 5vmin 1vmin, 1vmin 5vmin, 100% 100%; }
        .new-loader-circle:nth-child(4) { --in: 60%; top: 35vmin; left: -6vmin; transform: rotate(-280deg); animation: spin-last var(--loader-sp) ease calc(calc(calc(var(--loader-sp) / 4) + var(--loader-sp)) * -1) infinite; background-image: var(--cross), radial-gradient(var(--dt) 2.5vmin, #fff0 calc(2.5vmin + 1px)); filter: hue-rotate(45deg) var(--shadow); background-size: 2vmin 1vmin, 1vmin 2vmin, 100% 100%; }
        @keyframes spin-all { 0% { transform: rotate(0deg) scale(0.2); } 100% { transform: rotate(360deg) scale(0.2); } } @keyframes spin-top { 0% { transform: rotate(-45deg); } 100% { transform: rotate(315deg); } } @keyframes spin-bot { 0%, 35% { transform: rotate(0deg); } 80%, 100% { transform: rotate(-360deg); } } @keyframes spin-left { 0%, 35% { transform: rotate(175deg); } 80%, 100% { transform: rotate(535deg); } } @keyframes spin-last { 0%, 10% { transform: rotate(-280deg); } 90%, 100% { transform: rotate(-640deg); } }
        #loading-overlay p { font-weight: 500; color: var(--text-primary); margin-top: 1rem; font-size: 1.2em; text-align: center; max-width: 80%; }

        /* --- Navigation --- */
        .main-nav { background-color: rgba(44, 44, 48, 0.8); backdrop-filter: blur(10px); color: var(--text-primary); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; height: var(--nav-height); }
        .logo { font-weight: 600; font-size: 1.4rem; color: var(--text-primary); text-decoration: none; user-select: none; display: flex; align-items: center; gap: 0.5rem; }
        .logo img { max-height: 40px; width: auto; object-fit: contain; vertical-align: middle; }
        .main-nav ul { list-style: none; display: flex; align-items: center; gap: 1.5rem; }
        .main-nav ul li a { color: var(--text-secondary); text-decoration: none; padding: 0.5rem 0.8rem; font-size: 1rem; font-weight: 500; border-radius: var(--border-radius-sm); transition: color 0.3s ease, background-color 0.3s ease; position: relative; overflow: hidden; cursor: pointer; }
        .main-nav ul li a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent-gradient); transform: scaleX(0); transform-origin: right; transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        .main-nav ul li a:hover, .main-nav ul li a.active { color: var(--text-primary); background-color: rgba(255, 255, 255, 0.05); }
        .main-nav ul li a.active::after { transform: scaleX(1); transform-origin: left; }
        #settings-box { display: flex; align-items: center; }
        .main-nav #settings-box .btn-icon { background: none; border: none; color: var(--text-secondary); padding: 0.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius-sm); transition: color 0.3s ease, background-color 0.3s ease; }
        .main-nav #settings-box .btn-icon:hover { color: var(--text-primary); background-color: rgba(255, 255, 255, 0.05); }
        .main-nav #settings-box .btn-icon svg { width: 20px; height: 20px; fill: currentColor; }
        /* Style for the new PNG settings icon */
        .main-nav #settings-box .btn-icon .settings-icon-png {
            width: 20px;
            height: 20px;
            display: block; /* Or inline-block, depending on desired layout within flex */
        }


        /* Hamburger Menu Button */
        #hamburger-menu {
            display: none; /* Hidden by default */
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.5rem;
            z-index: 1001;
        }
        #hamburger-menu svg {
            width: 28px; /* Adjust size as needed */
            height: 28px;
            fill: currentColor;
        }


        /* --- General Content & Pages --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 0 1.5rem; }
        .page { display: none; animation: sectionFadeIn 0.8s ease-out forwards; width: 100%; flex-grow: 1; position: relative; }
        .page.active { display: flex; flex-direction: column; }
        @keyframes sectionFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Home Page --- */
        #home-page {
            text-align: center;
            padding-top: 10rem; /* Adjusted for more space */
            align-items: center;
            position: relative;
        }
        .hero-section {
            padding: 4rem 1rem;
            border-radius: var(--border-radius-md);
            background: rgba(44, 44, 48, 0.65);
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 1100px;
            z-index: 1;
        }
        .hero-section::before { content: ''; position: absolute; inset: 0; z-index: 0; opacity: 0.6; background: radial-gradient(circle at top left, rgba(106, 142, 231, 0.08), transparent 60%), radial-gradient(circle at bottom right, rgba(228, 118, 228, 0.08), transparent 60%); animation: pulseGlow 10s infinite alternate ease-in-out; }
        @keyframes pulseGlow { from { opacity: 0.4; transform: scale(1); } to { opacity: 0.8; transform: scale(1.03); } }
        .hero-content { position: relative; z-index: 1; }
        .hero-section h1 { font-size: clamp(2rem, 5vw, 3.2rem); font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary); line-height: 1.3; animation: textFadeUp 1s 0.2s ease-out forwards; opacity: 0; }
        @keyframes textFadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hero-section .tagline { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 2.5rem; max-width: 650px; margin-left: auto; margin-right: auto; animation: textFadeUp 1s 0.4s ease-out forwards; opacity: 0; }
        .hero-section .btn { animation: buttonScaleIn 0.8s 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.8); }
        @keyframes buttonScaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        /* --- About Section (Now on Home Page) --- */
        #home-about-section {
            max-width: 850px;
            margin: 12rem auto 4rem auto;
            padding: 2.5rem;
            background-color: var(--bg-card);
            border-radius: var(--border-radius-md);
            box-shadow: var(--box-shadow-soft);
            width: 100%;
            text-align: left;
            position: relative;
            z-index: 1;
        }
        #home-about-section h2 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--accent-primary);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.8rem;
        }
        #home-about-section p {
            font-size: 1.05rem;
            color: var(--text-secondary);
            text-align: justify;
            line-height: 1.8;
        }


        /* --- START: Generate Page Redesign --- */
        #feature-page.active { display: flex; flex-direction: row; align-items: stretch; padding: 0; height: calc(100vh - var(--nav-height)); overflow: hidden; }
        .input-sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: var(--bg-card); padding: 1.5rem 1.2rem; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto; height: 100%; }
        .form-container { padding: 0; background-color: transparent; box-shadow: none; max-width: 100%; margin: 0; display: flex; flex-direction: column; flex-grow: 1; }
        .input-sidebar h1 { font-size: 1.6rem; font-weight: 600; text-align: left; margin-bottom: 1.3rem; padding-bottom: 0.6rem; border-bottom: 1px solid var(--border-color); background: var(--accent-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; flex-shrink: 0; }
        .input-sidebar #feature-form { flex-grow: 1; display: flex; flex-direction: column; }
        .form-group { margin-bottom: 1.1rem; flex-shrink: 0; }
        .form-group label { display: block; margin-bottom: 0.6rem; font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
        .form-group input[type="text"], .form-group textarea, .form-group select { width: 100%; padding: 0.8rem 0.9rem; font-size: 0.95rem; background-color: var(--input-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); color: var(--text-primary); font-family: inherit; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .form-group input[type="text"]:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(106, 142, 231, 0.2); }
        .form-group textarea#lyrics-input { min-height: 110px; resize: vertical; }
        .form-group textarea#transcript-output { min-height: 70px; font-size: 0.9rem; background-color: #333; cursor: default; }
        .form-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="%23a9a9b3" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 20px; padding-right: 3rem; cursor: pointer; }
        .form-group select option[disabled] { color: #777; }
        #generate-lyrics-button { margin-top: 0.6rem; padding: 0.7rem 1.3rem; font-size: 0.9rem; width: auto; display: inline-block; }
        .audio-input-group { display: flex; flex-wrap: wrap; align-items: center; gap: 0.8rem; margin-top: 0.2rem; }
        #record-audio-button { padding: 0.7rem 1.3rem; font-size: 0.9rem; flex-shrink: 0; }
        #record-status { font-size: 0.9rem; flex-basis: 100%; text-align: left; margin-top: 0.2rem; min-height: 20px; }
        .form-group small { font-size: 0.85em; display: block; margin-top: 0.5rem; }
        #generate-concept-button { width: 100%; max-width: none; margin-top: auto; padding: 0.9rem 1.5rem; font-size: 1rem; flex-shrink: 0; }
        .output-area { flex-grow: 1; background-color: var(--bg-output-area); padding: 2.5rem; overflow-y: auto; height: 100%; position: relative; display: flex; flex-direction: column; }
        #initial-prompt { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; color: var(--text-secondary); }
        #initial-prompt .prompt-icon { font-size: 4rem; margin-bottom: 1.5rem; opacity: 0.5; display: block; width: 60px; height: 60px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23a9a9b3" opacity="0.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>'); background-repeat: no-repeat; background-position: center; background-size: contain; }
        #initial-prompt p { font-size: 1.1rem; max-width: 450px; }
        #concept-display-area { display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; background-color: var(--bg-card); border-radius: var(--border-radius-md); box-shadow: var(--box-shadow-soft); margin: auto; max-width: 700px; width: 90%; animation: fadeInScaleUp 0.5s ease-out forwards; }
        @keyframes fadeInScaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        #concept-display-area h2 { font-size: 1.5rem; font-weight: 600; color: var(--accent-primary); margin-bottom: 1.5rem; width: 100%; text-align: center; }
        #concept-text-output { font-size: 1rem; color: var(--text-secondary); line-height: 1.7; margin-bottom: 2.5rem; white-space: pre-wrap; max-height: 50vh; overflow-y: auto; width: 100%; text-align: left; padding: 1rem; background-color: rgba(0,0,0,0.1); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); }
        .concept-actions { display: flex; gap: 1.5rem; justify-content: center; width: 100%; }
        .concept-actions .btn { padding: 0.8rem 1.8rem; font-size: 1rem; }
        #tabbed-results-area { display: none; flex-direction: column; height: 100%; width: 100%; animation: fadeIn 0.6s ease-out forwards; }
         @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .results-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); flex-shrink: 0; }
        .results-tabs button { padding: 0.7rem 1.3rem; font-size: 0.95rem; font-weight: 500; color: var(--text-secondary); background-color: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; transition: color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease; border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0; white-space: nowrap; display: inline-flex; align-items: center; }
        .results-tabs button:hover { color: var(--text-primary); background-color: rgba(255, 255, 255, 0.05); }
        .results-tabs button.active { color: var(--text-primary); font-weight: 600; border-bottom: 3px solid; border-image-slice: 1; border-image-source: var(--accent-gradient); }
        .results-tabs.selection-mode-active button { cursor: copy; }
        .results-tabs.selection-mode-active button:not(.selected-for-download):hover {
            background-color: rgba(106, 142, 231, 0.1);
        }
        .results-tabs button.selected-for-download {
            background-color: rgba(106, 142, 231, 0.2);
            color: var(--text-primary);
            box-shadow: 0 0 12px rgba(106, 142, 231, 0.4), inset 0 0 0 2px var(--accent-primary);
            transform: translateY(-2px);
        }
        .results-tabs button.selected-for-download::after { display: none; }

        .results-tabs .tab-link .tab-icon {
            height: 1em;
            width: auto;
            margin-right: 0.4em;
            vertical-align: middle;
            filter: contrast(0.8) brightness(1.1);
        }
        .results-tabs button.active .tab-icon,
        .results-tabs button:hover .tab-icon {
            filter: none;
        }


        .tab-content-area { flex-grow: 1; overflow-y: auto; padding: 0.5rem; position: relative; }
        .tab-content { display: none; animation: sectionFadeIn 0.6s ease-out forwards; background-color: var(--bg-card); border-radius: var(--border-radius-md); padding: 1.8rem; box-shadow: var(--box-shadow-soft); border: 1px solid var(--border-color); margin-bottom: 1rem; }
        .tab-content.active { display: block; }
        .pro-badge-tab { display: inline-block; background-color: var(--accent-secondary); color: var(--text-primary); font-size: 0.65rem; font-weight: 600; padding: 0.1rem 0.5rem; border-radius: 8px; margin-left: 0.5rem; vertical-align: middle; text-transform: uppercase; line-height: 1; }
        .tab-content h2 { font-size: 1.5rem; font-weight: 600; color: var(--accent-primary); margin-bottom: 1.2rem; padding-bottom: 0.6rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 0.5rem; }
        .tab-content p, .tab-content ul, .tab-content div:not(.budget-columns-container):not(.image-placeholder-container):not(.color-palette-display):not(.font-suggestion):not(.cohesion-explanation) { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.7; }
        .tab-content p:not(:last-child), .tab-content ul:not(:last-child), .tab-content > div:not(.budget-columns-container):not(.image-placeholder-container):not(.color-palette-display):not(.font-suggestion):not(.cohesion-explanation):not(:last-child) { margin-bottom: 1rem; }
        .tab-content strong { color: var(--text-primary); font-weight: 600; }
        .tab-content .cohesion-explanation {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: rgba(0,0,0,0.1);
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--accent-primary);
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        .tab-content .cohesion-explanation strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        #tab-content-requirements ul { margin: 0.5rem 0 0 0; padding-left: 0; list-style: none; }
        #tab-content-requirements li:not(.placeholder-notice) { margin-bottom: 0.8rem; padding-left: 1.8rem; position: relative; }
        #tab-content-requirements li:not(.placeholder-notice)::before { content: '✓'; color: var(--accent-primary); font-size: 1.1em; font-weight: 600; position: absolute; left: 0; top: 1px; transition: transform 0.3s ease; }
        #tab-content-requirements li:not(.placeholder-notice):hover::before { transform: scale(1.2) rotate(-10deg); }
        #tab-content-budget .budget-columns-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.2rem; margin-top: 1rem; }
        #tab-content-budget .budget-column { border: 1px solid var(--border-color); padding: 1.2rem; border-radius: var(--border-radius-sm); background-color: rgba(26, 26, 29, 0.7); display: flex; flex-direction: column; transition: background-color 0.3s ease; min-height: 180px; }
        #tab-content-budget .budget-column:hover { background-color: rgba(40, 40, 43, 0.8); }
        #tab-content-budget .budget-column h3 { margin-top: 0; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #555; color: var(--text-primary); font-size: 1.1rem; font-weight: 600; flex-shrink: 0; text-align: center; }
        #tab-content-budget .budget-column p { font-size: 0.95rem; line-height: 1.7; color: var(--text-secondary); white-space: normal; margin-bottom: 0; flex-grow: 1; }
        #tab-content-budget .budget-column .budget-item-box { border: 1px solid #555; background-color: var(--bg-dark); padding: 0.6rem 0.8rem; margin-top: 0.8rem; margin-bottom: 0.6rem; border-radius: 4px; font-size: 0.85em; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        #tab-content-budget .budget-column .budget-item-box strong { color: var(--text-primary); margin-left: 0.5rem; white-space: nowrap; font-weight: 600; }
        #tab-content-budget .budget-column.placeholder-notice { border-style: dashed; opacity: 0.7; }
        #tab-content-budget .budget-column.placeholder-notice h3 { color: var(--text-secondary); border-bottom-color: rgba(85, 85, 85, 0.5); }
        #tab-content-budget .budget-column.placeholder-notice p.placeholder-notice { text-align: center; font-style: italic; color: var(--text-secondary); margin-top: 1rem; font-size: 0.95rem; line-height: 1.7; }
        #tab-content-budget .budget-columns-container.placeholder-notice { display: block; text-align: center; padding: 1rem; }
        #tab-content-budget .budget-columns-container.placeholder-notice .budget-column { display: none; }
        #tab-content-budget .raw-budget-output pre { white-space: pre-wrap; font-family: monospace; font-size: 1.2em; text-align: left; background-color: rgba(0,0,0,0.3); border: 1px dashed var(--border-color); color: var(--text-secondary); padding: 1rem; border-radius: var(--border-radius-sm); margin-top: 0.5rem; max-height: 250px; overflow-y: auto; }
        #tab-content-budget > small { display: block; text-align: center; margin-top: 1.5rem; font-size: 0.85em; opacity: 0.8; }
        #tab-content-visuals .image-placeholder-container, #tab-content-moodboard .image-placeholder-container { display: grid; gap: 1.2rem; margin-top: 1rem; }
        #tab-content-visuals .image-placeholder-container { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        #tab-content-moodboard .image-placeholder-container { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
        #tab-content-visuals .image-placeholder, #tab-content-moodboard .image-placeholder { border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background-color: var(--bg-dark); overflow: hidden; text-align: center; color: var(--text-secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; }
        #tab-content-visuals .image-placeholder:hover, #tab-content-moodboard .image-placeholder:hover { transform: scale(1.03); box-shadow: 0 5px 12px rgba(0,0,0,0.3); z-index: 5; }
        #tab-content-visuals .image-placeholder img, #tab-content-moodboard .image-placeholder img { display: block; width: 100%; object-fit: cover; background-color: #444; border-bottom: 1px solid var(--border-color); opacity: 0; transition: opacity 0.5s ease-in-out; }
        #tab-content-visuals .image-placeholder img[src]:not([src=""]), #tab-content-moodboard .image-placeholder img[src]:not([src=""]) { opacity: 1; }
        #tab-content-visuals .image-placeholder img { height: 160px; }
        #tab-content-moodboard .image-placeholder img { height: 130px; }
        #tab-content-visuals .image-placeholder figcaption, #tab-content-moodboard .image-placeholder figcaption { font-size: 0.85em; padding: 0.8rem; background-color: var(--bg-card); min-height: 55px; line-height: 1.4; color: var(--text-secondary); }
        #tab-content-visuals .image-placeholder figcaption strong, #tab-content-moodboard .image-placeholder figcaption strong { color: var(--text-primary); }
        #tab-content-visuals .image-placeholder figcaption .generation-source, #tab-content-moodboard .image-placeholder figcaption .generation-source, #tab-content-visuals .image-placeholder figcaption .fallback-notice, #tab-content-moodboard .image-placeholder figcaption .fallback-notice { font-size: 0.8em; display: block; margin-top: 5px; font-style: italic; }
        #tab-content-visuals .image-placeholder figcaption .generation-source, #tab-content-moodboard .image-placeholder figcaption .generation-source { color: var(--accent-primary); }
        #tab-content-visuals .image-placeholder figcaption .fallback-notice, #tab-content-moodboard .image-placeholder figcaption .fallback-notice { color: #888; }
         #tab-content-visuals > small, #tab-content-moodboard > small { display: block; margin-top: 1.5rem; font-size: 0.85em; opacity: 0.8; }
        #tab-content-palette .color-palette-display { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; align-items: stretch; }
        #tab-content-palette .color-swatch { min-width: 120px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; font-size: 0.85em; font-weight: 500; text-align: center; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.15); transition: transform 0.25s ease, box-shadow 0.25s ease; flex-grow: 1; opacity: 0; transform: scale(0.8); padding: 0; }
        #tab-content-palette .color-swatch.visible { opacity: 1; transform: scale(1); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
        #tab-content-palette .color-swatch:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.25); z-index: 5; }
        #tab-content-palette .color-swatch .color-block { width: 100%; height: 70px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid rgba(0,0,0,0.1); }
        #tab-content-palette .color-swatch .hex-code { margin-top: 0; font-size: 0.9em; font-family: monospace; user-select: all; opacity: 0.8; padding: 0.3rem; }
        #tab-content-palette .color-swatch .color-info { padding: 0.8rem; width: 100%; flex-grow: 1; display: flex; flex-direction: column; background-color: rgba(0,0,0,0.1); }
        #tab-content-palette .color-swatch .color-name { font-weight: 600; display: block; margin-bottom: 0.4rem; word-break: break-word; }
        #tab-content-palette .color-swatch .color-application { font-size: 0.9em; line-height: 1.4; color: var(--text-secondary); word-break: break-word; text-align: left; }
        #tab-content-palette .color-swatch.dominant-swatch { border: 2px solid var(--accent-primary); box-shadow: 0 2px 8px rgba(106, 142, 231, 0.2); }
        #tab-content-fonts .font-suggestion { margin-bottom: 1.8rem; padding-bottom: 1.5rem; border-bottom: 1px dashed var(--border-color); }
        #tab-content-fonts .font-suggestion:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        #tab-content-fonts h3 { font-size: 1.2rem; color: var(--text-primary); margin-bottom: 0.6rem; font-weight: 600; }
        #tab-content-fonts .font-reason { font-style: italic; margin-bottom: 1rem; font-size: 0.95em; }
        #tab-content-fonts .font-sample { background-color: rgba(0,0,0,0.15); padding: 0.8rem 1rem; border-radius: var(--border-radius-sm); margin-bottom: 0.8rem; border-left: 3px solid var(--accent-secondary); font-size: 1.1em; }
        #tab-content-fonts .font-sample strong { color: var(--accent-primary); font-weight: 600; margin-right: 0.5rem; }

        /* --- END: Generate Page Redesign --- */

        /* --- START: Pricing Page Styles --- */
        #pricing-page { padding: 3rem 0; align-items: center; }
        #pricing-page .container { display: flex; flex-direction: column; align-items: center; }
        #pricing-page h2 { font-size: 2.2rem; font-weight: 600; margin-bottom: 2.5rem; color: var(--text-primary); text-align: center; background: var(--accent-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .pricing-table { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; width: 100%; max-width: 950px; align-items: stretch; }
        .pricing-column { background-color: var(--bg-card); border-radius: var(--border-radius-lg); padding: 2rem 1.5rem; display: flex; flex-direction: column; align-items: center; text-align: center; border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; cursor: pointer; position: relative; overflow: hidden; }
        .pricing-column:hover { border-color: var(--accent-secondary); box-shadow: 0 0 20px rgba(228, 118, 228, 0.3); transform: translateY(-5px); }
        .pricing-column-inner { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; background-color: var(--bg-card); border-radius: calc(var(--border-radius-lg) - var(--pricing-highlight-padding)); z-index: 1; position: relative; padding: 2rem 1.5rem; margin: calc(-1 * (2rem + var(--pricing-highlight-padding))) calc(-1 * (1.5rem + var(--pricing-highlight-padding))); }
        .pricing-column.highlighted { border: none; padding: var(--pricing-highlight-padding); background: var(--accent-gradient); transform: scale(1.03) translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.3), 0 0 20px rgba(166, 128, 235, 0.4); z-index: 2; }
        .pricing-column.highlighted .pricing-column-inner { background-color: var(--bg-card); }
        .pricing-tier { font-size: 1.8rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary); }
        .popular-badge { background-color: var(--accent-primary); color: var(--bg-dark); font-size: 0.75rem; font-weight: 700; padding: 0.2rem 0.8rem; border-radius: 10px; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; margin-bottom: 1.5rem; }
        .pricing-price { font-size: 2.5rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text-primary); }
        .coming-soon { font-size: 0.9rem; color: var(--text-secondary); font-style: italic; margin-top: -1rem; margin-bottom: 1.5rem; }
        .feature-list { list-style: none; padding: 0; margin: 0; width: 100%; text-align: left; margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; flex-grow: 1; }
        .feature-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); }
        .feature-list li:last-child { border-bottom: none; }
        .feature-name { font-size: 1rem; color: var(--text-secondary); }
        .feature-value { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .feature-value .icon-check svg { width: 20px; height: 20px; fill: var(--success-color); vertical-align: middle; }
        .feature-value.unavailable { color: var(--text-secondary); opacity: 0.6; }
        .pricing-column .btn { margin-top: auto; width: 100%; }
        /* --- END: Pricing Page Styles --- */

        /* --- START: Action Buttons & Download Options --- */
        .action-buttons {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
            position: relative;
        }
        #download-action-area {
            display: none;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            width: 100%;
            flex-wrap: wrap;
        }
        #image-format-selector-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            width: auto;
            min-width: 200px;
        }
        #image-format-selector-container > div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }
        #image-format-selector-container label {
            margin-bottom: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        #image-format-selector-container select {
            padding: 0.4rem 0.6rem;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            background-color: var(--input-bg-color);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            flex-grow: 1;
        }
        #download-action-area > .btn {
             padding: 0.8rem 1.5rem;
             font-size: 0.9rem;
             min-width: 160px;
             text-align: center;
             flex-shrink: 0;
        }
        #finalize-text-download-button.btn-warning {
             background: linear-gradient(135deg, #787880, #5a5a60);
        }
        #finalize-text-download-button.btn-warning:hover:not(:disabled) {
             box-shadow: 0 5px 15px rgba(100, 100, 100, 0.3);
        }

        /* --- END: Action Buttons & Download Options --- */


        /* --- General Button Styling --- */
        .btn { display: inline-block; padding: 0.8rem 1.8rem; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 1rem; font-weight: 600; text-align: center; text-decoration: none; color: var(--text-primary); background: var(--accent-gradient); transition: transform 0.2s ease, box-shadow 0.3s ease, background-size 0.4s ease, opacity 0.3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); position: relative; overflow: hidden; z-index: 1; user-select: none; }
        .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%); transition: left 0.5s ease; z-index: -1; }
        .btn:hover:not(:disabled) { transform: translateY(-2px) scale(1.02); box-shadow: 0 5px 15px rgba(106, 142, 231, 0.3); }
        .btn:hover:not(:disabled)::before { left: 100%; }
        .btn:active:not(:disabled) { transform: translateY(0) scale(0.98); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #555; box-shadow: none; }
        .btn-secondary { background: linear-gradient(135deg, #5a5a60, #404045); }
        .btn-secondary:hover:not(:disabled) { box-shadow: 0 5px 15px rgba(80, 80, 80, 0.3); }
        .btn-warning { background: linear-gradient(135deg, var(--warning-color), #d4a00e); color: #222; }
        .btn-warning:hover:not(:disabled) { box-shadow: 0 5px 15px rgba(255, 183, 3, 0.4); color: #000; }
        .btn-danger { background: linear-gradient(135deg, var(--error-color), #b82c3a); }
        .btn-danger:hover:not(:disabled) { box-shadow: 0 5px 15px rgba(230, 57, 70, 0.4); }
        .btn-success { background: linear-gradient(135deg, var(--success-color), #3a9a70); }
        .btn-success:hover:not(:disabled) { box-shadow: 0 5px 15px rgba(87, 204, 153, 0.4); }

        #feature-page .btn-back { display: none; }
        #pricing-page .btn-back { display: block; width: fit-content; margin: 2rem auto 0 auto; }


        /* --- Error Message --- */
        #error-message { background-color: rgba(230, 57, 70, 0.15); color: var(--error-color); border: 1px solid rgba(230, 57, 70, 0.5); padding: 1rem 1.3rem; border-radius: var(--border-radius-sm); margin: 1rem auto; text-align: center; font-weight: 500; display: none; max-width: 90%; width: fit-content; white-space: pre-wrap; font-size: 0.9rem; }
        .tab-content p.error { color: var(--error-color); font-weight: 500; }


        /* --- Footer --- */
        .main-footer { background-color: #111; color: var(--text-secondary); padding: 1.5rem 0; text-align: center; font-size: 0.9rem; margin-top: auto; position: relative; z-index: 1; flex-shrink: 0; }
        .main-footer p { margin: 0; }
        .main-footer a { color: var(--accent-primary); text-decoration: none; transition: color 0.3s ease; }
        .main-footer a:hover { color: var(--accent-secondary); }

        /* --- Utility Placeholders --- */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .placeholder-notice { font-style: italic; color: var(--text-secondary); opacity: 0.8; text-align: center; padding: 1rem; font-size: 0.9em; }
        #tab-content-requirements ul .placeholder-notice { padding: 0; text-align: left; list-style: none; margin-left: 1.8rem; }
        #tab-content-requirements ul .placeholder-notice::before { display: none; }
        #tab-content-budget .budget-columns-container.placeholder-notice,
        #tab-content-visuals .image-placeholder-container.placeholder-notice,
        #tab-content-moodboard .image-placeholder-container.placeholder-notice,
        #tab-content-palette .color-palette-display.placeholder-notice,
        #tab-content-fonts p.placeholder-notice { display: block; text-align: center; padding: 1rem; }
        #tab-content-video-demo .placeholder-notice,
        #tab-content-album-cover .placeholder-notice { display: flex; align-items: center; justify-content: center; height: 100%; }


        /* --- How to Use Button and Modal --- */
        #how-to-use-button { position: fixed; bottom: 20px; right: 20px; z-index: 1001; padding: 0.6rem 1.2rem; font-size: 0.9rem; border-radius: 50px; background: var(--accent-secondary); box-shadow: var(--box-shadow-soft); }
         #how-to-use-button:hover:not(:disabled) { box-shadow: 0 5px 15px rgba(228, 118, 228, 0.4); transform: translateY(-2px) scale(1.05); }
        #guide-modal { position: fixed; inset: 0; background-color: rgba(26, 26, 29, 0.8); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 1002; padding: 1rem; opacity: 0; transition: opacity 0.3s ease-in-out; }
         #guide-modal.show { display: flex; opacity: 1; }
        #guide-modal-content { background-color: var(--bg-card); padding: 2.5rem; border-radius: var(--border-radius-md); max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
         #guide-modal.show #guide-modal-content { transform: scale(1); }
        #guide-modal-content h3 { font-size: 1.8rem; font-weight: 600; color: var(--accent-primary); text-align: center; margin-bottom: 2rem; padding-bottom: 0.8rem; border-bottom: 1px solid var(--border-color); }
        #guide-modal-content h4 { font-size: 1.2rem; color: var(--text-primary); margin-top: 1.5rem; margin-bottom: 0.6rem; font-weight: 600; }
        #guide-modal-content p, #guide-modal-content li { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.7; margin-bottom: 0.5rem; }
        #guide-modal-content ul { padding-left: 20px; margin-top: 0.5rem; }
        #guide-modal-content strong { color: var(--text-primary); font-weight: 500; }
        #close-guide-modal { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; padding: 5px; line-height: 1; transition: color 0.2s ease, transform 0.2s ease; }
        #close-guide-modal:hover { color: var(--text-primary); transform: scale(1.1) rotate(90deg); }

        /* --- START: Settings Modal Styles --- */
        #settings-modal { position: fixed; inset: 0; background-color: rgba(26, 26, 29, 0.8); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 1003; padding: 1rem; opacity: 0; transition: opacity 0.3s ease-in-out; }
        #settings-modal.show { display: flex; opacity: 1; }
        #settings-modal-content { background-color: var(--bg-card); padding: 2rem; border-radius: var(--border-radius-md); max-width: 400px; width: 90%; position: relative; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4); border: 1px solid var(--border-color); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        #settings-modal.show #settings-modal-content { transform: scale(1); }
        #settings-modal-content > h3 {
            font-size: 1.5rem; font-weight: 600; color: var(--accent-primary); margin-bottom: 1.5rem;
            padding-bottom: 0.8rem; border-bottom: 1px solid var(--border-color);
        }
        #close-settings-modal { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8rem; color: var(--text-secondary); cursor: pointer; padding: 5px; line-height: 1; transition: color 0.2s ease, transform 0.2s ease; }
        #close-settings-modal:hover { color: var(--text-primary); transform: scale(1.1) rotate(90deg); }

        #settings-modal-content .settings-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }
        #settings-modal-content .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        #settings-modal-content .settings-section h4 {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-weight: 600;
            text-align: center;
        }
        #settings-modal-content #language-select {
            width: 100%;
            max-width: 280px;
            display: block;
            margin: 0 auto;
            padding: 0.6rem 0.8rem;
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color);
            background-color: var(--input-bg-color);
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23a9a9b3" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 20px;
            padding-right: 3rem;
        }
        #settings-modal-content #language-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(106, 142, 231, 0.2);
        }

        .music-controls { display: flex; align-items: center; justify-content: center; gap: 1.5rem; margin-top: 1rem; }
        .music-controls button#play-pause-music-button { background-color: var(--input-bg-color); border: 1px solid var(--border-color); color: var(--text-primary); padding: 0.8rem; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; transition: background-color 0.3s ease, transform 0.1s ease; }
        .music-controls button#play-pause-music-button:hover { background-color: var(--bg-card-hover); transform: scale(1.05); }
        .music-controls button#play-pause-music-button svg { width: 24px; height: 24px; fill: currentColor; }
        .music-controls input[type="range"] { flex-grow: 1; max-width: 200px; accent-color: var(--accent-primary); cursor: pointer; background: var(--input-bg-color); border-radius: var(--border-radius-sm); padding: 0.2rem 0; }
        .music-controls input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: var(--border-color); border-radius: var(--border-radius-sm); border: 1px solid var(--bg-dark); }
        .music-controls input[type="range"]::-webkit-slider-thumb { height: 18px; width: 18px; border-radius: 50%; background: var(--accent-primary); cursor: pointer; -webkit-appearance: none; margin-top: -6px; box-shadow: var(--box-shadow-glow); }
        .music-controls input[type="range"]::-moz-range-track { width: 100%; height: 8px; cursor: pointer; background: var(--border-color); border-radius: var(--border-radius-sm); border: 1px solid var(--bg-dark); }
        .music-controls input[type="range"]::-moz-range-thumb { height: 18px; width: 18px; border-radius: 50%; background: var(--accent-primary); cursor: pointer; border: none; box-shadow: var(--box-shadow-glow); }
        /* --- END: Settings Modal Styles --- */


        /* --- Responsive Adjustments --- */
        @media (max-width: 992px) {
            :root { --sidebar-width: var(--sidebar-width-md); }
            .container { max-width: 90%; }
            .main-nav ul { gap: 1rem; }
            .main-nav ul li a { font-size: 0.95rem; padding: 0.4rem 0.6rem; }
            #settings-box { gap: 0.4rem; }
            .main-nav #settings-box .btn-icon { padding: 0.3rem; }
            .input-sidebar { padding: 1.5rem 1rem; }
            .output-area { padding: 2rem; }
            #concept-display-area { padding: 1.5rem; }
            .results-tabs button { padding: 0.6rem 1rem; font-size: 0.9rem; }
            .tab-content { padding: 1.5rem; }
            #guide-modal-content { padding: 2rem; }
            #settings-modal-content { padding: 1.5rem; max-width: 360px; }
            #settings-modal-content > h3 { font-size: 1.3rem; }
            .music-controls { gap: 1rem; }
            .music-controls button#play-pause-music-button { width: 45px; height: 45px; }
            .music-controls button#play-pause-music-button svg { width: 20px; height: 20px; }
            #tab-content-budget .budget-columns-container { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .pricing-table { grid-template-columns: 1fr; gap: 1.5rem; }
            #pricing-page h2 { font-size: 2rem; margin-bottom: 2rem; }
            .pricing-column { padding: 1.5rem 1rem; }
            .pricing-column-inner { margin: calc(-1 * (1.5rem + var(--pricing-highlight-padding))) calc(-1 * (1rem + var(--pricing-highlight-padding))); padding: 1.5rem 1rem; }
            .pricing-price { font-size: 2.2rem; }
            #download-action-area { flex-wrap: wrap; justify-content: space-around; gap: 0.8rem;}
             #download-action-area > .btn { min-width: calc(33% - 1rem); font-size: 0.85rem; padding: 0.7rem 1.2rem;}
             #download-action-area > #image-format-selector-container { min-width: calc(33% - 1rem); }

        }

        @media (max-width: 768px) {
            html { font-size: 15px; }
            :root { --nav-height: auto; min-height: 60px; }
            main { padding-top: 60px; } /* Adjust if nav height changes significantly */
             #feature-page.active { flex-direction: column; height: auto; overflow-y: auto; overflow-x: hidden; }
             .input-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); height: auto; max-height: none; overflow-y: visible; padding-bottom: 1.5rem; }
             .output-area { height: auto; min-height: 50vh; padding: 1.5rem; overflow-y: visible; }
            #generate-concept-button { margin-top: 2rem; }
             .main-nav {
                padding: 0 1rem; /* Reduced padding for smaller screens */
                flex-wrap: wrap;
                height: auto;
                min-height: 60px; /* Ensure it has some base height */
                align-content: center;
                position: relative; /* For absolute positioning of mobile menu */
            }
            .main-nav .logo { order: 0; padding: 0.5rem 0; } /* Logo first */

            #hamburger-menu {
                display: flex; /* Show hamburger */
                align-items: center;
                justify-content: center;
                order: 1; /* Hamburger after logo */
                margin-left: auto; /* Push hamburger and subsequent items to the right */
            }
            .main-nav #settings-box { /* Settings icon after hamburger */
                order: 2;
                margin-left: 0.5rem; /* Space between hamburger and settings */
                padding-bottom: 0; /* Align with hamburger */
            }

            .main-nav ul {
                display: none; /* Hidden by default, JS toggles */
                order: 3; /* Nav items last, on their own "row" */
                flex-basis: 100%; /* Takes full width */
                position: absolute;
                top: 100%; /* Position below the nav bar (logo/hamburger/settings line) */
                left: 0;
                width: 100%;
                background-color: var(--bg-card);
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                padding: 0.5rem 0;
                border-top: 1px solid var(--border-color);
                z-index: 999; /* Below main-nav (1000) but above page content (1) */
                flex-direction: column;
                align-items: center;
                gap: 0.2rem; /* Reduced gap for mobile nav items */
                margin-top: 0; /* Remove previous margin */
            }
            .main-nav ul.mobile-nav-open {
                display: flex;
            }
            .main-nav ul li {
                width: 100%;
                text-align: center;
            }
            .main-nav ul li a {
                display: block;
                padding: 0.7rem 1rem; /* Slightly more touch-friendly padding */
                width: 100%;
            }
            .main-nav ul li a::after { /* Optional: remove underline for mobile nav */
                display: none;
            }


            .hero-section { padding: 3rem 0.5rem; }
            .hero-section h1 { font-size: clamp(1.8rem, 6vw, 2.5rem); }
            .hero-section .tagline { font-size: 1rem; }
            #home-about-section { padding: 1.5rem; margin-top: 8rem; }
            #how-to-use-button { bottom: 15px; right: 15px; padding: 0.5rem 1rem; font-size: 0.85rem; }
            #guide-modal-content { padding: 1.5rem; max-height: 80vh; }
            #guide-modal-content h3 { font-size: 1.5rem; }
            #close-guide-modal, #close-settings-modal { top: 10px; right: 15px; font-size: 1.6rem; }
            .new-loader-content { transform: scale(0.18); }
            #tab-content-budget .budget-columns-container { grid-template-columns: 1fr; gap: 1rem; }
            #tab-content-budget .budget-column { min-height: auto; }
            #tab-content-visuals .image-placeholder-container { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            #tab-content-moodboard .image-placeholder-container { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .audio-input-group { align-items: flex-start; }
            #record-status { flex-basis: auto; margin-top: 0; }

            #download-action-area {
                 flex-direction: column;
                 align-items: center;
                 gap: 1rem;
            }
            #download-action-area > .btn,
            #download-action-area > #image-format-selector-container {
                width: 100%;
                max-width: 380px;
            }

            #pricing-page h2 { font-size: 1.8rem; }
            .pricing-tier { font-size: 1.5rem; }
            .pricing-price { font-size: 2rem; }
            .feature-name, .feature-value { font-size: 0.95rem; }
            .feature-list li { padding: 0.6rem 0;}
            .popular-badge { font-size: 0.7rem; padding: 0.15rem 0.6rem; }

            .parallax-image { max-width: 120px !important; }
            #parallax-speaker { top: 15%; left: 5%; max-width: 100px !important; }
            #parallax-dj { top: 40%; left: 2%; max-width: 130px !important; }
            #parallax-cutscene { top: 10%; right: 3%; max-width: 90px !important;}
            #parallax-soundcard { top: 55%; right: 5%; max-width: 100px !important;}
            #parallax-headphones { top: 30%; right: 8%; max-width: 110px !important; }

        }

        @media (max-width: 480px) {
            html { font-size: 14px; }
             .main-nav { padding: 0 0.75rem; } /* Further reduced padding */
             /* Hamburger and settings icon might need slight size adjustment if too cramped */
             #hamburger-menu svg { width: 24px; height: 24px; }
             /* .main-nav #settings-box .btn-icon svg { width: 18px; height: 18px;} */ /* Replaced by PNG styling */
             .main-nav #settings-box .btn-icon .settings-icon-png {
                width: 18px;
                height: 18px;
             }
             .main-nav #settings-box { margin-left: 0.3rem; }


             .main-nav ul { gap: 0; /* Remove gap, padding on <a> handles spacing */ }
             .main-nav ul li a { padding: 0.6rem 1rem; font-size: 0.9rem; }

             #settings-box { width: auto; /* Already handled by order */ }
             .input-sidebar { padding: 1.5rem 1rem; }
             .output-area { padding: 1rem; }
             .input-sidebar h1 { font-size: 1.5rem; }
             .form-group { margin-bottom: 1.2rem; }
             .form-group input[type="text"], .form-group textarea, .form-group select { font-size: 0.9rem; }
             textarea#lyrics-input { min-height: 140px; }
             .audio-input-group { flex-direction: column; align-items: stretch; gap: 0.8rem; }
             .audio-input-group .btn { width: 100%; margin: 0;}
             #record-status { margin-left: 0; justify-content: center; width: 100%; margin-top: 0.3rem; }
             #generate-concept-button { padding: 0.8rem 1.2rem; font-size: 0.95rem; }
             #generate-lyrics-button { width: 100%; margin-top: 1rem; padding: 0.7rem 1.2rem; font-size: 0.9rem; }
             .btn { padding: 0.7rem 1.5rem; font-size: 0.95rem; }
            #concept-display-area { padding: 1rem; max-width: 95%; }
            #concept-display-area h2 { font-size: 1.3rem; }
            #concept-text-output { font-size: 0.9rem; }
            .concept-actions { flex-direction: column; gap: 0.8rem; }
            .concept-actions .btn { width: 100%; }
             .results-tabs { gap: 0.3rem; padding-bottom: 0.8rem; margin-bottom: 1rem; flex-wrap: nowrap; overflow-x: auto; /* Allow horizontal scroll for tabs */ }
             .results-tabs button { padding: 0.6rem 0.8rem; font-size: 0.85rem; flex-shrink: 0; /* Prevent tabs from shrinking */ }
             .tab-content-area { padding: 0; }
             .tab-content { padding: 1rem; }
            #tab-content-visuals .image-placeholder-container, #tab-content-moodboard .image-placeholder-container { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            #tab-content-visuals .image-placeholder img { height: 130px; }
            #tab-content-moodboard .image-placeholder img { height: 110px; }
            #tab-content-palette .color-palette-display { gap: 0.8rem; }
            #tab-content-palette .color-swatch { min-width: calc(50% - 0.4rem); }
            #tab-content-palette .color-swatch .color-block { height: 60px; }
            #tab-content-fonts .font-sample { font-size: 1em; }
             #how-to-use-button { bottom: 10px; right: 10px; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
             #guide-modal-content { padding: 1.5rem 1rem; }
             #settings-modal-content { padding: 1.5rem 1rem; max-width: 90%;}
             #settings-modal-content > h3 { font-size: 1.2rem; margin-bottom: 1rem;}
             .music-controls { flex-direction: column; gap: 0.8rem; }
             .music-controls input[type="range"] { max-width: 100%; width: 100%; }
             .new-loader-container { width: 80px; height: 80px; }
             .new-loader-content { transform: scale(0.15); }
             .pricing-column { border-radius: var(--border-radius-md); }
             .pricing-column-inner { border-radius: calc(var(--border-radius-md) - var(--pricing-highlight-padding)); }
             .feature-name, .feature-value { font-size: 0.9rem;}
             .feature-list li { padding: 0.6rem 0;}
             .popular-badge { font-size: 0.7rem; padding: 0.15rem 0.6rem; }
             #download-action-area { flex-direction: column; align-items: center; }
             #download-action-area > .btn, #download-action-area > #image-format-selector-container { max-width: 95%; font-size: 0.9rem; padding: 0.7rem 1rem; }

            .parallax-image { max-width: 90px !important; opacity: 0.7; }
             #parallax-speaker { top: 12%; left: 2%; max-width: 70px !important; }
            #parallax-dj { top: 35%; left: 1%; max-width: 100px !important; }
            #parallax-cutscene { top: 8%; right: 1%; max-width: 60px !important;}
            #parallax-soundcard { top: 50%; right: 2%; max-width: 70px !important;}
            #parallax-headphones { top: 25%; right: 4%; max-width: 80px !important; }
        }

    </style>
</head>
<body>
    <!-- Background Canvas for 3D Object -->
    <canvas id="bg-canvas"></canvas>

    <!-- Floating Image Container -->
    <div id="parallax-container">
        <img src="speakers.png" alt="Speakers" class="parallax-image" id="parallax-speaker">
        <img src="dj-desk-board.png" alt="DJ Desk" class="parallax-image" id="parallax-dj">
        <img src="cut-scene.png" alt="Cut Scene" class="parallax-image" id="parallax-cutscene">
        <img src="soundcard.png" alt="Soundcard" class="parallax-image" id="parallax-soundcard">
        <img src="headphones.png" alt="Headphones" class="parallax-image" id="parallax-headphones">
    </div>

    <!-- Audio Placeholders -->
    <audio id="hover-sound" src="/button-hover-sound.mp3" preload="auto"></audio>
    <audio id="click-sound" src="/button-click-sound.mp3" preload="auto"></audio>
    <!-- Background Music Player -->
    <audio id="background-music" src="/background-music.mp3" loop></audio>


    <!-- Loading Overlay Div -->
    <div id="loading-overlay">
        <div class="new-loader-container"> <div class="new-loader-content"> <div class="new-loader-circle"></div> <div class="new-loader-circle"></div> <div class="new-loader-circle"></div> <div class="new-loader-circle"></div> </div> </div>
        <p data-lang-en="Generating creative sparks..." data-lang-es="Generando chispas creativas..." data-lang-vi="Đang tạo ra những tia sáng sáng tạo..." data-lang-ja="創造的な火花を生成中..." data-lang-zhcn="正在生成创意火花..." data-last-key="generatingCreativeSparks">Generating creative sparks...</p>
    </div>

    <!-- Navigation -->
    <nav class="main-nav">
        <a href="#" data-page="home" class="logo nav-link">
             <img src="logofinal(white).png" alt="MV Generator Logo" style="max-height: 40px; width: auto; vertical-align: middle; border-radius: 3px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
             <span style="display: none;" data-lang-en="Logo" data-lang-es="Logo" data-lang-vi="Logo" data-lang-ja="ロゴ" data-lang-zhcn="标志">Logo</span>
        </a>
        <!-- Hamburger Menu Button (Added) -->
        <button id="hamburger-menu" aria-label="Toggle navigation" aria-expanded="false"
                data-lang-en-aria-label="Toggle navigation"
                data-lang-es-aria-label="Alternar navegación"
                data-lang-vi-aria-label="Chuyển đổi điều hướng"
                data-lang-ja-aria-label="ナビゲーションを開閉"
                data-lang-zhcn-aria-label="切换导航">
            <svg viewBox="0 0 100 80"> <!-- Simple hamburger icon -->
                <rect width="100" height="15" rx="8"></rect>
                <rect y="30" width="100" height="15" rx="8"></rect>
                <rect y="60" width="100" height="15" rx="8"></rect>
            </svg>
        </button>
        <ul id="main-nav-ul"> <!-- Added ID for easier JS targeting -->
            <li><a data-page="home" class="nav-link active" data-lang-en="Home" data-lang-es="Inicio" data-lang-vi="Trang chủ" data-lang-ja="ホーム" data-lang-zhcn="首页">Home</a></li>
            <li><a href="#home-about-section" data-scroll-to="home-about-section" class="nav-link" data-lang-en="About" data-lang-es="Acerca de" data-lang-vi="Giới thiệu" data-lang-ja="概要" data-lang-zhcn="关于">About</a></li>
            <li><a data-page="feature" class="nav-link" data-lang-en="Generate" data-lang-es="Generar" data-lang-vi="Tạo" data-lang-ja="生成" data-lang-zhcn="生成">Generate</a></li>
            <li><a data-page="pricing" class="nav-link" data-lang-en="Pricing" data-lang-es="Precios" data-lang-vi="Giá cả" data-lang-ja="価格" data-lang-zhcn="定价">Pricing</a></li>
            <li>
                <a href="https://forms.office.com/pages/responsepage.aspx?id=cTYy0b7NF0S01L2yS1Exa_LJCmAYC6hElQOVUA5GmmJUM0JPUUEzSU9RUEVZSUJRQVNDNVVQTUlTVS4u&route=shorturl"
                   target="_blank"
                   class="nav-link"
                   data-lang-en="Feedback"
                   data-lang-es="Comentarios"
                   data-lang-vi="Phản hồi"
                   data-lang-ja="フィードバック"
                   data-lang-zhcn="反馈">Feedback</a>
            </li>
        </ul>
        <div id="settings-box">
            <button id="settings-trigger-button" class="btn-icon"
                    data-lang-en-aria-label="Settings"
                    data-lang-es-aria-label="Ajustes"
                    data-lang-vi-aria-label="Cài đặt"
                    data-lang-ja-aria-label="設定"
                    data-lang-zhcn-aria-label="设置"
                    aria-label="Settings">
                <!-- Icon will be injected by JS -->
            </button>
        </div>
    </nav>

    <main>
        <!-- Home Page Section -->
        <section id="home-page" class="page active container">
             <div class="hero-section">
                 <div class="hero-content">
                     <h1 data-lang-en="Unlock Visual Concepts for Your Music" data-lang-es="Desbloquea Conceptos Visuales para Tu Música" data-lang-vi="Mở khóa ý tưởng hình ảnh cho âm nhạc của bạn" data-lang-ja="あなたの音楽のためのビジュアルコンセプトを解き放つ" data-lang-zhcn="为您的音乐解锁视觉概念">Unlock Visual Concepts for Your Music</h1>
                     <p class="tagline" data-lang-en="Transform your lyrics and ideas into stunning music video concepts with the power of AI." data-lang-es="Transforma tus letras e ideas en impresionantes conceptos de videos musicales con el poder de la IA." data-lang-vi="Biến lời bài hát và ý tưởng của bạn thành những ý tưởng video âm nhạc tuyệt đẹp với sức mạnh của AI." data-lang-ja="AIの力で、あなたの歌詞やアイデアを見事なミュージックビデオコンセプトに変えましょう。" data-lang-zhcn="借助人工智能的力量，将您的歌词和想法转化为令人惊叹的音乐视频概念。">Transform your lyrics and ideas into stunning music video concepts with the power of AI.</p>
                     <button id="explore-button" class="btn btn-primary" data-lang-en="Start Generating" data-lang-es="Comenzar a Generar" data-lang-vi="Bắt đầu tạo" data-lang-ja="生成を開始" data-lang-zhcn="开始生成">Start Generating</button>
                 </div>
             </div>
            <div id="home-about-section" class="content-container">
                 <h2 data-lang-en="About MV Generator" data-lang-es="Acerca del Generador MV" data-lang-vi="Về Trình tạo MV" data-lang-ja="MVジェネレーターについて" data-lang-zhcn="关于 MV 生成器">About MV Generator</h2>
                 <p data-lang-en="Welcome to the MV Generator! We are passionate about helping artists translate their musical creations into compelling visual stories. Crafting the perfect music video concept can be challenging, requiring a blend of artistic vision and practical planning. Our AI-powered tool is designed to bridge that gap. By analyzing your lyrics, keywords, genre, and potentially audio transcript, MV Generator generates tailored suggestions for music video concepts, requirements, budget estimations, visual inspirations, color palettes, and even font suggestions. We aim to streamline the creative process, providing a launchpad for your ideas and empowering you to bring your music to life visually, whether you're an indie artist or part of a larger production. Let's make something amazing together!" data-lang-es="¡Bienvenido al Generador de MV! Nos apasiona ayudar a los artistas a traducir sus creaciones musicales en historias visuales convincentes. Crear el concepto perfecto para un video musical puede ser desafiante, requiriendo una mezcla de visión artística y planificación práctica. Nuestra herramienta impulsada por IA está diseñada para cerrar esa brecha. Al analizar tus letras, palabras clave, género y potentially la transcripción de audio, el Generador de MV genera sugerencias personalizadas para conceptos de videos musicales, requisitos, estimaciones de presupuesto, inspiraciones visuales, paletas de colores e incluso sugerencias de fuentes. Nuestro objetivo es agilizar el proceso creativo, proporcionando una plataforma de lanzamiento para tus ideas y empoderándote para dar vida visual a tu música, ya seas un artista independiente o parte de una producción más grande. ¡Hagamos algo increíble juntos!" data-lang-vi="Chào mừng bạn đến với Trình tạo MV! Chúng tôi đam mê giúp các nghệ sĩ chuyển đổi những sáng tạo âm nhạc của họ thành những câu chuyện hình ảnh hấp dẫn. Việc tạo ra ý tưởng video âm nhạc hoàn hảo có thể đầy thử thách, đòi hỏi sự kết hợp giữa tầm nhìn nghệ thuật và kế hoạch thực tế. Công cụ hỗ trợ AI của chúng tôi được thiết kế để thu hẹp khoảng cách đó. Bằng cách phân tích lời bài hát, từ khóa, thể loại và có thể cả bản ghi âm thanh của bạn, Trình tạo MV tạo ra các đề xuất phù hợp cho các khái niệm video âm nhạc, yêu cầu, ước tính ngân sách, nguồn cảm hứng trực quan, bảng màu và thậm chí cả đề xuất phông chữ. Chúng tôi mong muốn hợp lý hóa quy trình sáng tạo, cung cấp bệ phóng cho ý tưởng của bạn và trao quyền cho bạn để đưa âm nhạc của mình vào cuộc sống một cách trực quan, cho dù bạn là một nghệ sĩ độc lập hay là một phần của một nhà sản xuất lớn hơn. Hãy cùng nhau tạo ra điều gì đó tuyệt vời!" data-lang-ja="MVジェネレーターへようこそ！私たちは、アーティストが音楽作品を魅力的なビジュアルストーリーに変換するお手伝いをすることに情熱を注いでいます。完璧なミュージックビデオのコンセプトを作り上げることは、芸術的なビジョンと実践的な計画の融合を必要とする、困難な作業となる場合があります。当社のAI搭載ツールは、そのギャップを埋めるために設計されています。あなたの歌詞、キーワード、ジャンル、そして場合によってはオーディオトランスクリプトを分析することにより、MVジェネレーターはミュージックビデオのコンセプト、要件、予算の見積もり、視覚的なインスピレーション、カラーパレット、さらにはフォントの提案に関するカスタマイズされた提案を生成します。私たちは、インディーズアーティストであろうと大規模なプロダクションの一部であろうと、あなたのアイデアの出発点を提供し、あなたの音楽を視覚的に実現する力を与えることで、創造的なプロセスを合理化することを目指しています。一緒に素晴らしいものを作りましょう！" data-lang-zhcn="欢迎来到 MV 生成器！我们热衷于帮助艺术家将他们的音乐创作转化为引人入胜的视觉故事。制作完美的音乐视频概念可能具有挑战性，需要艺术视野和实际规划的结合。我们的人工智能工具旨在弥合这一差距。通过分析您的歌词、关键词、流派以及可能的音频转录稿，MV 生成器会生成量身定制的音乐视频概念、要求、预算估算、视觉灵感、调色板建议，甚至字体建议。我们的目标是简化创作过程，为您的想法提供一个启动平台，并使您能够将音乐以视觉方式呈现出来，无论您是独立艺术家还是大型制作团队的一员。让我们一起创造一些惊人的东西吧！">
                     Welcome to the MV Generator! We are passionate about helping artists translate their musical creations into compelling visual stories. Crafting the perfect music video concept can be challenging, requiring a blend of artistic vision and practical planning. Our AI-powered tool is designed to bridge that gap. By analyzing your lyrics, keywords, genre, and potentially audio transcript, MV Generator generates tailored suggestions for music video concepts, requirements, budget estimations, visual inspirations, color palettes, and even font suggestions. We aim to streamline the creative process, providing a launchpad for your ideas and empowering you to bring your music to life visually, whether you're an indie artist or part of a larger production. Let's make something amazing together!
                 </p>
            </div>
         </section>

        <!-- Feature Page Section -->
        <section id="feature-page" class="page">
            <aside class="input-sidebar">
                <div class="form-container">
                    <h1 data-lang-en="Input Details" data-lang-es="Ingresar Detalles" data-lang-vi="Nhập chi tiết" data-lang-ja="詳細入力" data-lang-zhcn="输入详情">Input Details</h1>
                    <form id="feature-form" onsubmit="return false;">
                        <div class="form-group"> <label for="lyrics-input" data-lang-en="Music Lyrics:" data-lang-es="Letra:" data-lang-vi="Lời:" data-lang-ja="歌詞：" data-lang-zhcn="歌词：">Music Lyrics:</label> <textarea id="lyrics-input" rows="8" required data-lang-en-placeholder="Paste/generate..." data-lang-es-placeholder="Pega/genera..." data-lang-vi-placeholder="Dán/tạo..." data-lang-ja-placeholder="貼付/生成..." data-lang-zhcn-placeholder="粘贴/生成..." placeholder="Paste/generate..."></textarea> <button type="button" id="generate-lyrics-button" class="btn btn-secondary" data-lang-en="Gen. Random Lyric" data-lang-es="Generar Letra Aleat." data-lang-vi="Tạo Lời Ngẫu nhiên" data-lang-ja="ランダム歌詞生成" data-lang-zhcn="生成随机歌词">Gen. Random Lyric</button> </div>
                        <div class="form-group"> <label for="keywords-input" data-lang-en="Keywords/Theme:" data-lang-es="Palabras Clave/Tema:" data-lang-vi="Từ khóa/Chủ đề:" data-lang-ja="キーワード/テーマ：" data-lang-zhcn="关键词/主题：">Keywords/Theme:</label> <input type="text" id="keywords-input" required data-lang-en-placeholder="e.g., nostalgic, summer" data-lang-es-placeholder="ej., nostálgico, verano" data-lang-vi-placeholder="vd: hoài cổ, hè" data-lang-ja-placeholder="例：ノスタルジック、夏" data-lang-zhcn-placeholder="例：怀旧、夏日" placeholder="e.g., nostalgic, summer"> </div>
                        <div class="form-group"> <label for="genre-select" data-lang-en="Music Genre:" data-lang-es="Género Musical:" data-lang-vi="Thể loại nhạc:" data-lang-ja="音楽ジャンル：" data-lang-zhcn="音乐流派：">Music Genre:</label> <select id="genre-select" required> <option value="" disabled selected data-lang-en="-- Select Genre --" data-lang-es="-- Selec. Género --" data-lang-vi="-- Chọn Thể loại --" data-lang-ja="-- ジャンル選択 --" data-lang-zhcn="-- 选择流派 --">-- Select Genre --</option> <option value="RnB">RnB/Soul</option><option value="Folk">Folk/Acoustic</option><option value="Rock">Rock</option><option value="Pop">Pop</option><option value="Hiphop">Hip-hop/Rap</option><option value="Electronic">Electronic</option><option value="Classical">Classical</option><option value="Country">Country</option><option value="Jazz">Jazz/Blues</option><option value="Reggae">Reggae</option><option value="Metal">Metal</option><option value="Other">Other/Fusion</option> </select> </div>
                        <div class="form-group"> <label for="record-audio-button" data-lang-en="Record Audio (Optional):" data-lang-es="Grabar Audio (Opc.):" data-lang-vi="Ghi âm (Tùy chọn):" data-lang-ja="録音（任意）：" data-lang-zhcn="录音（可选）：">Record Audio (Optional):</label> <div class="audio-input-group">  <button type="button" id="record-audio-button" class="btn btn-warning" data-lang-en-record="Record" data-lang-es-record="Grabar" data-lang-vi-record="Ghi âm" data-lang-ja-record="録音" data-lang-zhcn-record="录制" data-lang-en-stop="Stop" data-lang-es-stop="Detener" data-lang-vi-stop="Dừng" data-lang-ja-stop="停止" data-lang-zhcn-stop="停止">Record</button> <span id="record-status"><span id="recording-animation" style="display:none;"><span></span><span></span><span></span></span><span id="record-status-text"></span></span> </div> <small data-lang-en="Record for enhanced suggestions." data-lang-es="Graba para mejores sugerencias." data-lang-vi="Ghi âm để cải thiện đề xuất." data-lang-ja="録音で提案強化。" data-lang-zhcn="录制增强建议。">Record for enhanced suggestions.</small> </div>
                        <div class="form-group" id="transcript-group" style="display: none;"> <label for="transcript-output" data-lang-en="Transcript:" data-lang-es="Transcripción:" data-lang-vi="Bản ghi:" data-lang-ja="文字起こし：" data-lang-zhcn="转录稿：">Transcript:</label> <textarea id="transcript-output" rows="3" readonly data-lang-en-placeholder="Transcript appears here..." data-lang-es-placeholder="Transcripción aquí..." data-lang-vi-placeholder="Bản ghi ở đây..." data-lang-ja-placeholder="文字起こし表示..." data-lang-zhcn-placeholder="转录稿显示在此..." placeholder="Transcript appears here..."></textarea> <small data-lang-en="Analyzed with lyrics." data-lang-es="Analizado con letra." data-lang-vi="Phân tích cùng lời." data-lang-ja="歌詞と共に分析。" data-lang-zhcn="与歌词同分析。">Analyzed with lyrics.</small> </div>
                        <button type="button" id="generate-concept-button" class="btn btn-primary" data-lang-en="Generate Concept" data-lang-es="Generar Concepto" data-lang-vi="Tạo Ý tưởng" data-lang-ja="コンセプト生成" data-lang-zhcn="生成概念">Generate Concept</button>
                    </form>
                </div>
            </aside>
            <section class="output-area">
                 <div id="error-message" class="error-message" data-lang-en="Error. Check input/try again." data-lang-es="Error. Revisa/intenta de nuevo." data-lang-vi="Lỗi. Kiểm tra/thử lại." data-lang-ja="エラー。入力確認/再試行。" data-lang-zhcn="错误。检查输入/重试。" data-error-key="errorUnknown"></div>
                <div id="initial-prompt"> <div class="prompt-icon"></div> <p data-lang-en="Enter details & click 'Generate Concept'." data-lang-es="Ingresa detalles, clic 'Generar Concepto'." data-lang-vi="Nhập chi tiết & nhấn 'Tạo Ý tưởng'." data-lang-ja="詳細入力、「コンセプト生成」クリック。" data-lang-zhcn="输入详情，点“生成概念”。">Enter details & click 'Generate Concept'.</p> </div>
                <div id="concept-display-area"> <h2 data-lang-en="Generated Concept" data-lang-es="Concepto Generado" data-lang-vi="Ý tưởng" data-lang-ja="生成コンセプト" data-lang-zhcn="生成概念">Generated Concept</h2> <div id="concept-text-output" class="placeholder-notice" data-placeholder-key="conceptPlaceholder"> Concept text... </div> <div class="concept-actions"> <button id="pick-concept-button" class="btn btn-primary" data-lang-en="Pick Concept" data-lang-es="Elegir" data-lang-vi="Chọn" data-lang-ja="選択" data-lang-zhcn="选此" disabled>Pick</button> <button id="regenerate-concept-button-alt" class="btn btn-secondary" data-lang-en="Generate New" data-lang-es="Nuevo" data-lang-vi="Tạo Mới" data-lang-ja="新規" data-lang-zhcn="新生成" disabled>New</button> </div> </div>
                <div id="tabbed-results-area">
                    <nav class="results-tabs">
                        <button class="tab-link active" data-tab-target="tab-content-concept">
                             <img src="concept.png" alt="" class="tab-icon">
                             <span data-lang-en="Concept" data-lang-es="Concepto" data-lang-vi="Ý tưởng" data-lang-ja="コンセプト" data-lang-zhcn="概念">Concept</span>
                         </button>
                         <button class="tab-link" data-tab-target="tab-content-requirements">
                             <img src="requirements.png" alt="" class="tab-icon">
                             <span data-lang-en="Requirements" data-lang-es="Requisitos" data-lang-vi="Yêu cầu" data-lang-ja="要件" data-lang-zhcn="要求">Requirements</span>
                         </button>
                         <button class="tab-link" data-tab-target="tab-content-budget">
                             <img src="budget.png" alt="" class="tab-icon">
                             <span data-lang-en="Budget" data-lang-es="Presupuesto" data-lang-vi="Ngân sách" data-lang-ja="予算" data-lang-zhcn="预算">Budget</span>
                         </button>
                         <button class="tab-link" data-tab-target="tab-content-visuals">
                             <img src="key-images.png" alt="" class="tab-icon">
                             <span data-lang-en="Key Images" data-lang-es="Imágenes Clave" data-lang-vi="Ảnh chính" data-lang-ja="キーイメージ" data-lang-zhcn="关键图像">Key Images</span>
                         </button>
                         <button class="tab-link" data-tab-target="tab-content-moodboard">
                             <img src="moodboard.png" alt="" class="tab-icon">
                             <span data-lang-en="Moodboard" data-lang-es="Moodboard" data-lang-vi="Moodboard" data-lang-ja="ムードボード" data-lang-zhcn="情绪板">Moodboard</span>
                         </button>
                         <button class="tab-link" data-tab-target="tab-content-fonts">
                             <img src="typography.png" alt="" class="tab-icon">
                             <span data-lang-en="Typography" data-lang-es="Tipografía" data-lang-vi="Kiểu chữ" data-lang-ja="タイポグラフィ" data-lang-zhcn="排版">Typography</span>
                         </button>
                         <button class="tab-link" data-tab-target="tab-content-palette">
                             <img src="color-palette.png" alt="" class="tab-icon">
                             <span data-lang-en="Color Palette" data-lang-es="Paleta Color" data-lang-vi="Bảng màu" data-lang-ja="カラーパレット" data-lang-zhcn="调色板">Color Palette</span>
                         </button>
                         <button class="tab-link" data-tab-target="tab-content-video-demo">
                             <img src="video-demo.png" alt="" class="tab-icon">
                             <span data-lang-en="Video demo" data-lang-es="Demo de Video" data-lang-vi="Demo Video" data-lang-ja="ビデオデモ" data-lang-zhcn="视频演示">Video demo</span> <span class="pro-badge-tab" data-lang-en="Pro" data-lang-es="Pro" data-lang-vi="Pro" data-lang-ja="プロ" data-lang-zhcn="专业">Pro</span>
                         </button>
                         <button class="tab-link" data-tab-target="tab-content-album-cover">
                             <img src="album-cover.png" alt="" class="tab-icon">
                             <span data-lang-en="Album cover" data-lang-es="Portada Álbum" data-lang-vi="Bìa Album" data-lang-ja="アルバムカバー" data-lang-zhcn="专辑封面">Album cover</span> <span class="pro-badge-tab" data-lang-en="Pro" data-lang-es="Pro" data-lang-vi="Pro" data-lang-ja="プロ" data-lang-zhcn="专业">Pro</span>
                         </button>
                    </nav>
                    <div class="tab-content-area">
                        <div id="tab-content-concept" class="tab-content active"></div> <div id="tab-content-requirements" class="tab-content"></div> <div id="tab-content-budget" class="tab-content"></div> <div id="tab-content-visuals" class="tab-content"></div> <div id="tab-content-moodboard" class="tab-content"></div> <div id="tab-content-fonts" class="tab-content"></div> <div id="tab-content-palette" class="tab-content"></div>
                        <div id="tab-content-video-demo" class="tab-content"><p class="placeholder-notice" data-lang-en="Coming soon..." data-lang-es="Próximamente..." data-lang-vi="Sắp ra mắt..." data-lang-ja="近日公開..." data-lang-zhcn="即将推出...">Coming soon...</p></div>
                        <div id="tab-content-album-cover" class="tab-content"><p class="placeholder-notice" data-lang-en="Coming soon..." data-lang-es="Próximamente..." data-lang-vi="Sắp ra mắt..." data-lang-ja="近日公開..." data-lang-zhcn="即将推出...">Coming soon...</p></div>
                    </div>
                    <div class="action-buttons">
                        <div id="download-action-area" style="display: none;">
                            <button id="prepare-text-download-button" class="btn btn-secondary"
                                    data-lang-en-select="Select Sections for Text Download"
                                    data-lang-es-select="Seleccionar Secciones para Descargar Texto"
                                    data-lang-vi-select="Chọn Mục để Tải Văn bản"
                                    data-lang-ja-select="テキストDLセクション選択"
                                    data-lang-zhcn-select="选择文本下载部分"
                                    data-lang-en-cancel="Cancel Text Selection"
                                    data-lang-es-cancel="Cancelar Selección de Texto"
                                    data-lang-vi-cancel="Hủy Chọn Văn bản"
                                    data-lang-ja-cancel="テキスト選択をキャンセル"
                                    data-lang-zhcn-cancel="取消文本选择">
                                Select Sections for Text Download
                            </button>

                            <button id="finalize-text-download-button" class="btn btn-success" disabled
                                    data-lang-en="Download Selected Text (.txt)"
                                    data-lang-es="Descargar Texto Seleccionado (.txt)"
                                    data-lang-vi="Tải Văn bản Đã chọn (.txt)"
                                    data-lang-ja="選択テキストをDL (.txt)"
                                    data-lang-zhcn="下载选定文本 (.txt)">
                                Download Selected Text (.txt)
                            </button>

                            <div id="image-format-selector-container">
                                <div>
                                    <label for="image-download-format-select" data-lang-en="Image Format:" data-lang-es="Formato Imagen:" data-lang-vi="Định dạng Ảnh:" data-lang-ja="画像形式：" data-lang-zhcn="图片格式：">Image Format:</label>
                                    <select id="image-download-format-select">
                                        <option value="png">PNG</option> <option value="jpg">JPG</option> <option value="webp">WEBP</option> <option value="tiff">TIFF (as PNG)</option>
                                    </select>
                                </div>
                            </div>

                            <button id="download-all-images-button" class="btn btn-primary" data-lang-en="Download Images (.zip)" data-lang-es="Descargar Imágenes (.zip)" data-lang-vi="Tải Ảnh (.zip)" data-lang-ja="画像DL (.zip)" data-lang-zhcn="下载图像 (.zip)">Download Images (.zip)</button>
                        </div>
                    </div>
                </div>
            </section>
        </section>

        <!-- Pricing Page Section -->
        <section id="pricing-page" class="page">
            <div class="container">
                <h2 data-lang-en="Subscription" data-lang-es="Suscripción" data-lang-vi="Đăng ký" data-lang-ja="サブスクリプション" data-lang-zhcn="订阅">Subscription</h2>
                <div class="pricing-table">
                    <div class="pricing-column free">
                        <div class="pricing-column-inner">
                            <div class="pricing-tier" data-lang-en="Free Trial" data-lang-es="Prueba Gratuita" data-lang-vi="Dùng thử miễn phí" data-lang-ja="無料トライアル" data-lang-zhcn="免费试用">Free Trial</div>
                            <div class="pricing-price">$0</div>
                            <ul class="feature-list">
                                <li> <span class="feature-name" data-lang-en="Monthly price" data-lang-es="Precio mensual" data-lang-vi="Giá hàng tháng" data-lang-ja="月額料金" data-lang-zhcn="月费">Monthly price</span> <span class="feature-value">$0</span> </li>
                                <li> <span class="feature-name" data-lang-en="Desktop & Mobile" data-lang-es="Escritorio y Móvil" data-lang-vi="Máy tính & Di động" data-lang-ja="デスクトップ＆モバイル" data-lang-zhcn="桌面和移动">Desktop & Mobile</span> <span class="feature-value unavailable">-</span> </li>
                                <li> <span class="feature-name" data-lang-en="Generation attempts" data-lang-es="Intentos generación" data-lang-vi="Lượt tạo" data-lang-ja="生成試行" data-lang-zhcn="生成次数">Generation attempts</span> <span class="feature-value">5</span> </li>
                                <li> <span class="feature-name" data-lang-en="Re-generate concept" data-lang-es="Re-generar concepto" data-lang-vi="Tạo lại ý tưởng" data-lang-ja="コンセプト再生成" data-lang-zhcn="重生成概念">Re-generate concept</span> <span class="feature-value unavailable">-</span> </li>
                                <li> <span class="feature-name" data-lang-en="Video demo generate" data-lang-es="Generar demo video" data-lang-vi="Tạo demo video" data-lang-ja="ビデオデモ生成" data-lang-zhcn="视频演示生成">Video demo generate</span> <span class="feature-value unavailable">-</span> </li>
                                <li> <span class="feature-name" data-lang-en="Album cover" data-lang-es="Portada Álbum" data-lang-vi="Bìa Album" data-lang-ja="アルバムカバー" data-lang-zhcn="专辑封面">Album cover</span> <span class="feature-value unavailable">-</span> </li>
                            </ul>
                        </div>
                    </div>
                    <div class="pricing-column medium popular highlighted">
                        <div class="pricing-column-inner">
                            <div class="pricing-tier" data-lang-en="Medium" data-lang-es="Medio" data-lang-vi="Trung bình" data-lang-ja="ミディアム" data-lang-zhcn="中级">Medium</div>
                            <span class="popular-badge" data-lang-en="Popular" data-lang-es="Popular" data-lang-vi="Phổ biến" data-lang-ja="人気" data-lang-zhcn="热门">Popular</span>
                            <div class="pricing-price">$5</div>
                            <ul class="feature-list">
                                <li> <span class="feature-name" data-lang-en="Monthly price" data-lang-es="Precio mensual" data-lang-vi="Giá hàng tháng" data-lang-ja="月額料金" data-lang-zhcn="月费">Monthly price</span> <span class="feature-value">$5</span> </li>
                                <li> <span class="feature-name" data-lang-en="Desktop & Mobile" data-lang-es="Escritorio y Móvil" data-lang-vi="Máy tính & Di động" data-lang-ja="デスクトップ＆モバイル" data-lang-zhcn="桌面和移动">Desktop & Mobile</span> <span class="feature-value icon-check"></span> </li>
                                <li> <span class="feature-name" data-lang-en="Generation attempts" data-lang-es="Intentos generación" data-lang-vi="Lượt tạo" data-lang-ja="生成試行" data-lang-zhcn="生成次数">Generation attempts</span> <span class="feature-value" data-lang-en="Unlimited" data-lang-es="Ilimitados" data-lang-vi="Không giới hạn" data-lang-ja="無制限" data-lang-zhcn="无限">Unlimited</span> </li>
                                <li> <span class="feature-name" data-lang-en="Re-generate concept" data-lang-es="Re-generar concepto" data-lang-vi="Tạo lại ý tưởng" data-lang-ja="コンセプト再生成" data-lang-zhcn="重生成概念">Re-generate concept</span> <span class="feature-value icon-check"></span> </li>
                                <li> <span class="feature-name" data-lang-en="Video demo generate" data-lang-es="Generar demo video" data-lang-vi="Tạo demo video" data-lang-ja="ビデオデモ生成" data-lang-zhcn="视频演示生成">Video demo generate</span> <span class="feature-value unavailable">-</span> </li>
                                <li> <span class="feature-name" data-lang-en="Album cover" data-lang-es="Portada Álbum" data-lang-vi="Bìa Album" data-lang-ja="アルバムカバー" data-lang-zhcn="专辑封面">Album cover</span> <span class="feature-value unavailable">-</span> </li>
                            </ul>
                        </div>
                    </div>
                    <div class="pricing-column pro">
                        <div class="pricing-column-inner">
                            <div class="pricing-tier" data-lang-en="Pro" data-lang-es="Pro" data-lang-vi="Pro" data-lang-ja="プロ" data-lang-zhcn="专业">Pro</div>
                            <div class="coming-soon" data-lang-en="Coming soon..." data-lang-es="Próximamente..." data-lang-vi="Sắp ra mắt..." data-lang-ja="近日公開..." data-lang-zhcn="即将推出...">Coming soon...</div>
                            <div class="pricing-price">$10</div>
                            <ul class="feature-list">
                                <li> <span class="feature-name" data-lang-en="Monthly price" data-lang-es="Precio mensual" data-lang-vi="Giá hàng tháng" data-lang-ja="月額料金" data-lang-zhcn="月费">Monthly price</span> <span class="feature-value">$10</span> </li>
                                <li> <span class="feature-name" data-lang-en="Desktop & Mobile" data-lang-es="Escritorio y Móvil" data-lang-vi="Máy tính & Di động" data-lang-ja="デスクトップ＆モバイル" data-lang-zhcn="桌面和移动">Desktop & Mobile</span> <span class="feature-value icon-check"></span> </li>
                                <li> <span class="feature-name" data-lang-en="Generation attempts" data-lang-es="Intentos generación" data-lang-vi="Lượt tạo" data-lang-ja="生成試行" data-lang-zhcn="生成次数">Generation attempts</span> <span class="feature-value" data-lang-en="Unlimited" data-lang-es="Ilimitados" data-lang-vi="Không giới hạn" data-lang-ja="無制限" data-lang-zhcn="无限">Unlimited</span> </li>
                                <li> <span class="feature-name" data-lang-en="Re-generate concept" data-lang-es="Re-generar concepto" data-lang-vi="Tạo lại ý tưởng" data-lang-ja="コンセプト再生成" data-lang-zhcn="重生成概念">Re-generate concept</span> <span class="feature-value icon-check"></span> </li>
                                <li> <span class="feature-name" data-lang-en="Video demo generate" data-lang-es="Generar demo video" data-lang-vi="Tạo demo video" data-lang-ja="ビデオデモ生成" data-lang-zhcn="视频演示生成">Video demo generate</span> <span class="feature-value icon-check"></span> </li>
                                <li> <span class="feature-name" data-lang-en="Album cover" data-lang-es="Portada Álbum" data-lang-vi="Bìa Album" data-lang-ja="アルバムカバー" data-lang-zhcn="专辑封面">Album cover</span> <span class="feature-value icon-check"></span> </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-back" data-target="home" data-lang-en="Back to Home" data-lang-es="Volver al Inicio" data-lang-vi="Về Trang chủ" data-lang-ja="ホームに戻る" data-lang-zhcn="返回首页">Back to Home</button>
            </div>
        </section>


    </main>

    <!-- How to Use Button -->
    <button id="how-to-use-button" class="btn" data-lang-en="How to Use" data-lang-es="Cómo Usar" data-lang-vi="Cách dùng" data-lang-ja="使い方" data-lang-zhcn="如何使用">How to Use</button>

    <!-- Guide Modal -->
    <div id="guide-modal"> <div id="guide-modal-content"> <button id="close-guide-modal" aria-label="Close Guide">&times;</button> <h3 data-lang-en="How to Use" data-lang-es="Cómo Usar" data-lang-vi="Cách dùng" data-lang-ja="使い方" data-lang-zhcn="如何使用">How to Use</h3> <h4 data-lang-en="1. Input Details" data-lang-es="1. Ingresa Detalles" data-lang-vi="1. Nhập chi tiết" data-lang-ja="1. 詳細入力" data-lang-zhcn="1. 输入详情">1. Input Details</h4> <p data-lang-en="On 'Generate' page:" data-lang-es="En pág 'Generar':" data-lang-vi="Trang 'Tạo':" data-lang-ja="「生成」ページ：" data-lang-zhcn="“生成”页：">On 'Generate' page:</p> <ul> <li data-lang-en="Lyrics: Paste or generate." data-lang-es="Letra: Pega o genera." data-lang-vi="Lời: Dán hoặc tạo." data-lang-ja="歌詞：貼付/生成。" data-lang-zhcn="歌词：粘贴/生成。">Lyrics: Paste or generate.</li> <li data-lang-en="Keywords: Add mood/style." data-lang-es="Palabras Clave: Añade ánimo/estilo." data-lang-vi="Từ khóa: Thêm tâm trạng/phong cách." data-lang-ja="キーワード：ムード/スタイル追加。" data-lang-zhcn="关键词：加情绪/风格。">Keywords: Add mood/style.</li> <li data-lang-en="Genre: Select." data-lang-es="Género: Selecciona." data-lang-vi="Thể loại: Chọn." data-lang-ja="ジャンル：選択。" data-lang-zhcn="流派：选择。">Genre: Select.</li> <li data-lang-en="Record Audio (Optional): Record voice for transcript." data-lang-es="Grabar Audio (Opc.): Graba voz para transcripción." data-lang-vi="Ghi âm (Tùy chọn): Ghi âm giọng nói để có bản ghi." data-lang-ja="録音（任意）：文字起こし用に録音。" data-lang-zhcn="录音（可选）：录制语音用于转录。">Record Audio (Optional): Record voice for transcript.</li> </ul> <h4 data-lang-en="2. Generate Concept" data-lang-es="2. Genera Concepto" data-lang-vi="2. Tạo Ý tưởng" data-lang-ja="2. コンセプト生成" data-lang-zhcn="2. 生成概念">2. Generate Concept</h4> <p data-lang-en="Click 'Generate Concept'." data-lang-es="Clic 'Generar Concepto'." data-lang-vi="Nhấn 'Tạo Ý tưởng'." data-lang-ja="「コンセプト生成」クリック。" data-lang-zhcn="点“生成概念”。">Click 'Generate Concept'.</p> <h4 data-lang-en="3. Choose/Regenerate" data-lang-es="3. Elige/Regenera" data-lang-vi="3. Chọn/Tạo lại" data-lang-ja="3. 選択/再生成" data-lang-zhcn="3. 选择/重生成">3. Choose/Regenerate</h4> <ul> <li data-lang-en="Pick: Get full details." data-lang-es="Elegir: Obtén detalles." data-lang-vi="Chọn: Xem chi tiết." data-lang-ja="選択：詳細取得。" data-lang-zhcn="选择：获详情。">Pick: Get full details.</li> <li data-lang-en="Generate New: Try again." data-lang-es="Generar Nuevo: Intenta de nuevo." data-lang-vi="Tạo Mới: Thử lại." data-lang-ja="新規生成：再試行。" data-lang-zhcn="生成新的：重试。">Generate New: Try again.</li> </ul> <h4 data-lang-en="4. Explore & Download" data-lang-es="4. Explora y Descarga" data-lang-vi="4. Khám phá & Tải" data-lang-ja="4. 探索＆DL" data-lang-zhcn="4. 探索下载">4. Explore & Download</h4> <p data-lang-en="Use tabs. Download text/images." data-lang-es="Usa pestañas. Descarga texto/imágenes." data-lang-vi="Dùng tab. Tải text/ảnh." data-lang-ja="タブ使用。テキスト/画像DL。" data-lang-zhcn="用选项卡。下载文本/图。">Use tabs. Download text/images.</p> <p style="margin-top: 2rem; text-align: center; font-style: italic;" data-lang-en="Enjoy!" data-lang-es="¡Disfruta!" data-lang-vi="Thưởng thức!" data-lang-ja="楽しんで！" data-lang-zhcn="享受！">Enjoy!</p> </div> </div>

    <!-- Settings Modal -->
    <div id="settings-modal">
        <div id="settings-modal-content">
            <button id="close-settings-modal"
                    data-lang-en-aria-label="Close Settings"
                    data-lang-es-aria-label="Cerrar Ajustes"
                    data-lang-vi-aria-label="Đóng Cài đặt"
                    data-lang-ja-aria-label="設定を閉じる"
                    data-lang-zhcn-aria-label="关闭设置"
                    aria-label="Close Settings">&times;</button>
            <h3 data-lang-en="Settings" data-lang-es="Ajustes" data-lang-vi="Cài đặt" data-lang-ja="設定" data-lang-zhcn="设置">Settings</h3>

            <div class="settings-section language-setting-container">
                <h4 data-lang-en="Language" data-lang-es="Idioma" data-lang-vi="Ngôn ngữ" data-lang-ja="言語" data-lang-zhcn="语言">Language</h4>
                <label for="language-select" class="sr-only" data-lang-en="Select Language" data-lang-es="Seleccionar Idioma" data-lang-vi="Chọn Ngôn ngữ" data-lang-ja="言語選択" data-lang-zhcn="选择语言">Select Language</label>
                <select id="language-select">
                    <option value="en">English</option>
                    <option value="es">Español</option>
                    <option value="vi">Tiếng Việt</option>
                    <option value="ja">日本語</option>
                    <option value="zh-CN">中文</option>
                </select>
            </div>

            <div class="settings-section">
                <h4 data-lang-en="Background Music" data-lang-es="Música de Fondo" data-lang-vi="Nhạc Nền" data-lang-ja="背景音楽" data-lang-zhcn="背景音乐">Background Music</h4>
                <div class="music-controls">
                    <button id="play-pause-music-button" aria-label="Play Music">
                        <!-- SVG injected by JS -->
                    </button>
                    <input type="range" id="volume-slider" min="0" max="100" value="50" aria-label="Volume">
                </div>
            </div>
        </div>
    </div>


    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2025 MVPot. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">

    // Import necessary modules from Three.js
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Element References ---
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page');
        const exploreButton = document.getElementById('explore-button');
        const backButtons = document.querySelectorAll('.btn-back');
        const loadingOverlay = document.getElementById('loading-overlay');
        const languageSelect = document.getElementById('language-select');
        const howToUseButton = document.getElementById('how-to-use-button');
        const guideModal = document.getElementById('guide-modal');
        const closeGuideModal = document.getElementById('close-guide-modal');
        const bgCanvas = document.getElementById('bg-canvas');
        const hoverSound = document.getElementById('hover-sound');
        const clickSound = document.getElementById('click-sound');

        const featurePage = document.getElementById('feature-page');
        const inputSidebar = document.querySelector('.input-sidebar');
        const outputArea = document.querySelector('.output-area');
        const initialPrompt = document.getElementById('initial-prompt');
        const conceptDisplayArea = document.getElementById('concept-display-area');
        const conceptTextOutput = document.getElementById('concept-text-output');
        const pickConceptButton = document.getElementById('pick-concept-button');
        const regenerateConceptButtonAlt = document.getElementById('regenerate-concept-button-alt');
        const tabbedResultsArea = document.getElementById('tabbed-results-area');
        const resultsTabsContainer = document.querySelector('.results-tabs');
        const tabContentArea = document.querySelector('.tab-content-area');

        const downloadActionArea = document.getElementById('download-action-area');
        const prepareTextDownloadButton = document.getElementById('prepare-text-download-button');
        const finalizeTextDownloadButton = document.getElementById('finalize-text-download-button');
        const downloadAllImagesButton = document.getElementById('download-all-images-button');
        const imageDownloadFormatSelect = document.getElementById('image-download-format-select');

        const featureForm = document.getElementById('feature-form');
        const generateConceptButton = document.getElementById('generate-concept-button');
        const generateLyricsButton = document.getElementById('generate-lyrics-button');
        const lyricsInput = document.getElementById('lyrics-input');
        const keywordsInput = document.getElementById('keywords-input');
        const genreSelect = document.getElementById('genre-select');
        const transcriptGroup = document.getElementById('transcript-group');
        const transcriptOutput = document.getElementById('transcript-output');
        const recordAudioButton = document.getElementById('record-audio-button');
        const recordStatus = document.getElementById('record-status');
        const recordingAnimation = document.getElementById('recording-animation');
        const recordStatusText = document.getElementById('record-status-text');
        const errorMessageDiv = document.getElementById('error-message');

        let tabLinks = resultsTabsContainer?.querySelectorAll('.tab-link');
        let tabContents = tabContentArea?.querySelectorAll('.tab-content');


        const pricingColumns = document.querySelectorAll('.pricing-column');
        const pricingCheckmarkSpans = document.querySelectorAll('.feature-value.icon-check');

        const backgroundMusic = document.getElementById('background-music');
        const settingsTriggerButton = document.getElementById('settings-trigger-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModal = document.getElementById('close-settings-modal');
        const playPauseMusicButton = document.getElementById('play-pause-music-button');
        const volumeSlider = document.getElementById('volume-slider');

        const floatingImageContainer = document.getElementById('parallax-container');
        const floatingImageElements = [];

        // Hamburger Menu Elements (Added)
        const hamburgerButton = document.getElementById('hamburger-menu');
        const mainNavUl = document.getElementById('main-nav-ul');


        let currentInputs = null; let currentLang = 'en'; let activePage = 'home'; let generateStep = 'initial'; let currentConceptText = ''; let currentDetailedResultsText = ''; let musicIsPlaying = false; let musicInitialized = false;
        let storedPageData = { feature: { inputs: null, conceptText: '', detailedResultsText: '', step: 'initial', formValues: null, imagePlaceholders: [] }, pricing: {} };
        let isTextDownloadModeActive = false;

        let mediaRecorder; let audioChunks = []; let isRecording = false; let recordedAudioBlob = null;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition; let finalTranscript = ''; let isSpeechRecognitionSupported = !!SpeechRecognition;

        // const svgIconGear = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49 1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69.98l-.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17.59 1.69.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22-.07.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>`;
        const svgIconPlay = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
        const svgIconPause = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
        const svgCheckmark = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>`;


        const sectionsToTabs = {
            'Concept / Key Visual': 'tab-content-concept',
            'Requirements for MV': 'tab-content-requirements',
            'Estimated Budget': 'tab-content-budget',
            'Visual Demo (Key Images)': 'tab-content-visuals',
            'Moodboard Influences': 'tab-content-moodboard',
            'Typography/Font Suggestion': 'tab-content-fonts',
            'Color Palette': 'tab-content-palette',
            'Video Demo': 'tab-content-video-demo',
            'Album Cover': 'tab-content-album-cover'
        };
        const tabTitles = {
            'tab-content-concept': 'Concept',
            'tab-content-requirements': 'Requirements',
            'tab-content-budget': 'Budget',
            'tab-content-visuals': 'Key Images',
            'tab-content-moodboard': 'Moodboard',
            'tab-content-fonts': 'Typography',
            'tab-content-palette': 'Color Palette',
            'tab-content-video-demo': 'Video Demo',
            'tab-content-album-cover': 'Album Cover'
        };
        const tabTargetToSectionKey = {
            'tab-content-concept': 'concept',
            'tab-content-requirements': 'requirements',
            'tab-content-budget': 'budget',
            'tab-content-visuals': 'visuals_desc',
            'tab-content-moodboard': 'moodboard',
            'tab-content-fonts': 'fonts',
            'tab-content-palette': 'palette'
        };


        function playSound(audioElement) { if (audioElement) { audioElement.currentTime = 0; audioElement.play().catch(error => console.warn("Audio play failed:", error)); } }

        // --- MODIFIED showPage function ---
        function showPage(pageId) {
             if (activePage === 'feature' && pageId !== 'feature' && generateStep !== 'initial') {
                 console.log("Storing feature page data. Step:", generateStep);
                 const imageDataToStore = [];
                 document.querySelectorAll('#tab-content-visuals .image-placeholder, #tab-content-moodboard .image-placeholder').forEach((figure) => { const img = figure.querySelector('img'); const figcaption = figure.querySelector('figcaption'); const seedSuffix = figure.dataset.seedSuffix; const tabId = figure.closest('#tab-content-visuals') ? 'visuals' : 'moodboard'; if (img && img.src && figcaption && seedSuffix && !img.src.startsWith('data:')) { imageDataToStore.push({ seedSuffix: seedSuffix, tabId: tabId, src: img.src, alt: img.alt, figcaptionHTML: figcaption.innerHTML }); } });
                 storedPageData.feature = { inputs: currentInputs ? JSON.parse(JSON.stringify(currentInputs)) : null, conceptText: currentConceptText, detailedResultsText: currentDetailedResultsText, step: generateStep, formValues: { lyrics: lyricsInput.value, keywords: keywordsInput.value, genre: genreSelect.value, transcript: transcriptOutput.value, transcriptVisible: transcriptGroup.style.display === 'block' }, imagePlaceholders: imageDataToStore };
                 if (isTextDownloadModeActive) {
                    toggleTextDownloadMode(false);
                 }
             }

             activePage = pageId;
             pages.forEach(page => { page.classList.toggle('active', page.id === `${pageId}-page`); });

             // Navigation link active state management
             navLinks.forEach(navLink => {
                const navLinkPage = navLink.getAttribute('data-page');
                const navLinkScrollTo = navLink.getAttribute('data-scroll-to');

                if (navLinkPage) { // It's a main page link
                    navLink.classList.toggle('active', navLinkPage === pageId);
                } else if (navLinkScrollTo) { // It's a scroll-to link (like "About")
                    // Deactivate scroll-to links if we are not on the 'home' page
                    if (pageId !== 'home') {
                        navLink.classList.remove('active');
                    }
                    // If we are on the home page, the click handler for the scroll-to link
                    // will manage its active state in conjunction with the 'Home' link.
                }
                // External links (like the new Feedback link) are not affected here regarding 'active' state for page changes.
            });


            if (floatingImageContainer) {
                floatingImageContainer.style.display = (pageId === 'home') ? 'block' : 'none';
            }

             window.scrollTo(0, 0);
             if (pageId === 'feature') {
                 clearErrors();
                 if (storedPageData.feature && storedPageData.feature.step && storedPageData.feature.step !== 'initial') {
                    console.log("Restoring feature page data:", storedPageData.feature);
                    if (storedPageData.feature.formValues) { lyricsInput.value = storedPageData.feature.formValues.lyrics || ''; keywordsInput.value = storedPageData.feature.formValues.keywords || ''; genreSelect.value = storedPageData.feature.formValues.genre || ''; transcriptOutput.value = storedPageData.feature.formValues.transcript || ''; transcriptGroup.style.display = storedPageData.feature.formValues.transcriptVisible ? 'block' : 'none'; } else { if (featureForm) featureForm.reset(); transcriptGroup.style.display = 'none'; transcriptOutput.value = ''; }
                    currentInputs = storedPageData.feature.inputs ? JSON.parse(JSON.stringify(storedPageData.feature.inputs)) : null; currentConceptText = storedPageData.feature.conceptText || ''; currentDetailedResultsText = storedPageData.feature.detailedResultsText || ''; generateStep = storedPageData.feature.step; updateGeneratePageUI(generateStep);
                    if (generateStep === 'concept_shown' && currentConceptText) { conceptTextOutput.textContent = currentConceptText; conceptTextOutput.classList.remove('placeholder-notice'); } else if (generateStep === 'details_shown' && currentDetailedResultsText) { clearTabContents(); const visualContainer = document.getElementById('tab-content-visuals')?.querySelector('.image-placeholder-container'); const moodboardContainer = document.getElementById('tab-content-moodboard')?.querySelector('.image-placeholder-container'); if (visualContainer) visualContainer.innerHTML = ''; if (moodboardContainer) moodboardContainer.innerHTML = ''; parseAndDisplayDetailedResults(currentDetailedResultsText); if (resultsTabsContainer?.querySelector('.tab-link')) { activateTab(resultsTabsContainer.querySelector('.tab-link')); } } else if (generateStep === 'initial' || (!currentConceptText && !currentDetailedResultsText && generateStep !== 'initial')) { console.warn("Stored data non-initial, content missing/initial step. Resetting."); if (featureForm) featureForm.reset(); transcriptGroup.style.display = 'none'; transcriptOutput.value = ''; resetGeneratePageUI(); }
                 } else {
                     console.log("No valid feature page data to restore or initial step. Resetting.");
                     if (featureForm) featureForm.reset(); transcriptGroup.style.display = 'none'; transcriptOutput.value = ''; resetGeneratePageUI();
                 }
             } else if (pageId === 'pricing') {
                 injectCheckmarks();
                 pricingColumns.forEach(col => {
                     col.classList.toggle('highlighted', col.classList.contains('medium'));
                 });
             }
            // Close mobile nav if open
            if (mainNavUl && mainNavUl.classList.contains('mobile-nav-open')) {
                mainNavUl.classList.remove('mobile-nav-open');
                hamburgerButton.setAttribute('aria-expanded', 'false');
            }
        }


        function injectCheckmarks() { pricingCheckmarkSpans.forEach(span => { if (!span.innerHTML.includes('<svg')) { span.innerHTML = svgCheckmark; } }); }

        function showLoading(messageKey = "generatingCreativeSparks", fallbackMessage = "Generating...") {
            if (!loadingOverlay) return;
            const textElement = loadingOverlay.querySelector('p');
            if (textElement) {
                const translatedMessage = getTranslatedText(textElement, messageKey, false, fallbackMessage);
                textElement.textContent = translatedMessage;
                textElement.dataset.lastKey = messageKey;
            }
            loadingOverlay.classList.add('show');
            if (isTextDownloadModeActive) {
                toggleTextDownloadMode(false);
            }
            [generateConceptButton, generateLyricsButton, pickConceptButton, regenerateConceptButtonAlt, recordAudioButton,
             prepareTextDownloadButton, finalizeTextDownloadButton, downloadAllImagesButton].forEach(btn => {
                if(btn) btn.disabled = true;
            });
        }
        function hideLoading() {
            if (!loadingOverlay) return;
            loadingOverlay.classList.remove('show');
            if(generateConceptButton) generateConceptButton.disabled = false;
            if(generateLyricsButton) generateLyricsButton.disabled = false;
            if(pickConceptButton) pickConceptButton.disabled = (generateStep !== 'concept_shown');
            if(regenerateConceptButtonAlt) regenerateConceptButtonAlt.disabled = (generateStep !== 'concept_shown');
            if(recordAudioButton) recordAudioButton.disabled = !(navigator.mediaDevices?.getUserMedia && isSpeechRecognitionSupported) || isRecording;

            const detailsShown = (generateStep === 'details_shown');
            if(prepareTextDownloadButton) prepareTextDownloadButton.disabled = !detailsShown;
            if(downloadAllImagesButton) downloadAllImagesButton.disabled = !detailsShown;
            updateFinalizeButtonState();
        }


        if (recordAudioButton) { recordAudioButton.addEventListener('click', handleRecordButtonClick); if (!navigator.mediaDevices?.getUserMedia || !isSpeechRecognitionSupported) { const statusKey = !navigator.mediaDevices?.getUserMedia ? 'statusAudioNotSupported' : 'statusSpeechRecNotSupported'; updateRecordStatus(getTranslatedText(null, statusKey, false, 'Audio/Speech input not supported.'), 'error', true, statusKey); recordAudioButton.disabled = true; } }
        async function handleRecordButtonClick() { if (!navigator.mediaDevices?.getUserMedia || !isSpeechRecognitionSupported) return; if (!isRecording) { try { recordedAudioBlob = null; transcriptOutput.value = ''; finalTranscript = ''; transcriptGroup.style.display = 'none'; clearRecordStatus(); updateRecordStatus('Requesting mic access...', '', false, 'statusRequestingMic'); const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); updateRecordStatus('', 'recording', false); mediaRecorder = new MediaRecorder(stream); mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); }; mediaRecorder.onstop = () => { recordedAudioBlob = (audioChunks.length > 0) ? new Blob(audioChunks, { type: 'audio/webm;codecs=opus' }) : null; audioChunks = []; stream.getTracks().forEach(track => track.stop()); updateRecordingUI(false); if (!recognition || !recognition.recognizing) { updateFinalRecordStatus(); } }; mediaRecorder.onerror = (event) => { console.error("MediaRecorder error:", event.error); const errorMsg = getTranslatedText(null, 'statusRecordingError', false, `Rec. error: ${event.error.name}`).replace('${errorName}', event.error.name); updateRecordStatus(errorMsg, 'error', true); if (recognition?.abort) { try { recognition.abort(); } catch(e){} } stream.getTracks().forEach(track => track.stop()); updateRecordingUI(false); }; recognition = new SpeechRecognition(); recognition.continuous = true; recognition.interimResults = true; const bcp47Map = { 'zh-CN': 'zh-CN', 'vi': 'vi-VN', 'ja': 'ja-JP', 'es': 'es-ES' }; recognition.lang = bcp47Map[currentLang] || (currentLang.includes('-') ? currentLang : `${currentLang}-${currentLang.toUpperCase()}`); console.log("SpeechRecognition language:", recognition.lang); recognition.onresult = (event) => { let interimTranscript = ''; finalTranscript = ''; for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript + ' '; else interimTranscript += event.results[i][0].transcript; } const currentFullTranscript = (finalTranscript + interimTranscript).trim(); transcriptOutput.value = currentFullTranscript; if (currentFullTranscript) transcriptGroup.style.display = 'block'; updateRecordStatus(getTranslatedText(null, 'statusTranscribing', false, 'Transcribing...'), 'transcribing', false, 'statusTranscribing'); }; recognition.onerror = (event) => { console.error("Speech Recognition Error:", event.error, event.message); let errorMsgKey = 'transcriptionErrorGeneric', errorParam = event.error; if (event.error === 'no-speech') errorMsgKey = 'transcriptionErrorNoSpeech'; else if (event.error === 'audio-capture') errorMsgKey = 'transcriptionErrorMicProblem'; else if (event.error === 'not-allowed') errorMsgKey = 'transcriptionErrorPermission'; else if (event.error === 'network') errorMsgKey = 'transcriptionErrorNetwork'; const translatedError = getTranslatedText(null, errorMsgKey, false, `Transcr. error: ${errorParam}`); if (!recordStatus?.classList.contains('error')) updateRecordStatus(translatedError, 'error', true, errorMsgKey); if (mediaRecorder?.state === "recording" && event.error !== 'no-speech') try { mediaRecorder.stop(); } catch(e){} }; recognition.onstart = () => { console.log("Speech recognition started."); updateRecordStatus(getTranslatedText(null, 'statusTranscribing', false, 'Transcribing...'), 'transcribing', false, 'statusTranscribing'); }; recognition.onend = () => { console.log("Speech recognition ended."); finalTranscript = finalTranscript.trim(); transcriptOutput.value = finalTranscript; if (!finalTranscript && transcriptGroup.style.display === 'block') transcriptGroup.style.display = 'none'; if (!isRecording) updateFinalRecordStatus(); }; audioChunks = []; mediaRecorder.start(); recognition.start(); updateRecordingUI(true); } catch (err) { console.error("Mic access error:", err); let errorMsgKey = 'micErrorGeneric'; if (err.name === 'NotAllowedError') errorMsgKey = 'micErrorPermission'; else if (err.name === 'NotFoundError') errorMsgKey = 'micErrorNotFound'; else if (err.name === 'NotReadableError') errorMsgKey = 'micErrorHardware'; updateRecordStatus(getTranslatedText(null, errorMsgKey, false, 'Mic access error.'), 'error', true, errorMsgKey); updateRecordingUI(false); } } else { if (mediaRecorder?.state === "recording") { updateRecordStatus(getTranslatedText(null, 'statusStopping', false, 'Stopping...'), '', false, 'statusStopping'); try { mediaRecorder.stop(); } catch(e){} } if (recognition?.stop) { try { recognition.stop(); } catch (e) { if (!isRecording) updateFinalRecordStatus(); } } else if (!isRecording) { updateFinalRecordStatus(); } } }
        function updateFinalRecordStatus() { setTimeout(() => { if (recordStatus?.classList.contains('error')) return; let finalStatusMsgKey = 'stoppedStatus', finalStatusClass = '', isPersistent = false; if (recordedAudioBlob && finalTranscript) { finalStatusMsgKey = 'recordTranscriptComplete'; finalStatusClass = 'complete'; isPersistent = true; } else if (recordedAudioBlob && !finalTranscript) { finalStatusMsgKey = 'recordCompleteNoTranscript'; finalStatusClass = 'complete'; isPersistent = true; } else if (!recordedAudioBlob && finalTranscript) { finalStatusMsgKey = 'transcriptCompleteNoRecord'; finalStatusClass = 'complete'; isPersistent = true; } updateRecordStatus(getTranslatedText(null, finalStatusMsgKey, false, 'Stopped.'), finalStatusClass, isPersistent, finalStatusMsgKey); }, 100); }
        function updateRecordingUI(recording) { if (!recordAudioButton) return; isRecording = recording; const recordKey = 'record', stopKey = 'stop'; const buttonText = recording ? getTranslatedText(recordAudioButton, stopKey, true, 'Stop Recording') : getTranslatedText(recordAudioButton, recordKey, true, 'Record Audio'); recordAudioButton.textContent = buttonText; recordAudioButton.disabled = false; recordAudioButton.classList.toggle('btn-danger', recording); recordAudioButton.classList.toggle('btn-warning', !recording); if(recordingAnimation) recordingAnimation.style.display = recording ? 'inline-block' : 'none'; if (recording) updateRecordStatus(getTranslatedText(null, 'statusRecording', false, 'Recording...'), 'recording', false, 'statusRecording'); else recordAudioButton.disabled = !(navigator.mediaDevices?.getUserMedia && isSpeechRecognitionSupported); }
        function updateRecordStatus(message, statusClass = '', persistent = false, translationKey = '') { if (!recordStatus || !recordStatusText || !recordingAnimation) return; if (updateRecordStatus.timeoutId) clearTimeout(updateRecordStatus.timeoutId); const displayMessage = translationKey ? getTranslatedText(null, translationKey, false, message) : message; recordStatusText.textContent = displayMessage; recordStatus.className = 'record-status-base'; recordStatus.dataset.statusKey = translationKey; recordStatus.dataset.statusFallback = message; if (statusClass) recordStatus.classList.add(statusClass); recordingAnimation.style.display = (statusClass === 'recording' || statusClass === 'transcribing') ? 'inline-block' : 'none'; if (!persistent && statusClass !== 'error' && displayMessage) { updateRecordStatus.timeoutId = setTimeout(() => { if (recordStatusText.textContent === displayMessage && recordStatus.dataset.statusKey === translationKey) clearRecordStatus(); }, 4000); } }
        updateRecordStatus.timeoutId = null;
        function clearRecordStatus() { if (recordStatusText) recordStatusText.textContent = ''; if (recordStatus) { recordStatus.className = 'record-status-base'; delete recordStatus.dataset.statusKey; delete recordStatus.dataset.statusFallback; } if (recordingAnimation) recordingAnimation.style.display = 'none'; if (updateRecordStatus.timeoutId) { clearTimeout(updateRecordStatus.timeoutId); updateRecordStatus.timeoutId = null; } }

        function generateRandomLyrics() { const structures = ['Intro', 'Verse', 'Chorus', 'Verse', 'Chorus', 'Bridge', 'Chorus', 'Outro']; const lines = { Intro: ["Yeah...", "Listen...", "In the quiet of the dawn...", "Another day begins...", "(Instrumental intro vibe)"], Verse: ["Walking down these empty streets again,", "Lost in thought, the city sleeps,", "Remember echoes of a distant past,", "Sunlight paints the window pane,", "Another coffee, numb the pain,", "Trying to find where I belong,", "The rhythm of the falling rain,", "Whispers carried on the breeze,", "A photograph begins to fade,", "Watching shadows start to grow,"], Chorus: ["Oh, this feeling takes me higher,", "Burning bright, a hidden fire,", "Can we turn back time somehow?", "Just let go, right here and now.", "We're searching for a guiding light,", "Through the darkness of the night,", "Holding on to what we know,", "Where do we go, where do we go?", "This melody, it sets me free,", "Just you and I, wild and carefree,", "A moment caught, eternally,", "Is this dream reality?"], Bridge: ["Maybe we were meant to stray,", "Find a different path, a different way,", "Worlds apart, yet still connected,", "Underneath the silver moon's soft glow,", "There's a truth I need to know,", "Before the final curtain falls,"], Outro: ["Fading out... into the night...", "Just an echo...", "Yeah, gone...", "(Fade out)", "Until next time..."] }; let fullLyrics = ""; let sentenceCount = 0; const minSentences = 10; const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)]; let currentStructure = []; while (sentenceCount < minSentences || structures.length > 0) { const part = structures.length > 0 ? structures.shift() : getRandom(['Verse', 'Chorus']); currentStructure.push(part); const numLines = (part === 'Chorus' || part === 'Verse') ? getRandom([2, 3]) : 1; for (let i = 0; i < numLines; i++) { if (lines[part]) sentenceCount++; } if (sentenceCount >= minSentences && structures.length === 0 && !currentStructure.includes('Outro')) currentStructure.push('Outro'); } if (currentStructure.includes('Outro') && currentStructure[currentStructure.length - 1] !== 'Outro') { currentStructure = currentStructure.filter(p => p !== 'Outro'); currentStructure.push('Outro'); } currentStructure.forEach((part, index) => { if (lines[part]) { fullLyrics += `[${part}${index > 0 && part === currentStructure[index-1] ? ' 2' : ''}]\n`; const numLines = (part === 'Chorus' || part === 'Verse') ? getRandom([2, 3]) : 1; let usedLines = new Set(); for (let i = 0; i < numLines; i++) { let line; do { line = getRandom(lines[part]); } while (usedLines.has(line) && lines[part].length > 1); usedLines.add(line); fullLyrics += line + "\n"; } fullLyrics += "\n"; } }); lyricsInput.value = fullLyrics.trim(); }

        async function callGeminiAPI(promptText, loadingMessageKey = "generatingCreativeSparks", loadingFallback = "Generating...") { const GEMINI_API_KEY = "AIzaSyB5c-hp-QeKBpBTz8qwANe4j5Kc4dZ_bWM"; if (!GEMINI_API_KEY || GEMINI_API_KEY.startsWith("YOUR_") || GEMINI_API_KEY.length < 30) { displayError(getTranslatedText(null, 'errorApiKeyInvalid', false, "API Key is missing or invalid."), 'errorApiKeyInvalid'); return null; } const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`; showLoading(loadingMessageKey, loadingFallback); const requestBody = { contents: [{ parts: [{ text: promptText }] }], generationConfig: { temperature: 0.75, maxOutputTokens: 4096, }, safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }, ] }; try { console.log("Sending API request..."); const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) }); const responseData = await response.json(); if (!response.ok) { const errorDetail = responseData?.error?.message || `HTTP Error: ${response.status}`; if (response.status === 0) throw new Error(getTranslatedText(null, 'errorCorsOrNetwork', false, 'Network/CORS error.')); throw new Error(getTranslatedText(null, 'errorApiHttp', false, `API fail: ${errorDetail}`).replace('${errorDetail}', errorDetail)); } const candidate = responseData?.candidates?.[0]; if (!candidate || responseData?.promptFeedback?.blockReason || candidate.finishReason === "SAFETY") { const reason = candidate?.finishReason || responseData?.promptFeedback?.blockReason || "Unknown"; throw new Error(getTranslatedText(null, 'errorApiBlocked', false, `Blocked by safety (Reason: ${reason}).`).replace('${reason}', reason)); } if (responseData?.error) throw new Error(getTranslatedText(null, 'errorApiGeneral', false, `API Error: ${responseData.error.message}`).replace('${errorMessage}', responseData.error.message)); const finishReason = candidate.finishReason; if (finishReason && !["STOP", "MAX_TOKENS"].includes(finishReason)) console.warn(`Abnormal finish: ${finishReason}`); if (finishReason === "MAX_TOKENS") console.warn("Max tokens reached."); if (candidate?.content?.parts?.[0]?.text) return candidate.content.parts[0].text.trim(); else throw new Error(getTranslatedText(null, 'errorApiEmptyResponse', false, "Empty response from AI.")); } catch (error) { console.error("API Error:", error); let errorKey = 'errorUnknown'; const msg = String(error.message).toLowerCase(); if (msg.includes("api key") || msg.includes("invalid")) errorKey = 'errorApiKeyInvalid'; else if (msg.includes("http error")) errorKey = 'errorApiHttp'; else if (msg.includes("blocked") || msg.includes("safety")) errorKey = 'errorApiBlocked'; else if (msg.includes("api error")) errorKey = 'errorApiGeneral'; else if (msg.includes("empty text response")) errorKey = 'errorApiEmptyResponse'; else if (msg.includes('network') || msg.includes('cors') || msg.includes('failed to fetch')) errorKey = 'errorCorsOrNetwork'; displayError(error.message, errorKey); return null; } finally { hideLoading(); } }

        async function handleGenerateConcept() {
             const lyrics = lyricsInput.value.trim(); const keywords = keywordsInput.value.trim(); const selectedGenre = genreSelect.value; const singingTranscript = transcriptOutput.value.trim(); let validationError = false, errorMsg = '', errorKey = '', focusEl = null;
              if (!lyrics) { errorMsg = getTranslatedText(lyricsInput, 'placeholder', true) || "Provide lyrics."; errorKey = 'validationLyricsMissing'; focusEl = lyricsInput; validationError = true; }
              else if (!keywords) { errorMsg = getTranslatedText(keywordsInput, 'placeholder', true) || "Provide keywords."; errorKey = 'validationKeywordsMissing'; focusEl = keywordsInput; validationError = true; }
              else if (!selectedGenre) { errorMsg = getTranslatedText(genreSelect.options[0]) || "Select genre."; errorKey = 'validationGenreMissing'; focusEl = genreSelect; validationError = true; }
              if(validationError) { displayError(errorMsg, errorKey); focusEl?.focus(); return; }
             currentInputs = { lyrics, keywords, selectedGenre, singingTranscript }; currentDetailedResultsText = ''; if (storedPageData.feature && storedPageData.feature.imagePlaceholders) { storedPageData.feature.imagePlaceholders = []; }
             clearErrors();
             if (isTextDownloadModeActive) toggleTextDownloadMode(false);
             updateGeneratePageUI('loading');
             const prompt = `\nYou are an AI assistant specialized in generating creative concepts for music videos.\nAnalyze the following song details:\n**Lyrics:**\n\`\`\`\n${lyrics}\n\`\`\`${singingTranscript ? `\n**Singing Transcript (Optional Context):**\n\`\`\`\n${singingTranscript}\n\`\`\`\n` : ''}\n**Keywords/Theme:** ${keywords}\n**Music Genre:** ${selectedGenre}\n\nGenerate **ONLY** the "Concept / Key Visual" section for a music video based on these details. Provide a concise, compelling core concept description (around 2-5 sentences). Mention 1-2 key visual motifs or scenes. Output *only the description text itself*, without any headers like "## Concept / Key Visual".`;
             const generatedText = await callGeminiAPI(prompt, "generatingConcept", "Generating Concept...");
             if (generatedText) { currentConceptText = generatedText; conceptTextOutput.textContent = currentConceptText; conceptTextOutput.classList.remove('placeholder-notice'); updateGeneratePageUI('concept_shown'); errorMessageDiv.style.display = 'none'; } else { updateGeneratePageUI('initial'); }
        }

        async function handlePickConcept() {
            if (!currentInputs || !currentConceptText) { displayError(getTranslatedText(null, 'errorExploreNoConcept', false, "Generate concept first."), 'errorExploreNoConcept'); return; }
            if(pickConceptButton) pickConceptButton.disabled = true; if(regenerateConceptButtonAlt) regenerateConceptButtonAlt.disabled = true;
            if (storedPageData.feature && storedPageData.feature.imagePlaceholders) { storedPageData.feature.imagePlaceholders = []; }
            if (isTextDownloadModeActive) toggleTextDownloadMode(false);
            updateGeneratePageUI('loading');
            const { lyrics, keywords, selectedGenre, singingTranscript } = currentInputs;
            const prompt = `
You are an AI assistant specialized in generating creative concepts for music videos.
Based on the original song details:
**Lyrics:**
\`\`\`
${lyrics}
\`\`\`${singingTranscript ? `
**Singing Transcript (Optional Context):**
\`\`\`
${singingTranscript}
\`\`\`
` : ''}
**Keywords/Theme:** ${keywords}
**Music Genre:** ${selectedGenre}

And this CHOSEN "Concept / Key Visual":
\`\`\`
${currentConceptText.replace(/`/g, '\\`')}
\`\`\`

Provide the following detailed sections for the music video. Structure *exactly* like this in English:

## Requirements for MV
(* or - list item: Detail about location, casting, props, wardrobe, cinematography, VFX, editing style, etc. Be specific and relevant.)

## Estimated Budget
(**Low Budget:** ~$Range (Optional). Description of approach.
- Example Item - $Cost (Optional, list a few key cost drivers if applicable)

**Mid Budget:** ~$Range (Optional). Description of approach, potentially scaling up elements from Low.
- Example Item - $Cost

**High Budget:** ~$Range (Optional). Description of approach, allowing for higher production value.
- Example Item - $Cost
)

## Color Palette
(List 3-5 colors. Indicate the DOMINANT color first. For each color, provide its name, hex code, and a brief application suggestion for the MV. Use the exact format below, one color per line. This palette will be crucial for the visual sections below.)
Dominant Color Name (#XXXXXX) - Application: [Use this for main backgrounds or character outfits to set the core mood.]
Secondary Color Name (#YYYYYY) - Application: [Apply to secondary elements like set dressing or subtle gradients.]
Accent Color Name (#ZZZZZZ) - Application: [Use sparingly to highlight key props, text overlays, or create visual contrast.]
(Add more secondary/accent colors if appropriate, following the same format)

## Visual Demo (Key Images)
(IMPORTANT: Generate 3-4 vivid descriptions for key scenes or visual moments. These descriptions should form a **cohesive visual narrative or logical sequence** that progresses through the MV's story or theme. Each description is for a distinct image.
**After the list of descriptions, provide a paragraph titled "Key Images Cohesion:" explaining how these key images connect to each other and contribute to the overall concept.**.
When describing scenes, subtly incorporate colors and moods from the **Color Palette** section you will generate above. Ensure descriptions are detailed enough for image generation.)
1. [Description for Image 1]
2. [Description for Image 2]
3. [Description for Image 3]
(Optional 4. [Description for Image 4])
**Key Images Cohesion:** [Explanation paragraph here]

## Moodboard Influences
(IMPORTANT: Provide a short sentence describing the overall mood and visual style. Then list 3-5 specific visual elements or references suitable for image generation. These should be thematically consistent with the Key Images and the overall concept.
**After the list, provide a paragraph titled "Moodboard Cohesion:" explaining how these moodboard items relate to the concept and key visuals.**
Subtly reference colors and moods from the **Color Palette** you generated above.)
[Overall mood/style sentence here]
* [Specific visual element/reference 1 for image generation]
* [Specific visual element/reference 2 for image generation]
* [Specific visual element/reference 3 for image generation]
(Optional * [Element 4])
(Optional * [Element 5])
**Moodboard Cohesion:** [Explanation paragraph here]

## Typography/Font Suggestion
(Suggest ONE suitable font combination (1 or 2 fonts).
**Font Combination:** [Font Name 1] & [Font Name 2 (Optional)]
*Reason:* [Explain why this combination (or single font) fits the song's lyrics, theme, genre, and mood. Be specific.]
*Sample Title (Using Font 1):* "[Create a short, relevant sample sentence using the first font]"
*[Optional] Sample Body (Using Font 2):* "[Create a short, relevant sample sentence using the second font, if applicable]"
Provide actual, common font names (e.g., 'Montserrat', 'Playfair Display', 'Roboto Mono'). Ensure samples showcase the font's feel.)

Adhere strictly to the format: Use the exact headers (##), use bullet points (* or -) for Requirements and Moodboard lists, use numbering (1., 2., 3.) for Visual Demo. Use the bold format **Level Budget:** for budget tiers. For Fonts, use **Font Combination:**, *Reason:*, *Sample Title:*, *Sample Body:*. For Colors, use 'Color Name (#XXXXXX) - Application: [description]', starting with 'Dominant'. Provide detailed, relevant content. Use plausible USD ($) ranges for budget. Ensure Visual Demo and Moodboard items are descriptive image prompts. Ensure the **Color Palette** is generated *before* Visual Demo and Moodboard descriptions so its colors can be referenced.
`;
             const generatedText = await callGeminiAPI(prompt, "fetchingDetails", "Fetching More Details...");
             if (generatedText) { currentDetailedResultsText = generatedText; clearTabContents(); parseAndDisplayDetailedResults(generatedText); updateGeneratePageUI('details_shown'); errorMessageDiv.style.display = 'none'; } else { updateGeneratePageUI('concept_shown'); if(pickConceptButton) pickConceptButton.disabled = false; if(regenerateConceptButtonAlt) regenerateConceptButtonAlt.disabled = false; }
        }

        function handleRegenerateConceptAlt() { handleGenerateConcept(); }

        function parseAndDisplayDetailedResults(text) {
            console.log("--- Parsing Detailed AI Response for Tabs---");
            const lines = text.split('\n');
            let currentSectionKey = null;
            let currentTargetTabId = null;
            let contentBuffer = '';
            let foundAnySection = false;
            const processedTabIds = new Set();
            let unrecognizedHeaders = [];

            const conceptTabContent = document.getElementById('tab-content-concept');
            if (conceptTabContent && currentConceptText) {
                processSectionContent('tab-content-concept', 'Concept / Key Visual', currentConceptText);
                processedTabIds.add('tab-content-concept');
                foundAnySection = true;
            } else {
                console.warn("Could not inject stored concept text for #tab-content-concept.");
            }

            lines.forEach((line, lineIndex) => {
                const trimmedLine = line.trim();
                let matchedHeader = false;
                let sectionTitleMatch = null;
                let targetTabIdMatch = null;

                if (trimmedLine.startsWith('##')) {
                    for (const title in sectionsToTabs) {
                        const escapedTitle = title.trim().replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&').replace(/\\s\*\\\/\\s\*/, '\\s*\\/?\\s*');
                        const headerRegex = new RegExp(`^##\\s*\\*?\\*?${escapedTitle}\\*?\\*?\\s*$`, 'i');
                        if (headerRegex.test(trimmedLine)) {
                            sectionTitleMatch = title;
                            targetTabIdMatch = sectionsToTabs[title];
                            matchedHeader = true;
                            console.log(`>>> MATCHED Header: ${sectionTitleMatch} -> #${targetTabIdMatch}`);
                            break;
                        }
                    }
                    if (!matchedHeader && trimmedLine.startsWith('##')) {
                        console.warn(`Unrecognized header: "${trimmedLine}"`);
                        unrecognizedHeaders.push(trimmedLine);
                    }
                }

                if (matchedHeader && sectionTitleMatch && targetTabIdMatch) {
                    if (currentSectionKey && currentTargetTabId && contentBuffer.trim()) {
                        if (currentTargetTabId !== 'tab-content-concept') {
                            console.log(`Processing buffered content for: ${currentSectionKey} -> #${currentTargetTabId}`);
                            try {
                                processSectionContent(currentTargetTabId, currentSectionKey, contentBuffer.trim());
                                processedTabIds.add(currentTargetTabId);
                                foundAnySection = true;
                            } catch (processError) {
                                handleProcessingErrorInTab(currentTargetTabId, currentSectionKey, processError);
                                processedTabIds.add(currentTargetTabId);
                            }
                        }
                    }
                    currentSectionKey = sectionTitleMatch;
                    currentTargetTabId = targetTabIdMatch;
                    contentBuffer = '';
                } else if (currentSectionKey && currentTargetTabId) {
                    if (!unrecognizedHeaders.includes(trimmedLine)) {
                         contentBuffer += line + '\n';
                    }
                }
            });

            if (currentSectionKey && currentTargetTabId && contentBuffer.trim()) {
                if (currentTargetTabId !== 'tab-content-concept') {
                    console.log(`Processing final content for: ${currentSectionKey} -> #${currentTargetTabId}`);
                    try {
                        processSectionContent(currentTargetTabId, currentSectionKey, contentBuffer.trim());
                        processedTabIds.add(currentTargetTabId);
                        foundAnySection = true;
                    } catch (processError) {
                        handleProcessingErrorInTab(currentTargetTabId, currentSectionKey, processError);
                        processedTabIds.add(currentTargetTabId);
                    }
                }
            }
            console.log("--- Finished Parsing Details ---");
            console.log("Found any detailed section (incl. concept):", foundAnySection);
            console.log("Processed Tab IDs:", Array.from(processedTabIds));

            Object.keys(tabTitles).forEach(tabId => {
                if (!processedTabIds.has(tabId)) {
                    const contentDiv = document.getElementById(tabId);
                    const sectionTitleKey = Object.keys(sectionsToTabs).find(key => sectionsToTabs[key] === tabId);

                    if (contentDiv && sectionTitleKey && (tabId === 'tab-content-video-demo' || tabId === 'tab-content-album-cover')) {
                        contentDiv.innerHTML = `<p class="placeholder-notice" data-lang-en="Coming soon..." data-lang-es="Próximamente..." data-lang-vi="Sắp ra mắt..." data-lang-ja="近日公開..." data-lang-zhcn="即将推出...">${getTranslatedText(null, 'comingSoonGeneral', false, "Coming soon...")}</p>`;
                        contentDiv.classList.add('placeholder-notice');
                    } else if (contentDiv && sectionTitleKey) {
                        console.warn(`Tab content for "${tabTitles[tabId]}" (#${tabId}) not found/processed. Setting placeholder.`);
                        setPlaceholderForMissingTab(contentDiv, sectionTitleKey);
                    } else if (contentDiv) {
                        console.warn(`Tab content for #${tabId} not found, unknown section key.`);
                        contentDiv.innerHTML = `<p class="placeholder-notice">${getTranslatedText(null, 'placeholderGeneric', false, 'Content unavailable.')}</p>`;
                        contentDiv.classList.add('placeholder-notice');
                    }
                }
            });

            if (!foundAnySection && !currentConceptText ) {
                console.error("Parsing detailed results failed: No sections processed at all.");
                displayError(getTranslatedText(null, 'errorParsingFailed', false, "Could not parse details. The AI's response might be malformed."), 'errorParsingFailed');
            }
        }
        function handleProcessingErrorInTab(targetTabId, sectionKey, error) {
            console.error(`Error processing section "${sectionKey}" for tab #${targetTabId}:`, error);
            const contentDiv = document.getElementById(targetTabId);
            if (contentDiv) {
                contentDiv.innerHTML = `<p class="placeholder-notice error">${getTranslatedText(null, 'errorDisplayingSection', false, 'Error displaying section content.')}</p>`;
                contentDiv.classList.add('placeholder-notice');
            }
        }

        function processSectionContent(targetTabId, sectionTitleKey, content) {
            const contentDiv = document.getElementById(targetTabId);
            if (!contentDiv) { console.error(`Target tab content div #${targetTabId} not found!`); return; }
            contentDiv.innerHTML = '';
            contentDiv.classList.remove('placeholder-notice');
            let sectionHasContent = false;

            try {
                if (targetTabId === 'tab-content-visuals') {
                    const container = document.createElement('div');
                    container.className = 'image-placeholder-container';
                    contentDiv.appendChild(container);

                    const visualDemoRegex = /^\s*[1-9][0-9]*[\.\)\-]\s+([\s\S]*?)(?=(?:\n\s*[1-9][0-9]*[\.\)\-])|(?:\n\s*\*\*Key Images Cohesion:\*\*)|$)/gm;
                    const cohesionRegex = /\*\*Key Images Cohesion:\*\*\s*([\s\S]+)/im;

                    let descs = [];
                    let match;
                    while ((match = visualDemoRegex.exec(content)) !== null) {
                        descs.push(match[1].trim());
                    }

                    if (descs.length > 0) {
                        descs.slice(0, 4).forEach((d, i) => {
                            if (d) {
                                createImagePlaceholder(container, d, `v-${i}`, 'visuals');
                                sectionHasContent = true;
                            }
                        });
                    }

                    const cohesionMatch = content.match(cohesionRegex);
                    if (cohesionMatch && cohesionMatch[1].trim()) {
                        const cohesionP = document.createElement('p');
                        cohesionP.className = 'cohesion-explanation';
                        cohesionP.innerHTML = `<strong>${getTranslatedText(null, 'keyImagesCohesionTitle', false, 'Key Images Cohesion:')}</strong><br>${cohesionMatch[1].trim().replace(/\n/g, '<br>')}`;
                        contentDiv.appendChild(cohesionP);
                        sectionHasContent = true;
                    }

                    if (!sectionHasContent && !(cohesionMatch && cohesionMatch[1].trim())) {
                        container.innerHTML = `<p class="placeholder-notice">${getTranslatedText(null, 'noVisualsFound', false, 'No key image descriptions provided.')}</p>`;
                        container.classList.add('placeholder-notice');
                    }
                    const note = document.createElement('small');
                    note.dataset.langEn = "Illustrative images based on descriptions.";
                    note.dataset.placeholderKey = "visualsNotePlaceholder";
                    note.textContent = getTranslatedText(note, '', false, note.dataset.langEn);
                    contentDiv.appendChild(note);

                } else if (targetTabId === 'tab-content-moodboard') {
                    const descEl = document.createElement('p');
                    descEl.id = 'moodboard-description';
                    contentDiv.appendChild(descEl);
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'image-placeholder-container';
                    imgContainer.id = 'moodboard-images';
                    contentDiv.appendChild(imgContainer);

                    const moodboardOverallDescRegex = /^([\s\S]*?)(?=\n\s*[\*\-]|\n\s*\*\*Moodboard Cohesion:\*\*|$)/m;
                    const moodboardItemsRegex = /^\s*[\*\-]\s+([\s\S]*?)(?=(?:\n\s*[\*\-])|(?:\n\s*\*\*Moodboard Cohesion:\*\*)|$)/gm;
                    const moodboardCohesionRegex = /\*\*Moodboard Cohesion:\*\*\s*([\s\S]+)/im;

                    let mainDesc = '';
                    const overallDescMatch = content.match(moodboardOverallDescRegex);

                    if (overallDescMatch && overallDescMatch[1].trim() && !overallDescMatch[1].trim().startsWith('*') && !overallDescMatch[1].trim().startsWith('-')) {
                         mainDesc = overallDescMatch[1].trim();
                    }

                    let items = [];
                    let itemMatch;
                    moodboardItemsRegex.lastIndex = 0;
                    while ((itemMatch = moodboardItemsRegex.exec(content)) !== null) {
                        items.push(itemMatch[1].trim());
                    }

                    if (mainDesc) {
                        descEl.innerHTML = mainDesc.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                        descEl.style.display = 'block';
                        descEl.classList.remove('placeholder-notice');
                        sectionHasContent = true;
                    } else {
                        descEl.innerHTML = getTranslatedText(null, 'moodboardDescPlaceholder', false, 'Moodboard description missing.');
                        descEl.style.display = 'block';
                        descEl.classList.add('placeholder-notice');
                        descEl.dataset.placeholderKey = "moodboardDescPlaceholder";
                    }

                    if (items.length > 0) {
                        imgContainer.innerHTML = '';
                        imgContainer.classList.remove('placeholder-notice');
                        items.slice(0, 5).forEach((d, i) => {
                            if (d) {
                                createImagePlaceholder(imgContainer, d, `m-${i}`, 'moodboard');
                                sectionHasContent = true;
                            }
                        });
                    } else {
                        imgContainer.innerHTML = `<p class="placeholder-notice" data-placeholder-key="moodboardImgsPlaceholder">${getTranslatedText(null, 'noMoodboardItemsFound', false, 'No moodboard items provided.')}</p>`;
                        imgContainer.classList.add('placeholder-notice');
                    }

                    const cohesionMatch = content.match(moodboardCohesionRegex);
                    if (cohesionMatch && cohesionMatch[1].trim()) {
                        const cohesionP = document.createElement('p');
                        cohesionP.className = 'cohesion-explanation';
                        cohesionP.innerHTML = `<strong>${getTranslatedText(null, 'moodboardCohesionTitle', false, 'Moodboard Cohesion:')}</strong><br>${cohesionMatch[1].trim().replace(/\n/g, '<br>')}`;
                        contentDiv.appendChild(cohesionP);
                        sectionHasContent = true;
                    }

                    if (sectionHasContent) {
                        const note = document.createElement('small');
                        note.dataset.langEn = "Visual styles and elements for inspiration.";
                        note.dataset.placeholderKey = "moodboardNotePlaceholder";
                        note.textContent = getTranslatedText(note, '', false, note.dataset.langEn);
                        contentDiv.appendChild(note);
                    } else if (!mainDesc && items.length === 0 && (!cohesionMatch || !cohesionMatch[1].trim())) {
                        contentDiv.innerHTML = `<p class="placeholder-notice" data-placeholder-key="moodboardDescPlaceholder">${getTranslatedText(null, 'moodboardDescPlaceholder', false, 'Moodboard description missing.')}</p><div class="image-placeholder-container placeholder-notice"><p data-placeholder-key="moodboardImgsPlaceholder">${getTranslatedText(null, 'moodboardImgsPlaceholder', false, 'No moodboard items provided.')}</p></div>`;
                        if (document.querySelector('#tab-content-moodboard .cohesion-explanation')) {
                            document.querySelector('#tab-content-moodboard .cohesion-explanation').remove();
                        }
                        contentDiv.classList.add('placeholder-notice');
                    }


                } else if (targetTabId === 'tab-content-budget') {
                    let container = contentDiv.querySelector('.budget-columns-container');
                    if (!container) { container = document.createElement('div'); container.className = 'budget-columns-container'; contentDiv.appendChild(container); } else { container.innerHTML = ''; }
                    container.classList.remove('placeholder-notice');
                    const budgetRegex = /\*\*(Low\s*Budget|Mid\s*Budget|High\s*Budget)\*\*\s*:?\s*([\s\S]*?)(?=\n?\s*\*\*(?:Low|Mid|High)\s*Budget\*\*|$)/gi;
                    const budgetLevels = {}; let match; let parsingSuccess = false;
                    while ((match = budgetRegex.exec(content)) !== null) {
                        parsingSuccess = true;
                        const levelTitle = match[1].replace(/\s+/g, ' ').trim();
                        const levelKey = levelTitle.split(' ')[0];
                        let rawContent = match[2].trim();
                        let range = ''; let description = '';
                        const rangePatterns = [ /[~\$€£]?\s*[\d,.]+\s*[kKmM]?\b\s*[-–—]\s*[~\$€£]?\s*[\d,.]+\s*[kKmM]?\b(?:\s*USD|EUR|GBP)?/i, /[~\$€£]?\s*[\d,.]+\s*[kKmM]?\b\s*\+(?:\s*USD|EUR|GBP)?/i, /[~\$€£]?\s*[\d,.]+\s*[kKmM]?\b(?:\s*USD|EUR|GBP)?/i ];
                        for (const pattern of rangePatterns) { const rangeMatch = rawContent.match(new RegExp(`^\\s*\\(?(${pattern.source})\\)?\\s*`, 'i')); if (rangeMatch) { range = rangeMatch[1].trim(); description = rawContent.substring(rangeMatch[0].length).trim(); break; } }
                        if (!range) description = rawContent;
                        budgetLevels[levelKey] = { title: levelTitle, range: range, description: description };
                    }
                    const order = ["Low", "Mid", "High"]; let anyColumnHasContent = false;
                    order.forEach(levelKey => {
                        const colDiv = document.createElement('div'); colDiv.className = 'budget-column';
                        const titleH3 = document.createElement('h3'); const descP = document.createElement('p');
                        if (budgetLevels[levelKey]) {
                            const data = budgetLevels[levelKey];
                            titleH3.textContent = data.title + (data.range ? ` (${data.range})` : '');
                            let processedDesc = data.description; let itemBoxesHTML = '';
                            const itemCostRegex = /^\s*[-*]\s*(.+?)\s*[-–—:]\s*([\$\€\£]?\s*[\d,.]+\s*[kKmM]?\b(?:\s*[-–—]\s*[\$\€\£]?\s*[\d,.]+\s*[kKmM]?\b)?(?:\s*USD|\s*EUR|\s*GBP)?)\s*$/gm;
                            processedDesc = processedDesc.replace(itemCostRegex, (matchStr, item, cost) => { itemBoxesHTML += `<div class="budget-item-box">${item.trim()}: <strong>${cost.trim()}</strong></div>`; return ''; }).trim();
                            processedDesc = processedDesc.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                            descP.innerHTML = processedDesc + itemBoxesHTML;
                            if(descP.innerHTML.trim() === ''){ descP.innerHTML = `(${getTranslatedText(null, 'budgetDetailsMissing', false, 'Details missing')})`; descP.classList.add('placeholder-notice'); } else { anyColumnHasContent = true; }
                        } else {
                            titleH3.textContent = getTranslatedText(null, `budget${levelKey}Title`, false, `${levelKey} Budget`); descP.textContent = `(${getTranslatedText(null, 'budgetDetailsMissing', false, `Details missing.`)})`; descP.classList.add('placeholder-notice'); colDiv.classList.add('placeholder-notice');
                        }
                        colDiv.appendChild(titleH3); colDiv.appendChild(descP); container.appendChild(colDiv);
                    });
                    if (!parsingSuccess && content.trim()) { container.innerHTML = `<div class="raw-budget-output"><pre>${content}</pre></div>`; container.classList.add('placeholder-notice'); console.warn("Budget parsing failed, raw display."); }
                    else if (!anyColumnHasContent && !parsingSuccess) { container.innerHTML = `<p class="placeholder-notice">${getTranslatedText(null, 'noBudgetContentFound', false, 'No budget details provided.')}</p>`; container.classList.add('placeholder-notice');}
                    else { sectionHasContent = true; }
                    let note = contentDiv.querySelector('small'); if (!note) { note = document.createElement('small'); note.dataset.langEn = "Note: Budgets are conceptual estimates..."; note.dataset.placeholderKey="budgetNotePlaceholder"; contentDiv.appendChild(note); }
                    note.textContent = getTranslatedText(note, '', false, note.dataset.langEn);

                } else if (targetTabId === 'tab-content-requirements') {
                    const listEl = document.createElement('ul'); contentDiv.appendChild(listEl);
                    const items = content.trim().split(/^\s*[\*\-]\s+/gm).filter(Boolean).map(item => item.trim().replace(/\n$/, ''));
                    if (items.length > 0) { items.forEach(item => { const li = document.createElement('li'); li.innerHTML = item.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); listEl.appendChild(li); }); sectionHasContent = true; }
                    else { listEl.innerHTML = `<li class="placeholder-notice" data-placeholder-key="requirementsPlaceholder">${getTranslatedText(null, 'noRequirementsFound', false, 'No requirements listed.')}</li>`; listEl.classList.add('placeholder-notice'); }

                } else if (targetTabId === 'tab-content-fonts') {
                    const suggestionDiv = document.createElement('div'); suggestionDiv.className = 'font-suggestion';
                    const combinationMatch = content.match(/\*\*Font Combination:\*\*\s*(.*?)(?:\s*&\s*(.*?))?\s*$/im);
                    const reasonMatch = content.match(/\*Reason:\*\s*([\s\S]*?)(?=\n\s*\*Sample|\n\s*$)/i);
                    const sampleTitleMatch = content.match(/\*Sample Title(?: \(Using Font 1\))?:\*\s*"(.*?)"/i);
                    const sampleBodyMatch = content.match(/\*Sample Body(?: \(Using Font 2\))?:\*\s*"(.*?)"/i);
                    if (combinationMatch && reasonMatch && sampleTitleMatch) {
                        sectionHasContent = true;
                        const font1 = combinationMatch[1]?.trim(); const font2 = combinationMatch[2]?.trim();
                        const reason = reasonMatch[1]?.trim(); const sampleTitle = sampleTitleMatch[1]?.trim(); const sampleBody = sampleBodyMatch?.[1]?.trim();
                        const comboH3 = document.createElement('h3'); comboH3.textContent = font1 + (font2 ? ` & ${font2}` : ''); suggestionDiv.appendChild(comboH3);
                        const reasonP = document.createElement('p'); reasonP.className = 'font-reason'; reasonP.innerHTML = reason.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); suggestionDiv.appendChild(reasonP);
                        const sampleTitleDiv = document.createElement('div'); sampleTitleDiv.className = 'font-sample'; sampleTitleDiv.style.fontFamily = `'${font1}', ${fontFamilyFallback(font1)}`; sampleTitleDiv.innerHTML = `<strong>${getTranslatedText(null, 'fontSampleTitleLabel', false, 'Title:')}</strong> "${sampleTitle}"`; suggestionDiv.appendChild(sampleTitleDiv);
                        if (font2 && sampleBody) { const sampleBodyDiv = document.createElement('div'); sampleBodyDiv.className = 'font-sample'; sampleBodyDiv.style.fontFamily = `'${font2}', ${fontFamilyFallback(font2)}`; sampleBodyDiv.innerHTML = `<strong>${getTranslatedText(null, 'fontSampleBodyLabel', false, 'Body:')}</strong> "${sampleBody}"`; suggestionDiv.appendChild(sampleBodyDiv); }
                        contentDiv.appendChild(suggestionDiv);
                    } else { console.warn("Font parsing failed."); }
                    if (!sectionHasContent) { contentDiv.innerHTML = `<p class="placeholder-notice" data-placeholder-key="fontsPlaceholder">${getTranslatedText(null, 'noFontsFound', false, 'No font suggestions provided.')}</p>`; contentDiv.classList.add('placeholder-notice'); }

                } else if (targetTabId === 'tab-content-palette') {
                    const container = document.createElement('div'); container.className = 'color-palette-display'; contentDiv.appendChild(container);
                    sectionHasContent = createColorSwatches(container, content.trim());
                    if (!sectionHasContent) { container.innerHTML = `<p class="placeholder-notice" data-placeholder-key="palettePlaceholder">${getTranslatedText(null, 'noColorsFound', false, 'No color palette provided.')}</p>`; container.classList.add('placeholder-notice'); }

                } else if (targetTabId === 'tab-content-concept') {
                    const pEl = document.createElement('p'); pEl.style.whiteSpace = 'pre-wrap';
                    const processedContent = content.trim().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    pEl.innerHTML = processedContent; contentDiv.appendChild(pEl);
                    if (processedContent) sectionHasContent = true;

                } else if (targetTabId === 'tab-content-video-demo' || targetTabId === 'tab-content-album-cover') {
                    contentDiv.innerHTML = `<p class="placeholder-notice" data-lang-en="Coming soon..." data-lang-es="Próximamente..." data-lang-vi="Sắp ra mắt..." data-lang-ja="近日公開..." data-lang-zhcn="即将推出...">${getTranslatedText(null, 'comingSoonGeneral', false, "Coming soon...")}</p>`;
                    contentDiv.classList.add('placeholder-notice');
                    sectionHasContent = true;

                } else {
                    console.warn(`No specific handler for tab ${targetTabId}, using default paragraph.`);
                    const pEl = document.createElement('p');
                    const processedContent = content.trim().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    pEl.innerHTML = processedContent; contentDiv.appendChild(pEl);
                    if (processedContent) sectionHasContent = true;
                }
                if (!sectionHasContent && contentDiv.innerHTML.trim() === '') {
                    console.warn(`Section "${sectionTitleKey}" processed but resulted in empty content for tab #${targetTabId}.`);
                    setPlaceholderForMissingTab(contentDiv, sectionTitleKey);
                }
            } catch (error) {
                handleProcessingErrorInTab(targetTabId, sectionTitleKey, error);
            }
        }

        function fontFamilyFallback(fontName = '') { const lower = fontName.toLowerCase(); if (lower.includes('serif') || lower.includes('playfair') || lower.includes('lora')) return 'serif'; if (lower.includes('mono') || lower.includes('courier')) return 'monospace'; if (lower.includes('script') || lower.includes('cursive')) return 'cursive'; if (lower.includes('display') || lower.includes('oswald')) return 'sans-serif'; return 'sans-serif'; }

         function setPlaceholderForMissingTab(contentDiv, sectionTitleKey) { if (!contentDiv) return; contentDiv.innerHTML = ''; contentDiv.classList.add('placeholder-notice'); const targetTabId = sectionsToTabs[sectionTitleKey] || ''; let placeholderKey = 'placeholderGeneric', fallbackText = 'Missing content.', placeholderHTML = ''; switch (targetTabId) { case 'tab-content-requirements': placeholderKey = 'requirementsPlaceholder'; fallbackText = 'Requirements list...'; placeholderHTML = `<ul class="placeholder-notice"><li class="placeholder-notice" data-placeholder-key="${placeholderKey}">${getTranslatedText(null, placeholderKey, false, fallbackText)}</li></ul>`; break; case 'tab-content-budget': placeholderKey = 'budgetPlaceholder'; fallbackText = 'Budget details...'; const noteText = getTranslatedText(null, 'budgetNotePlaceholder', false, 'Note: Budgets are estimates...'); placeholderHTML = `<div class="budget-columns-container placeholder-notice">`; ["Low", "Mid", "High"].forEach(levelKey => { placeholderHTML += `<div class="budget-column placeholder-notice"><h3>${getTranslatedText(null, `budget${levelKey}Title`, false, `${levelKey} Budget`)}</h3><p class="placeholder-notice" data-placeholder-key="budgetDetailsMissing">(${getTranslatedText(null, 'budgetDetailsMissing', false, `Details missing.`)})</p></div>`; }); placeholderHTML += `</div><small data-placeholder-key="budgetNotePlaceholder">${noteText}</small>`; break; case 'tab-content-visuals': placeholderKey = 'visualsPlaceholder'; fallbackText = 'Visual descriptions...'; const visualsNote = getTranslatedText(null, 'visualsNotePlaceholder', false,'Illustrative images...'); placeholderHTML = `<div class="image-placeholder-container placeholder-notice"><p data-placeholder-key="${placeholderKey}">${getTranslatedText(null, placeholderKey, false, fallbackText)}</p></div><small data-placeholder-key="visualsNotePlaceholder">${visualsNote}</small>`; break; case 'tab-content-moodboard': const moodDesc = getTranslatedText(null, 'moodboardDescPlaceholder', false, 'Moodboard description...'); const moodImgs = getTranslatedText(null, 'moodboardImgsPlaceholder', false, 'Moodboard images...'); const moodNote = getTranslatedText(null, 'moodboardNotePlaceholder', false,'Visual styles...'); placeholderHTML = `<p data-placeholder-key="moodboardDescPlaceholder" id="moodboard-description" class="placeholder-notice">${moodDesc}</p><div class="image-placeholder-container placeholder-notice" id="moodboard-images"><p data-placeholder-key="moodboardImgsPlaceholder">${moodImgs}</p></div><small data-placeholder-key="moodboardNotePlaceholder">${moodNote}</small>`; break; case 'tab-content-fonts': placeholderKey = 'fontsPlaceholder'; fallbackText = 'Font suggestions...'; placeholderHTML = `<p data-placeholder-key="${placeholderKey}" class="placeholder-notice">${getTranslatedText(null, placeholderKey, false, fallbackText)}</p>`; break; case 'tab-content-palette': placeholderKey = 'palettePlaceholder'; fallbackText = 'Color palette...'; placeholderHTML = `<div class="color-palette-display placeholder-notice"><p data-placeholder-key="${placeholderKey}">${getTranslatedText(null, placeholderKey, false, fallbackText)}</p></div>`; break; case 'tab-content-concept': placeholderKey = 'conceptPlaceholder'; fallbackText = 'Concept description...'; placeholderHTML = `<p data-placeholder-key="${placeholderKey}" class="placeholder-notice" style="white-space: pre-wrap;">${getTranslatedText(null, placeholderKey, false, fallbackText)}</p>`; break; case 'tab-content-video-demo': case 'tab-content-album-cover': placeholderKey = 'comingSoonGeneral'; fallbackText = 'Coming soon...'; placeholderHTML = `<p class="placeholder-notice" data-lang-en="Coming soon..." data-lang-es="Próximamente..." data-lang-vi="Sắp ra mắt..." data-lang-ja="近日公開..." data-lang-zhcn="即将推出...">${getTranslatedText(null, placeholderKey, false, fallbackText)}</p>`; break; default: placeholderHTML = `<p class="placeholder-notice" data-placeholder-key="${placeholderKey}">${getTranslatedText(null, placeholderKey, false, fallbackText)}</p>`; } contentDiv.innerHTML = placeholderHTML; }

        async function createImagePlaceholder(container, description, seedSuffix, tabType) { const figure = document.createElement('figure'); figure.className = 'image-placeholder'; figure.dataset.seedSuffix = seedSuffix; const img = document.createElement('img'); img.alt = `Loading...`; img.src = ''; img.loading = 'lazy'; let phHeight = (tabType === 'moodboard') ? 130 : 160; img.style.cssText = `height: ${phHeight}px; width: 100%; object-fit: cover; background-color: #444; border-bottom: 1px solid var(--border-color);`; const figcaption = document.createElement('figcaption'); figcaption.innerHTML = description.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); figure.appendChild(img); figure.appendChild(figcaption); container.appendChild(figure); container.classList.remove('placeholder-notice'); const promptForApi = description.replace(/<[^>]*>/g, '').replace(/\n/g, ' ').replace(/\s+/g, ' ').trim(); const storedImage = storedPageData.feature?.imagePlaceholders?.find(imgData => imgData.seedSuffix === seedSuffix); if (storedImage && storedImage.src && storedImage.src !== '' && !storedImage.src.startsWith('data:')) { console.log(`Restoring image for ${seedSuffix} from stored data:`, storedImage.src); img.src = storedImage.src; img.alt = storedImage.alt || promptForApi; if (storedImage.figcaptionHTML) { figcaption.innerHTML = storedImage.figcaptionHTML; } img.onload = () => { img.style.backgroundColor = 'transparent'; }; img.onerror = () => { console.warn(`Failed to load stored image for ${seedSuffix}: ${storedImage.src}. Attempting fallback.`); setFallbackImage(img, figcaption, description, seedSuffix, 'stored-img-load-err', phHeight); }; return; } if (!promptForApi) { setFallbackImage(img, figcaption, description, seedSuffix, 'empty-prompt', phHeight); return; } const BACKEND_API_URL = '/api/generate-image'; try { await new Promise(resolve => setTimeout(resolve, 50)); const response = await fetch(BACKEND_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ description: promptForApi }) }); const responseData = await response.json(); if (!response.ok) { const errorDetail = responseData?.error || `Backend Error: ${response.status}`; console.error("Backend proxy error:", errorDetail); displayError(`${getTranslatedText(null, 'errorBackendProxy', false, 'Img Gen Err:')} ${errorDetail}`, 'errorBackendProxy'); setFallbackImage(img, figcaption, description, seedSuffix, `backend-err-${response.status}`, phHeight); return; } if (responseData.imageUrl?.startsWith('http')) { img.onload = () => { img.style.backgroundColor = 'transparent'; }; img.onerror = () => { setFallbackImage(img, figcaption, description, seedSuffix, 'backend-img-load-err', phHeight); }; img.src = responseData.imageUrl; img.alt = promptForApi; if (!storedPageData.feature.imagePlaceholders) { storedPageData.feature.imagePlaceholders = []; } storedPageData.feature.imagePlaceholders = storedPageData.feature.imagePlaceholders.filter( item => item.seedSuffix !== seedSuffix ); storedPageData.feature.imagePlaceholders.push({ seedSuffix: seedSuffix, tabId: tabType, src: responseData.imageUrl, alt: promptForApi, figcaptionHTML: figcaption.innerHTML }); } else { setFallbackImage(img, figcaption, description, seedSuffix, 'backend-invalid-url', phHeight); } } catch (error) { console.error("Error fetching from Backend Proxy:", error); let reason = 'backend-fetch-error'; let userMsgKey = 'errorBackendFetch'; if (error instanceof TypeError) reason = 'backend-network'; displayError(getTranslatedText(null, userMsgKey, false, 'Network error contacting server for image gen.'), reason); setFallbackImage(img, figcaption, description, seedSuffix, reason, phHeight); } }

        function setFallbackImage(imgEl, figcaptionEl, desc, seed, reason, height) { console.warn(`Setting fallback. Reason: ${reason}`); const seedEnc = encodeURIComponent(desc.substring(0, 15) + seed + '-' + reason); const picSumH = Math.max(150, Math.round(height * 1.5)); const picSumW = Math.round(picSumH * 1.6); imgEl.onload = () => { imgEl.style.backgroundColor = 'transparent'; }; imgEl.onerror = () => { imgEl.style.backgroundColor = '#555'; imgEl.alt = `Fallback failed (${reason})` }; imgEl.src = `https://picsum.photos/seed/${seedEnc}/${picSumW}/${picSumH}.webp`; imgEl.alt = `Placeholder: ${desc.substring(0, 50)}... (${reason})`; figcaptionEl.querySelector('.generation-source')?.remove(); figcaptionEl.querySelector('.fallback-notice')?.remove(); const notice = document.createElement('span'); notice.className = 'fallback-notice'; notice.textContent = `(${getTranslatedText(null, 'placeholderReason', false, 'Placeholder')}: ${reason})`; figcaptionEl.appendChild(notice); }

         function createColorSwatches(container, text) { if (!container) return false; container.innerHTML = ''; container.classList.remove('placeholder-notice'); let foundColors = false; let swatchIndex = 0; const lines = text.trim().split('\n'); lines.forEach(line => { const colorRegex = /^(Dominant\s+)?([\w\s\-\/()]+?)\s*\(?\s*(#[0-9a-fA-F]{6}|#[0-9a-fA-F]{3})\s*\)?\s*-\s*Application:\s*(.*)$/i; const match = line.trim().match(colorRegex); if (match) { const isDominant = !!match[1]; let name = match[2].trim(); let hex = match[3].trim().toUpperCase(); const application = match[4].trim(); if (!name || name.length < 2) return; if (hex.length === 4) hex = '#' + hex[1].repeat(2) + hex[2].repeat(2) + hex[3].repeat(2); if (!/^#[0-9A-F]{6}$/.test(hex)) { console.warn(`Invalid hex: ${match[3]}`); return; } foundColors = true; const swatch = document.createElement('div'); swatch.className = 'color-swatch'; if (isDominant) swatch.classList.add('dominant-swatch'); const colorBlock = document.createElement('div'); colorBlock.className = 'color-block'; try { colorBlock.style.backgroundColor = hex; colorBlock.style.color = isColorDarkGuess(hex) ? 'var(--text-primary)' : 'var(--bg-dark)'; } catch (e) { console.warn(`Invalid color ${hex}`); return; } const hexSpan = document.createElement('span'); hexSpan.className = 'hex-code'; hexSpan.textContent = hex; colorBlock.appendChild(hexSpan); const infoDiv = document.createElement('div'); infoDiv.className = 'color-info'; const nameSpan = document.createElement('span'); nameSpan.className = 'color-name'; nameSpan.textContent = name; infoDiv.appendChild(nameSpan); const appP = document.createElement('p'); appP.className = 'color-application'; appP.innerHTML = application.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); infoDiv.appendChild(appP); swatch.appendChild(colorBlock); swatch.appendChild(infoDiv); container.appendChild(swatch); requestAnimationFrame(() => setTimeout(() => swatch.classList.add('visible'), 50 + swatchIndex * 70)); swatchIndex++; } else if (line.trim()) { console.warn("Could not parse color line:", line); } }); return foundColors; }

        function isColorDarkGuess(hexColor) { try { if (!hexColor?.startsWith('#')) return false; let hex = hexColor.substring(1); if (hex.length === 3) hex = hex[0].repeat(2) + hex[1].repeat(2) + hex[2].repeat(2); if (hex.length !== 6) return false; const r = parseInt(hex.substring(0, 2), 16); const g = parseInt(hex.substring(2, 4), 16); const b = parseInt(hex.substring(4, 6), 16); return (0.299 * r + 0.587 * g + 0.114 * b) / 255 < 0.5; } catch (e) { return false; } }

        function clearTabContents() { if (!tabContents) return; tabContents.forEach(tab => { const tabId = tab.id; const sectionTitleKey = Object.keys(sectionsToTabs).find(key => sectionsToTabs[key] === tabId); if (sectionTitleKey) setPlaceholderForMissingTab(tab, sectionTitleKey); else { tab.innerHTML = `<p class="placeholder-notice">${getTranslatedText(null, 'placeholderGeneric', false, 'Cleared.')}</p>`; tab.classList.add('placeholder-notice'); } }); resultsTabsContainer?.querySelectorAll('.tab-link.active').forEach(link => link.classList.remove('active')); tabContentArea?.querySelectorAll('.tab-content.active').forEach(content => content.classList.remove('active')); }
        function clearErrors() { errorMessageDiv.style.display = 'none'; errorMessageDiv.textContent = ''; errorMessageDiv.removeAttribute('data-error-key'); }
        function resetGeneratePageUI() { clearTabContents(); conceptTextOutput.textContent = getTranslatedText(null, 'conceptPlaceholder', false, 'Concept text will appear here...'); conceptTextOutput.classList.add('placeholder-notice'); currentConceptText = ''; currentDetailedResultsText = ''; currentInputs = null; if (storedPageData.feature) { storedPageData.feature.imagePlaceholders = []; } else { storedPageData.feature = { imagePlaceholders: [] }; } if (isTextDownloadModeActive) toggleTextDownloadMode(false);
             updateGeneratePageUI('initial'); console.log("Reset Generate Page UI to initial state."); }
        function updateGeneratePageUI(newState) { generateStep = newState; console.log("Updating Generate UI State:", newState); if (initialPrompt) initialPrompt.style.display = (newState === 'initial') ? 'flex' : 'none'; if (conceptDisplayArea) conceptDisplayArea.style.display = (newState === 'concept_shown') ? 'flex' : 'none'; if (tabbedResultsArea) tabbedResultsArea.style.display = (newState === 'details_shown') ? 'flex' : 'none'; if (downloadActionArea) downloadActionArea.style.display = (newState === 'details_shown') ? 'flex' : 'none'; if(generateConceptButton) generateConceptButton.disabled = (newState === 'loading'); if(pickConceptButton) pickConceptButton.disabled = (newState !== 'concept_shown'); if(regenerateConceptButtonAlt) regenerateConceptButtonAlt.disabled = (newState !== 'concept_shown');
            const detailsShown = (newState === 'details_shown');
            if(prepareTextDownloadButton) prepareTextDownloadButton.disabled = !detailsShown;
            if(downloadAllImagesButton) downloadAllImagesButton.disabled = !detailsShown;
            if (newState !== 'details_shown' && isTextDownloadModeActive) {
                toggleTextDownloadMode(false);
            }
            updateFinalizeButtonState();
            if (newState === 'details_shown') { const firstTabLink = resultsTabsContainer?.querySelector('.tab-link'); if (firstTabLink && !resultsTabsContainer?.querySelector('.tab-link.active')) { activateTab(firstTabLink); } } }
        function activateTab(tabLinkElement) { if (!tabLinkElement || !tabContents) return;
            if (isTextDownloadModeActive) {
                const targetTabId = tabLinkElement.dataset.tabTarget;
                if (tabTargetToSectionKey[targetTabId]) {
                    tabLinkElement.classList.toggle('selected-for-download');
                    updateFinalizeButtonState();
                } else {
                    console.log(`Tab ${targetTabId} is not selectable for text download.`);
                }
                return;
            }

            const targetId = tabLinkElement.dataset.tabTarget;
            const targetContent = document.getElementById(targetId);
            tabLinks.forEach(link => link.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            tabLinkElement.classList.add('active');
            if (targetContent) {
                targetContent.classList.add('active');
            } else {
                console.error(`Target content #${targetId} not found for tab.`);
            }
        }
        function displayError(message, errorKey = 'errorUnknown') { message = String(message || getTranslatedText(null, errorKey, false, 'Unknown error.')); errorMessageDiv.textContent = message; errorMessageDiv.dataset.errorKey = errorKey; errorMessageDiv.style.display = 'block'; hideLoading(); console.error("Displayed error:", message, `(Key: ${errorKey})`); if (outputArea?.contains(errorMessageDiv)) { errorMessageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }

        const internalTranslations = {
             fontSampleTitleLabel: { en: "Title:", es: "Título:", vi: "Tiêu đề:", ja: "タイトル：", zhcn: "标题：" },
             fontSampleBodyLabel: { en: "Body:", es: "Cuerpo:", vi: "Nội dung:", ja: "本文：", zhcn: "正文：" },
             fontsPlaceholder: { en: "Font suggestions...", es: "Sugerencias de fuentes...", vi: "Gợi ý phông chữ...", ja: "フォントの提案...", zhcn: "字体建议..." },
             noFontsFound: { en: "No font suggestions.", es: "No sugerencias de fuentes.", vi: "Không có gợi ý phông chữ.", ja: "フォントの提案なし。", zhcn: "无字体建议。" },
             errorParsingFailed: { en: "Parse error. AI response format incorrect?", es: "Error de análisis. ¿Formato IA incorrecto?", vi: "Lỗi phân tích. Định dạng AI sai?", ja: "解析エラー。AI形式不正？", zhcn: "解析错误。AI 格式不正确？" },
             generatedViaBackend: { en: "Gen. via Server", es: "Gen. vía Servidor", vi: "Tạo bởi Máy chủ", ja: "サーバー生成", zhcn: "服务器生成" },
             placeholderReason: { en: "Placeholder", es: "Marcador", vi: "Giữ chỗ", ja: "プレースホルダ", zhcn: "占位符" },
             errorBackendProxy: { en: "Img Gen Error:", es: "Error Gen Imagen:", vi: "Lỗi Tạo ảnh:", ja: "画像生成エラー：", zhcn: "图像生成错误：" },
             errorBackendFetch: { en: "Network error fetching image.", es: "Error de red al obtener imagen.", vi: "Lỗi mạng lấy ảnh.", ja: "画像取得ネットワークエラー。", zhcn: "获取图像网络错误。" },
             errorCorsOrNetwork: { en: "Network/CORS error calling API.", es: "Error Red/CORS llamando API.", vi: "Lỗi Mạng/CORS gọi API.", ja: "APIネットワーク/CORSエラー。", zhcn: "API 网络/CORS 错误。" },
             validationLyricsMissing: { en: "Provide/generate lyrics.", es: "Proporciona/genera letra.", vi: "Cung cấp/tạo lời.", ja: "歌詞を提供/生成。", zhcn: "提供/生成歌词。" },
             validationKeywordsMissing: { en: "Provide keywords.", es: "Proporciona palabras clave.", vi: "Cung cấp từ khóa.", ja: "キーワード提供。", zhcn: "提供关键词。" },
             validationGenreMissing: { en: "Select genre.", es: "Selecciona género.", vi: "Chọn thể loại.", ja: "ジャンル選択。", zhcn: "选择流派。" },
             errorApiKeyInvalid: { en: "API Key invalid/missing.", es: "Clave API inválida/faltante.", vi: "Khóa API sai/thiếu.", ja: "APIキー不正/欠落。", zhcn: "API 密钥无效/丢失。" },
             errorApiHttp: { en: "API fail: ${errorDetail}", es: "Fallo API: ${errorDetail}", vi: "API thất bại: ${errorDetail}", ja: "API失敗：${errorDetail}", zhcn: "API 失败：${errorDetail}" },
             errorApiBlocked: { en: "Blocked by safety (Reason: ${reason}).", es: "Bloqueado por seguridad (Razón: ${reason}).", vi: "Bị chặn an toàn (Lý do: ${reason}).", ja: "安全ブロック（理由：${reason}）。", zhcn: "安全阻止（原因：${reason}）。" },
             errorApiGeneral: { en: "API Error: ${errorMessage}", es: "Error API: ${errorMessage}", vi: "Lỗi API: ${errorMessage}", ja: "APIエラー：${errorMessage}", zhcn: "API 错误：${errorMessage}" },
             errorApiNoCandidate: { en: "No API response candidate.", es: "Sin candidato API.", vi: "Không có phản hồi API.", ja: "API応答候補なし。", zhcn: "无 API 响应候选项。" },
             errorApiEmptyResponse: { en: "Empty AI response.", es: "Respuesta IA vacía.", vi: "Phản hồi AI trống.", ja: "AI応答空。", zhcn: "AI 响应为空。" },
             statusRequestingMic: { en: "Requesting mic...", es: "Solicitando micro...", vi: "Yêu cầu mic...", ja: "マイク要求中...", zhcn: "请求麦克风..." },
             statusRecording: { en: "Recording...", es: "Grabando...", vi: "Đang ghi...", ja: "録音中...", zhcn: "录音中..." },
             statusTranscribing: { en: "Transcribing...", es: "Transcribiendo...", vi: "Chuyển ghi...", ja: "文字起こし中...", zhcn: "转录中..." },
             statusStopping: { en: "Stopping...", es: "Deteniendo...", vi: "Đang dừng...", ja: "停止中...", zhcn: "停止中..." },
             stoppedStatus: { en: "Stopped.", es: "Detenido.", vi: "Đã dừng.", ja: "停止。", zhcn: "已停止。" },
             recordTranscriptComplete: { en: "Rec & transcript done.", es: "Grab. y transcr. listo.", vi: "Ghi & bản ghi xong.", ja: "録音・文字起こし完了。", zhcn: "录音转录完成。" },
             recordCompleteNoTranscript: { en: "Rec done (no transcript).", es: "Grab. lista (sin transcr.).", vi: "Ghi xong (ko bản ghi).", ja: "録音完了（文字起こし無）。", zhcn: "录音完成（无转录）。" },
             transcriptCompleteNoRecord: { en: "Transcript done (no rec).", es: "Transcr. lista (sin grab.).", vi: "Bản ghi xong (ko ghi).", ja: "文字起こし完了（録音無）。", zhcn: "转录完成（无录音）。" },
             statusFileSelected: { en: "File selected.", es: "Archivo seleccionado.", vi: "Đã chọn tệp.", ja: "ファイル選択済。", zhcn: "文件已选。" },
             statusAudioNotSupported: { en: "Audio recording unsupported.", es: "Grabación audio no soportada.", vi: "Ghi âm không hỗ trợ.", ja: "録音非対応。", zhcn: "不支持录音。" },
             statusSpeechRecNotSupported: { en: "Speech recognition unsupported.", es: "Reconoc. voz no soportado.", vi: "Nhận dạng giọng nói không hỗ trợ.", ja: "音声認識非対応。", zhcn: "不支持语音识别。" },
             micErrorGeneric: { en: "Mic access error.", es: "Error acceso micro.", vi: "Lỗi truy cập mic.", ja: "マイクアクセスエラー。", zhcn: "麦克风错误。" },
             micErrorPermission: { en: "Mic permission denied.", es: "Permiso micro denegado.", vi: "Quyền mic bị từ chối.", ja: "マイク許可拒否。", zhcn: "麦克风权限拒绝。" },
             micErrorNotFound: { en: "No mic found.", es: "No se encontró micro.", vi: "Không tìm thấy mic.", ja: "マイク未検出。", zhcn: "未找到麦克风。" },
             micErrorHardware: { en: "Mic hardware error.", es: "Error hardware micro.", vi: "Lỗi phần cứng mic.", ja: "マイクHWエラー。", zhcn: "麦克风硬件错误。" },
             statusRecordingError: { en: "Rec. error: ${errorName}", es: "Error grab.: ${errorName}", vi: "Lỗi ghi: ${errorName}", ja: "録音エラー：${errorName}", zhcn: "录音错误：${errorName}" },
             transcriptionErrorGeneric: { en: "Transcr. error: ${errorParam}", es: "Error transcr.: ${errorParam}", vi: "Lỗi chuyển ghi: ${errorParam}", ja: "文字起こしエラー：${errorParam}", zhcn: "转录错误：${errorParam}" },
             transcriptionErrorNoSpeech: { en: "No speech detected.", es: "No se detectó habla.", vi: "Không phát hiện giọng nói.", ja: "音声未検出。", zhcn: "未检测到语音。" },
             transcriptionErrorMicProblem: { en: "Transcr. failed (mic issue?).", es: "Fallo transcr. (¿micro?).", vi: "Chuyển ghi thất bại (lỗi mic?).", ja: "文字起こし失敗（マイク？）。", zhcn: "转录失败（麦克风问题？）。" },
             transcriptionErrorPermission: { en: "Transcr. needs mic permission.", es: "Transcr. necesita permiso micro.", vi: "Chuyển ghi cần quyền mic.", ja: "文字起こしマイク許可要。", zhcn: "转录需麦克风权限。" },
             transcriptionErrorNetwork: { en: "Transcr. network error.", es: "Error red transcr.", vi: "Lỗi mạng chuyển ghi.", ja: "文字起こしNWエラー。", zhcn: "转录网络错误。" },
             budgetLowTitle: { en: "Low Budget", es: "Bajo Presupuesto", vi: "Ngân sách thấp", ja: "低予算", zhcn:"低预算"},
             budgetMidTitle: { en: "Mid Budget", es: "Presupuesto Medio", vi: "Ngân sách trung bình", ja: "中予算", zhcn:"中预算"},
             budgetHighTitle: { en: "High Budget", es: "Alto Presupuesto", vi: "Ngân sách cao", ja: "高予算", zhcn:"高预算"},
             budgetDetailsMissing: { en: "Details missing.", es: "Detalles faltantes.", vi: "Thiếu chi tiết.", ja: "詳細なし。", zhcn:"缺细节。"},
             noVisualsFound: { en: "No visuals.", es: "No visuales.", vi: "Không hình ảnh.", ja: "ビジュアルなし。", zhcn:"无视觉。"},
             noMoodboardItemsFound: { en: "No moodboard items.", es: "No elementos moodboard.", vi: "Không mục moodboard.", ja: "ムードボード項目なし。", zhcn:"无情绪板项目。"},
             noBudgetContentFound: { en: "No budget details.", es: "No detalles presupuesto.", vi: "Không chi tiết ngân sách.", ja: "予算詳細なし。", zhcn:"无预算细节。"},
             noRequirementsFound: { en: "No requirements.", es: "No requisitos.", vi: "Không yêu cầu.", ja: "要件なし。", zhcn:"无要求。"},
             noColorsFound: { en: "No colors.", es: "No colores.", vi: "Không màu sắc.", ja: "色なし。", zhcn:"无颜色。"},
             placeholderGeneric: { en: "Content unavailable.", es: "Contenido no disponible.", vi: "Nội dung không có.", ja: "内容利用不可。", zhcn:"内容不可用。"},
             errorDisplayingSection: { en: "Error displaying section.", es: "Error mostrando sección.", vi: "Lỗi hiển thị phần.", ja: "セクション表示エラー。", zhcn:"显示部分错误。"},
             errorExploreNoConcept: { en: "Generate concept first.", es: "Genera concepto primero.", vi: "Tạo ý tưởng trước.", ja: "まずコンセプト生成。", zhcn:"先生成概念。"},
             generatingConcept: { en: "Generating Concept...", es: "Generando Concepto...", vi: "Đang tạo ý tưởng...", ja: "コンセプト生成中...", zhcn:"生成概念中..."},
             fetchingDetails: { en: "Fetching Details...", es: "Obteniendo Detalles...", vi: "Lấy chi tiết...", ja: "詳細取得中...", zhcn:"获取细节中..."},
             generatingCreativeSparks: { en: "Generating sparks...", es: "Generando chispas...", vi: "Tạo tia sáng...", ja: "火花生成中...", zhcn:"生成火花中..."},
             conceptPlaceholder: { en: "Concept appears here...", es: "Concepto aquí...", vi: "Ý tưởng ở đây...", ja: "コンセプト表示...", zhcn: "概念在此显示..." },
             requirementsPlaceholder: { en: "Requirements list...", es: "Lista requisitos...", vi: "Danh sách yêu cầu...", ja: "要件リスト...", zhcn: "要求列表..." },
             budgetPlaceholder: { en: "Budget details...", es: "Detalles presupuesto...", vi: "Chi tiết ngân sách...", ja: "予算詳細...", zhcn: "预算细节..." },
             budgetNotePlaceholder: { en: "Note: Budgets are estimates...", es: "Nota: Presupuestos estimados...", vi: "Lưu ý: Ngân sách ước tính...", ja: "注：予算は見積もり...", zhcn: "注：预算为估算..." },
             visualsPlaceholder: { en: "Visual descriptions...", es: "Descripciones visuales...", vi: "Mô tả hình ảnh...", ja: "ビジュアル説明...", zhcn: "视觉描述..." },
             visualsNotePlaceholder: { en: "Illustrative images.", es: "Imágenes ilustrativas.", vi: "Ảnh minh họa.", ja: "説明画像。", zhcn: "说明图片。" },
             moodboardDescPlaceholder: { en: "Moodboard description...", es: "Descripción moodboard...", vi: "Mô tả moodboard...", ja: "ムードボード説明...", zhcn: "情绪板描述..." },
             moodboardImgsPlaceholder: { en: "Moodboard images...", es: "Imágenes moodboard...", vi: "Ảnh moodboard...", ja: "ムードボード画像...", zhcn: "情绪板图片..." },
             moodboardNotePlaceholder: { en: "Visuals for inspiration.", es: "Visuales para inspiración.", vi: "Hình ảnh cảm hứng.", ja: "インスピリレーション用ビジュアル。", zhcn: "灵感视觉。" },
             palettePlaceholder: { en: "Color palette...", es: "Paleta colores...", vi: "Bảng màu...", ja: "カラーパレット...", zhcn: "调色板..." },
             preparingDownload: { en: "Preparing Download...", es: "Preparando Descarga...", vi: "Chuẩn bị Tải xuống...", ja: "ダウンロード準備中...", zhcn: "准备下载..." },
             errorDownloadPrep: { en: "Failed to prepare download.", es: "Fallo al preparar descarga.", vi: "Lỗi chuẩn bị tải xuống.", ja: "ダウンロード準備失敗。", zhcn: "准备下载失败。" },
             downloadingImages: { en: "Downloading Images for ZIP...", es: "Descargando Imágenes para ZIP...", vi: "Đang tải Ảnh cho ZIP...", ja: "ZIP用画像ダウンロード中...", zhcn: "正在下载ZIP图片..." },
             errorImageFetchZip: { en: "Error fetching image for ZIP.", es: "Error al obtener imagen para ZIP.", vi: "Lỗi lấy ảnh cho ZIP.", ja: "ZIP用画像取得エラー。", zhcn: "获取ZIP图片错误。" },
             errorZipCreation: { en: "Error creating ZIP file.", es: "Error al crear archivo ZIP.", vi: "Lỗi tạo tệp ZIP.", ja: "ZIPファイル作成エラー。", zhcn: "创建ZIP文件错误。" },
             noImagesToDownload: { en: "No images to download.", es: "No hay imágenes para descargar.", vi: "Không có ảnh để tải.", ja: "ダウンロードする画像がありません。", zhcn: "没有可下载的图像。" },
            settingsModalTitle: { en: "Settings", es: "Ajustes", vi: "Cài đặt", ja: "設定", zhcn: "设置" },
            settingsModalLanguageSubheading: { en: "Language", es: "Idioma", vi: "Ngôn ngữ", ja: "言語", zhcn: "语言" },
            backgroundMusicTitle: { en: "Background Music", es: "Música de Fondo", vi: "Nhạc Nền", ja: "背景音楽", zhcn: "背景音乐" },
            settingsTriggerButtonAria: { en: "Settings", es: "Ajustes", vi: "Cài đặt", ja: "設定", zhcn: "设置" },
            hamburgerMenuAria: {en: "Toggle navigation", es: "Alternar navegación", vi: "Chuyển đổi điều hướng", ja: "ナビゲーションを開閉", zhcn: "切换导航"},
            closeSettingsModalAria: { en: "Close Settings", es: "Cerrar Ajustes", vi: "Đóng Cài đặt", ja: "設定を閉じる", zhcn: "关闭设置" },
            playMusic: { en: "Play Music", es: "Reproducir Música", vi: "Phát Nhạc", ja: "音楽を再生", zhcn: "播放音乐" },
            pauseMusic: { en: "Pause Music", es: "Pausar Música", vi: "Tạm Dừng Nhạc", ja: "音楽を一時停止", zhcn: "暂停音乐" },
            imageFormatLabel: { en: "Image Format:", es: "Formato Imagen:", vi: "Định dạng Ảnh:", ja: "画像形式：", zhcn: "图片格式：" }, tiffNotSupportedAlert: { en: "TIFF format is not supported by browsers for direct download. Images will be downloaded as PNG instead.", es: "El formato TIFF no es compatible con los navegadores para descarga directa. Las imágenes se descargarán como PNG.", vi: "Định dạng TIFF không được trình duyệt hỗ trợ tải xuống trực tiếp. Hình ảnh sẽ được tải xuống dưới dạng PNG.", ja: "TIFF形式はブラウザによる直接ダウンロードに対応していません。画像は代わりにPNGとしてダウンロードされます。", zhcn: "浏览器不支持直接下载TIFF格式。图像将以PNG格式下载。" },
            pricing: { en: "Pricing", es: "Precios", vi: "Giá cả", ja: "価格", zhcn: "定价" }, subscription: { en: "Subscription", es: "Suscripción", vi: "Đăng ký", ja: "サブスクリプション", zhcn: "订阅" }, freeTrial: { en: "Free Trial", es: "Prueba Gratuita", vi: "Dùng thử miễn phí", ja: "無料トライアル", zhcn: "免费试用" }, medium: { en: "Medium", es: "Medio", vi: "Trung bình", ja: "ミディアム", zhcn: "中级" }, pro: { en: "Pro", es: "Pro", vi: "Pro", ja: "プロ", zhcn: "专业" }, popular: { en: "Popular", es: "Popular", vi: "Phổ biến", ja: "人気", zhcn: "热门" }, comingSoon: { en: "Coming soon...", es: "Próximamente...", vi: "Sắp ra mắt...", ja: "近日公開...", zhcn: "即将推出..." }, monthlyPrice: { en: "Monthly price", es: "Precio mensual", vi: "Giá hàng tháng", ja: "月額料金", zhcn: "月费" }, desktopMobile: { en: "Desktop & Mobile", es: "Escritorio y Móvil", vi: "Máy tính & Di động", ja: "デスクトップ＆モバイル", zhcn: "桌面和移动" },
            generationAttempts: { en: "Generation attempts", es: "Intentos de generación", vi: "Lượt tạo", ja: "生成試行回数", zhcn: "生成次数" },
            regenerateConcept: { en: "Re-generate concept", es: "Re-generar concepto", vi: "Tạo lại ý tưởng", ja: "コンセプト再生成", zhcn: "重新生成概念" },
            videoDemoGenerate: { en: "Video demo generate", es: "Generar demo de video", vi: "Tạo demo video", ja: "ビデオデモ生成", zhcn: "视频演示生成" },
            unlimited: { en: "Unlimited", es: "Ilimitados", vi: "Không giới hạn", ja: "無制限", zhcn: "无限" },
            albumCoverFeature: { en: "Album cover", es: "Portada Álbum", vi: "Bìa Album", ja: "アルバムカバー", zhcn: "专辑封面" },
            prepareTextDownloadSelect: { en: "Select Sections for Text Download", es: "Seleccionar Secciones para Descargar Texto", vi: "Chọn Mục để Tải Văn bản", ja: "テキストDLセクション選択", zhcn: "选择文本下载部分" },
            prepareTextDownloadCancel: { en: "Cancel Text Selection", es: "Cancelar Selección de Texto", vi: "Hủy Chọn Văn bản", ja: "テキスト選択をキャンセル", zhcn: "取消文本选择" },
            finalizeTextDownload: { en: "Download Selected Text (.txt)", es: "Descargar Texto Seleccionado (.txt)", vi: "Tải Văn bản Đã chọn (.txt)", ja: "選択テキストをDL (.txt)", zhcn: "下载选定文本 (.txt)" },
                        noSectionsSelectedError: { en: "Please select at least one section to download.", es: "Seleccione al menos una sección para descargar.", vi: "Vui lòng chọn ít nhất một mục để tải xuống.", ja: "ダウンロードするセクションを少なくとも1つ選択してください。", zhcn: "请至少选择一个部分进行下载。" },
            noContentToDownload: { en: "No content available for selected sections.", es: "No hay contenido disponible para las secciones seleccionadas.", vi: "Không có nội dung cho các mục đã chọn.", ja: "選択したセクションに利用可能なコンテンツがありません。", zhcn: "所选部分没有可用内容。" },
            videoDemoTab: { en: "Video demo", es: "Demo de Video", vi: "Demo Video", ja: "ビデオデモ", zhcn: "视频演示" },
            albumCoverTab: { en: "Album cover", es: "Portada Álbum", vi: "Bìa Album", ja: "アルバムカバー", zhcn: "专辑封面" },
            comingSoonGeneral: { en: "Coming soon...", es: "Próximamente...", vi: "Sắp ra mắt...", ja: "近日公開...", zhcn: "即将推出..." },
            keyImagesCohesionTitle: { en: "Key Images Cohesion:", es: "Cohesión Imágenes Clave:", vi: "Tính gắn kết Hình ảnh Chính:", ja: "キー画像の結束性：", zhcn: "关键图像连贯性：" },
            moodboardCohesionTitle: { en: "Moodboard Cohesion:", es: "Cohesión Moodboard:", vi: "Tính gắn kết Moodboard:", ja: "ムードボードの結束性：", zhcn: "情绪板连贯性：" }
        };
        function formatDatasetKey(langCode, suffix = '') {
            let keyBase = (langCode === 'zh-CN') ? 'zhcn' : langCode.toLowerCase().split('-')[0];
            const capitalizedBase = keyBase.charAt(0).toUpperCase() + keyBase.slice(1);
            let key = 'lang' + capitalizedBase;
            if (suffix) {
                let camelSuffix = suffix.replace(/[-_](.)/g, (_, c) => c.toUpperCase());
                if (camelSuffix) {
                    camelSuffix = camelSuffix.charAt(0).toUpperCase() + camelSuffix.slice(1);
                }
                key += camelSuffix;
            }
            return key.charAt(0).toLowerCase() + key.slice(1);
        }


        function getTranslatedText(element, keyOrSuffix = '', isAttributeTarget = false, fallbackText = '') {
            if (internalTranslations[keyOrSuffix] && internalTranslations[keyOrSuffix][currentLang]) {
                return internalTranslations[keyOrSuffix][currentLang];
            } else if (internalTranslations[keyOrSuffix] && internalTranslations[keyOrSuffix]['en']) {
                return internalTranslations[keyOrSuffix]['en'];
            }

            let translation = '';
            if (element) {
                let actualSuffix = keyOrSuffix;
                if (element.id === 'prepare-text-download-button') {
                    actualSuffix = isTextDownloadModeActive ? 'cancel' : 'select';
                } else if (element.id === 'record-audio-button') {
                     actualSuffix = isRecording ? 'stop' : 'record';
                } else if (element.id === 'settings-trigger-button' && keyOrSuffix === 'aria-label') {
                    actualSuffix = 'ariaLabel';
                } else if (element.id === 'close-settings-modal' && keyOrSuffix === 'aria-label') {
                    actualSuffix = 'ariaLabel';
                } else if (element.id === 'hamburger-menu' && keyOrSuffix === 'aria-label') {
                    actualSuffix = 'ariaLabel';
                }


                const primaryDataKey = formatDatasetKey(currentLang, actualSuffix);
                const englishDataKey = formatDatasetKey('en', actualSuffix);
                const baseLangKey = formatDatasetKey(currentLang);
                const baseEnKey = formatDatasetKey('en');

                translation = element.dataset[primaryDataKey] ?? element.dataset[englishDataKey] ?? element.dataset[baseLangKey] ?? element.dataset[baseEnKey];

                if ((translation === undefined || translation === null || translation === '') && currentLang === 'en') {
                    if (isAttributeTarget) {
                        if(actualSuffix.toLowerCase().includes('placeholder')) translation = element.getAttribute('placeholder');
                        else if (actualSuffix.toLowerCase().includes('arialabel')) translation = element.getAttribute('aria-label');
                    } else if (element.textContent && element.childNodes.length === 1 && element.childNodes[0].nodeType === Node.TEXT_NODE) {
                        translation = element.textContent;
                    }
                }
            }
            return String(translation ?? fallbackText).trim();
        }


        function updateLanguage(langCode) {
            currentLang = langCode;
            console.log(`Switching UI language to: ${langCode}`);
            document.documentElement.lang = langCode;

            const currentTranslatableElements = document.querySelectorAll(
                '[data-lang-en], [data-lang-en-placeholder], [data-lang-en-aria-label]'
            );

            currentTranslatableElements.forEach(el => {
                let translated = false;
                const isPlaceholderTarget = el.hasAttribute('data-lang-en-placeholder') || ((el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') && el.hasAttribute('placeholder'));
                const isAriaLabelTarget = el.hasAttribute('data-lang-en-aria-label') || el.hasAttribute('aria-label');


                let suffix = '';
                if (isPlaceholderTarget) suffix = 'placeholder';
                if (isAriaLabelTarget) suffix = 'ariaLabel';


                const fallbackValue = isPlaceholderTarget ? (el.dataset[formatDatasetKey('en', 'placeholder')] || el.getAttribute('placeholder')) :
                                      isAriaLabelTarget ? (el.dataset[formatDatasetKey('en', 'ariaLabel')] || el.getAttribute('aria-label')) :
                                      (el.dataset[formatDatasetKey('en')] || el.textContent);

                let textTranslation = getTranslatedText(el, suffix, isPlaceholderTarget || isAriaLabelTarget, fallbackValue); // Changed 'translation' to 'textTranslation' for clarity

                if (isAriaLabelTarget) {
                    if (el.id === 'settings-trigger-button' && internalTranslations.settingsTriggerButtonAria) {
                        textTranslation = internalTranslations.settingsTriggerButtonAria[currentLang] || internalTranslations.settingsTriggerButtonAria['en'];
                    } else if (el.id === 'close-settings-modal' && internalTranslations.closeSettingsModalAria) {
                        textTranslation = internalTranslations.closeSettingsModalAria[currentLang] || internalTranslations.closeSettingsModalAria['en'];
                    } else if (el.id === 'hamburger-menu' && internalTranslations.hamburgerMenuAria) {
                        textTranslation = internalTranslations.hamburgerMenuAria[currentLang] || internalTranslations.hamburgerMenuAria['en'];
                    }
                    el.setAttribute('aria-label', textTranslation);
                    translated = true;
                }
                                if (isPlaceholderTarget) {
                    // If textTranslation was already determined by aria-label, we might not want to override placeholder
                    // unless placeholder-specific logic exists or it's a different translation.
                    // For now, let's assume textTranslation is the general one if not specifically for aria-label.
                    // If suffix was 'placeholder', getTranslatedText would have handled it.
                    // If suffix was empty and textTranslation got a general value, use that.
                    el.placeholder = textTranslation;
                    translated = true;
                }

                if (el.hasAttribute('data-lang-en')) {
                     // Get the base text translation if not already handled by aria-label or placeholder
                     if (!translated || (translated && (isAriaLabelTarget || isPlaceholderTarget) && suffix === '')) {
                        // This condition ensures we only re-fetch general text if:
                        // 1. It wasn't translated at all yet (neither aria nor placeholder)
                        // 2. It was translated for aria/placeholder, but 'suffix' was empty, meaning textTranslation
                        //    might still hold a general fallback from getTranslatedText. We re-evaluate for general content.
                        //    This logic might need refinement if a single data-lang-en is meant for multiple targets differently.

                        // Let's simplify: if we are here, it means we are processing the general text content
                        // of an element that has a data-lang-en attribute.
                        // We should re-fetch the general text if suffix was specific (ariaLabel/placeholder)
                        // or if it wasn't translated at all.
                        let generalTextTranslation = getTranslatedText(el, '', false, fallbackValue);


                        if (el.id === 'prepare-text-download-button') {
                             generalTextTranslation = getTranslatedText(el, '', false, fallbackValue);
                         } else if (el.id === 'record-audio-button') {
                             generalTextTranslation = getTranslatedText(el, '', false, fallbackValue);
                         } else if (el.closest('#settings-modal-content')) {
                             if (el.tagName === 'H3') generalTextTranslation = getTranslatedText(null, 'settingsModalTitle', false, fallbackValue);
                             else if (el.tagName === 'H4' && el.closest('.language-setting-container')) generalTextTranslation = getTranslatedText(null, 'settingsModalLanguageSubheading', false, fallbackValue);
                             else if (el.tagName === 'H4' && el.nextElementSibling?.classList.contains('music-controls')) generalTextTranslation = getTranslatedText(null, 'backgroundMusicTitle', false, fallbackValue);
                             else if (el.classList.contains('sr-only') && el.htmlFor === 'language-select') generalTextTranslation = getTranslatedText(null, 'settingsModalLanguageSubheading', false, fallbackValue); // For the label of language select
                             else generalTextTranslation = getTranslatedText(el, '', false, fallbackValue);
                         } else {
                             generalTextTranslation = getTranslatedText(el, '', false, fallbackValue);
                         }
                         textTranslation = generalTextTranslation; // Use this specifically for text content
                     }


                    if (el.tagName === 'TITLE') {
                        document.title = textTranslation;
                    } else if (el.classList.contains('tab-link')) {
                        const textSpan = el.querySelector('span:not(.pro-badge-tab):not(.sr-only)');
                        if (textSpan) textSpan.textContent = textTranslation;
                        const badgeSpan = el.querySelector('.pro-badge-tab');
                        if (badgeSpan) badgeSpan.textContent = getTranslatedText(badgeSpan, '', false, badgeSpan.textContent);
                    } else if (el.id === 'initial-prompt' && el.querySelector('p')) {
                         el.querySelector('p').textContent = textTranslation;
                    } else if (el.closest('#image-format-selector-container') && el.tagName === 'LABEL') {
                        el.textContent = textTranslation;
                    } else if (el.closest('#pricing-page') && (el.classList.contains('pricing-tier') || el.classList.contains('coming-soon') || el.classList.contains('feature-name') || (el.classList.contains('feature-value') && !el.classList.contains('icon-check')) || el.classList.contains('popular-badge'))) {
                        if (el.classList.contains('feature-name') && (fallbackValue === "Album cover" || el.dataset.langEn === "Album cover") ) {
                             textTranslation = getTranslatedText(null, 'albumCoverFeature', false, fallbackValue);
                        }
                        el.textContent = textTranslation;
                    } else if (el.matches('h1, h2, h3:not(#settings-modal-content > h3), h4:not(#settings-modal-content .settings-section h4), p, li, option, small, a > span:not([class])') || (el.tagName === 'SPAN' && !el.classList.length && el.parentElement.matches('a, li, p'))) {
                         let targetTextElement = el;
                         if (el.classList.contains('logo') && el.querySelector('span[data-lang-en]')) {
                             targetTextElement = el.querySelector('span[data-lang-en]');
                         }
                         // Check if the element is the new Feedback link before setting textContent
                         if (el.getAttribute('href') === "https://forms.office.com/pages/responsepage.aspx?id=cTYy0b7NF0S01L2yS1Exa_LJCmAYC6hElQOVUA5GmmJUM0JPUUEzSU9RUEVZSUJRQVNDNVVQTUlTVS4u&route=shorturl") {
                            // Already has data-lang-en, textTranslation should be correct from getTranslatedText
                         }
                         targetTextElement.textContent = textTranslation;
                    } else if (el.tagName === 'BUTTON' && !isAriaLabelTarget && !isPlaceholderTarget && !el.querySelector('svg') && !el.closest('#settings-modal-content')) {
                        el.textContent = textTranslation;
                    }
                }
            });

            if (recordAudioButton) updateRecordingUI(isRecording);
            if (recordStatus?.dataset?.statusKey) { let statusKey = recordStatus.dataset.statusKey; let fallback = recordStatus.dataset.statusFallback || ''; let statusClass = Array.from(recordStatus.classList).find(c => ['complete', 'error', 'recording', 'transcribing'].includes(c)) || ''; let isPersistent = statusClass === 'complete' || statusClass === 'error'; updateRecordStatus(getTranslatedText(null, statusKey, false, fallback), statusClass, isPersistent, statusKey); } else if (!isRecording) clearRecordStatus();
            if (loadingOverlay.classList.contains('show')) { const loadingP = loadingOverlay.querySelector('p'); if (loadingP?.dataset.lastKey) loadingP.textContent = getTranslatedText(loadingP, loadingP.dataset.lastKey, false, 'Loading...'); }
            if (errorMessageDiv.style.display === 'block' && errorMessageDiv.dataset.errorKey) { errorMessageDiv.textContent = getTranslatedText(null, errorMessageDiv.dataset.errorKey, false, errorMessageDiv.textContent); }
            if (isSpeechRecognitionSupported && recognition) { const bcp47Map = { 'zh-CN': 'zh-CN', 'vi': 'vi-VN', 'ja': 'ja-JP', 'es': 'es-ES' }; const newRecLang = bcp47Map[langCode] || (langCode.includes('-') ? langCode : `${langCode}-${langCode.toUpperCase()}`); if (recognition.lang !== newRecLang) { if (isRecording) handleRecordButtonClick(); recognition.lang = newRecLang; console.log("Updated speech lang:", newRecLang); } }
                        if (generateStep === 'details_shown' && tabbedResultsArea?.style.display === 'flex') {
                tabContents?.forEach(contentDiv => {
                    contentDiv.querySelectorAll('[data-placeholder-key]').forEach(ph => { const isTruePlaceholder = ph.classList.contains('placeholder-notice') || ph.closest('.placeholder-notice'); const isNote = (ph.tagName === 'SMALL' || ph.tagName === 'SPAN') && ph.dataset.placeholderKey.toLowerCase().includes('note'); if (isTruePlaceholder || isNote) { ph.textContent = getTranslatedText(null, ph.dataset.placeholderKey, false, ph.textContent); } });
                     contentDiv.querySelectorAll('.budget-column.placeholder-notice h3').forEach(h3 => { const m = h3.textContent.match(/^(Low|Mid|High)/i); if(m) h3.textContent = getTranslatedText(null, `budget${m[1]}Title`, false, `${m[1]} Budget`); });
                     contentDiv.querySelectorAll('.budget-column.placeholder-notice p[data-placeholder-key="budgetDetailsMissing"]').forEach(p => p.textContent = `(${getTranslatedText(null, 'budgetDetailsMissing', false, `Details missing.`)})`);
                     contentDiv.querySelectorAll('.image-placeholder figcaption .fallback-notice').forEach(span => { const m = span.textContent.match(/\(([^:]+):\s*(.*)\)/); if(m) span.textContent = `(${getTranslatedText(null, 'placeholderReason', false, 'Placeholder')}: ${m[2]})`; });
                     contentDiv.querySelectorAll('.font-sample strong').forEach(strong => { if (strong.nextSibling?.textContent.includes('"')) { const key = strong.textContent.toLowerCase().startsWith('title') ? 'fontSampleTitleLabel' : 'fontSampleBodyLabel'; strong.textContent = getTranslatedText(null, key, false, strong.textContent); } });
                     contentDiv.querySelectorAll('.cohesion-explanation strong').forEach(strong => {
                        if (strong.textContent.includes(internalTranslations.keyImagesCohesionTitle.en.slice(0, -1))) {
                            strong.textContent = getTranslatedText(null, 'keyImagesCohesionTitle', false, internalTranslations.keyImagesCohesionTitle.en);
                        } else if (strong.textContent.includes(internalTranslations.moodboardCohesionTitle.en.slice(0, -1))) {
                            strong.textContent = getTranslatedText(null, 'moodboardCohesionTitle', false, internalTranslations.moodboardCohesionTitle.en);
                        }
                    });
                });
            }
             if (generateStep === 'concept_shown' && conceptTextOutput?.classList.contains('placeholder-notice')) { conceptTextOutput.textContent = getTranslatedText(null, 'conceptPlaceholder', false, 'Concept text will appear here...'); }
            if (settingsTriggerButton) {
                settingsTriggerButton.setAttribute('aria-label', getTranslatedText(settingsTriggerButton, 'ariaLabel', true, 'Settings'));
            }
             if (hamburgerButton) {
                hamburgerButton.setAttribute('aria-label', getTranslatedText(hamburgerButton, 'ariaLabel', true, internalTranslations.hamburgerMenuAria.en));
            }
            if (closeSettingsModal) {
                closeSettingsModal.setAttribute('aria-label', getTranslatedText(closeSettingsModal, 'ariaLabel', true, 'Close Settings'));
            }
            updatePlayPauseMusicButtonUI(musicIsPlaying);
            document.querySelectorAll('.feature-value[data-lang-en="Unlimited"]').forEach(el => { el.textContent = getTranslatedText(el, 'unlimited', false, 'Unlimited'); });
            document.querySelectorAll('#tab-content-video-demo .placeholder-notice, #tab-content-album-cover .placeholder-notice').forEach(el => { el.textContent = getTranslatedText(null, 'comingSoonGeneral', false, "Coming soon..."); });
        }
        function saveLanguagePreference(langCode) { try { localStorage.setItem('mvGeneratorLang', langCode); } catch (e) { console.warn("Failed to save lang pref:", e)} }
        function loadLanguagePreference() { try { const saved = localStorage.getItem('mvGeneratorLang'); if (saved && Array.from(languageSelect.options).some(o => o.value === saved)) { languageSelect.value = saved; return saved; } } catch (e) {} return languageSelect ? languageSelect.value : 'en'; }

         function showGuideModal() { if (guideModal) { updateLanguage(currentLang); guideModal.classList.add('show'); } }
         function hideGuideModal() { if (guideModal) guideModal.classList.remove('show'); }

        function toggleTextDownloadMode(forceState) {
            isTextDownloadModeActive = (typeof forceState === 'boolean') ? forceState : !isTextDownloadModeActive;
            console.log("Text Download Mode:", isTextDownloadModeActive);

            if (resultsTabsContainer) {
                resultsTabsContainer.classList.toggle('selection-mode-active', isTextDownloadModeActive);
                if (isTextDownloadModeActive) {
                    resultsTabsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            if (prepareTextDownloadButton) {
                const keySuffix = isTextDownloadModeActive ? 'cancel' : 'select';
                prepareTextDownloadButton.textContent = getTranslatedText(prepareTextDownloadButton, keySuffix, false, isTextDownloadModeActive ? 'Cancel Selection' : 'Select Sections');
                prepareTextDownloadButton.classList.toggle('btn-warning', isTextDownloadModeActive);
                prepareTextDownloadButton.classList.toggle('btn-secondary', !isTextDownloadModeActive);
            }

            if (!isTextDownloadModeActive) {
                tabLinks.forEach(link => link.classList.remove('selected-for-download'));
            }
            updateFinalizeButtonState();
        }

        function updateFinalizeButtonState() {
            if (!finalizeTextDownloadButton) return;
            const selectedTabsForDownload = document.querySelectorAll('.results-tabs button.selected-for-download');
            const canFinalize = isTextDownloadModeActive && selectedTabsForDownload.length > 0;
            finalizeTextDownloadButton.disabled = !canFinalize;
        }

        function gatherAllTextData(selectedSectionKeys = []) {
            let fullText = `MV CONCEPT REPORT\nGenerated by MVPot (${new Date().toLocaleString()})\n\n`;
            const getCleanText = (el) => el ? el.innerText.trim() : 'N/A';
            const getHtmlAsText = (el) => { if (!el) return 'N/A'; let temp = document.createElement('div'); temp.innerHTML = el.innerHTML; temp.querySelectorAll('br').forEach(br => br.replaceWith('\n')); temp.querySelectorAll('li:not(.placeholder-notice)').forEach(li => li.prepend('- ')); temp.querySelectorAll('strong, b').forEach(strong => strong.textContent = `**${strong.textContent}**`); temp.querySelectorAll('em, i').forEach(em => em.textContent = `_${em.textContent}_`); return temp.innerText.trim() || 'N/A'; };

            if (selectedSectionKeys.includes('concept')) {
                fullText += "## CONCEPT / KEY VISUAL\n";
                fullText += (document.getElementById('tab-content-concept')?.querySelector('p')?.innerText.trim() || currentConceptText || 'N/A') + "\n\n";
            }
            if (selectedSectionKeys.includes('requirements')) {
                fullText += "## REQUIREMENTS FOR MV\n";
                const reqItems = document.getElementById('tab-content-requirements')?.querySelectorAll('ul li:not(.placeholder-notice)');
                                if (reqItems && reqItems.length > 0) { reqItems.forEach(li => fullText += `- ${li.innerText.trim()}\n`); } else { fullText += "N/A\n"; }
                fullText += "\n";
            }
            if (selectedSectionKeys.includes('budget')) {
                fullText += "## ESTIMATED BUDGET\n";
                const budgetCols = document.getElementById('tab-content-budget')?.querySelectorAll('.budget-column:not(.placeholder-notice)');
                if (budgetCols && budgetCols.length > 0) { budgetCols.forEach(col => { fullText += `**${col.querySelector('h3')?.innerText.trim()}**\n`; fullText += getHtmlAsText(col.querySelector('p:not(.placeholder-notice)')) + "\n\n"; }); } else { const rawBudget = document.getElementById('tab-content-budget')?.querySelector('.raw-budget-output pre'); fullText += (rawBudget ? rawBudget.innerText.trim() : 'N/A') + "\n\n"; }
            }
            if (selectedSectionKeys.includes('visuals_desc')) {
                fullText += "## VISUAL DEMO (KEY IMAGES DESCRIPTIONS)\n";
                const keyImgFigures = document.getElementById('tab-content-visuals')?.querySelectorAll('.image-placeholder:not(.placeholder-notice)');
                if (keyImgFigures && keyImgFigures.length > 0) { keyImgFigures.forEach((fig, i) => fullText += `${i+1}. ${getCleanText(fig.querySelector('figcaption'))}\n`); } else { fullText += "N/A\n"; }
                const cohesionVisuals = document.getElementById('tab-content-visuals')?.querySelector('.cohesion-explanation');
                if (cohesionVisuals) {
                     fullText += `\n${getCleanText(cohesionVisuals)}\n`;
                }
                fullText += "\n";
            }
            if (selectedSectionKeys.includes('moodboard')) {
                fullText += "## MOODBOARD INFLUENCES\n";
                const moodboardDesc = document.getElementById('moodboard-description:not(.placeholder-notice)');
                fullText += (moodboardDesc ? moodboardDesc.innerText.trim() : 'N/A') + "\n";
                const moodboardItems = document.getElementById('moodboard-images')?.querySelectorAll('.image-placeholder:not(.placeholder-notice)');
                if (moodboardItems && moodboardItems.length > 0) { moodboardItems.forEach(fig => fullText += `* ${getCleanText(fig.querySelector('figcaption'))}\n`); }
                const cohesionMoodboard = document.getElementById('tab-content-moodboard')?.querySelector('.cohesion-explanation');
                 if (cohesionMoodboard) {
                    fullText += `\n${getCleanText(cohesionMoodboard)}\n`;
                }
                fullText += "\n";
            }
            if (selectedSectionKeys.includes('fonts')) {
                fullText += "## TYPOGRAPHY/FONT SUGGESTION\n";
                const fontSuggestion = document.getElementById('tab-content-fonts')?.querySelector('.font-suggestion');
                if (fontSuggestion) { fullText += `Font Combination: ${getCleanText(fontSuggestion.querySelector('h3'))}\n`; fullText += `Reason: ${getCleanText(fontSuggestion.querySelector('.font-reason'))}\n`; fontSuggestion.querySelectorAll('.font-sample').forEach(sample => fullText += `${getCleanText(sample)}\n`); } else { fullText += "N/A\n"; }
                fullText += "\n";
            }
             if (selectedSectionKeys.includes('palette')) {
                fullText += "## COLOR PALETTE\n";
                const swatches = document.getElementById('tab-content-palette')?.querySelectorAll('.color-swatch:not(.placeholder-notice)');
                if (swatches && swatches.length > 0) { swatches.forEach(sw => { fullText += `${sw.classList.contains('dominant-swatch') ? 'Dominant ' : ''}${getCleanText(sw.querySelector('.color-name'))} (${getCleanText(sw.querySelector('.hex-code'))}) - Application: ${getCleanText(sw.querySelector('.color-application'))}\n`; }); } else { fullText += "N/A\n"; }
            }
            console.log("Generated Text Data (Selected by Tabs):\n", fullText);
            return fullText;
        }

        async function handleFinalizeTextDownload() {
            const selectedTabElements = document.querySelectorAll('.results-tabs button.selected-for-download');
            const selectedSectionKeys = Array.from(selectedTabElements)
                .map(tabEl => tabTargetToSectionKey[tabEl.dataset.tabTarget])
                .filter(Boolean);

            if (selectedSectionKeys.length === 0) {
                displayError(getTranslatedText(null, "noSectionsSelectedError", false, "Please select at least one section."), "noSectionsSelectedError");
                return;
            }

            showLoading("preparingDownload", "Preparing Text Download...");
            await new Promise(resolve => setTimeout(resolve, 100));
            try {
                const textData = gatherAllTextData(selectedSectionKeys);
                const contentToCheck = textData.replace(/MV CONCEPT REPORT\nGenerated by MVPot \([\s\S]*?\)\n\n/, '').replace(/N\/A\n*/g, '').trim();
                if (contentToCheck === "") {
                     displayError(getTranslatedText(null, "noContentToDownload", false, "No content available for selected sections."), "noContentToDownload");
                     toggleTextDownloadMode(false);
                     return;
                }
                const blob = new Blob([textData], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'mv_concept_selected_info.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                toggleTextDownloadMode(false);
            } catch (err) {
                console.error("Error preparing selected text download:", err);
                displayError(getTranslatedText(null, "errorDownloadPrep", false, "Failed to prepare text download."), "errorDownloadPrep");
                toggleTextDownloadMode(false);
            } finally {
                hideLoading();
            }
        }


        async function handleDownloadAllImages() { const selectedFormat = imageDownloadFormatSelect ? imageDownloadFormatSelect.value : 'png'; let effectiveFormat = selectedFormat; if (selectedFormat === 'tiff') { alert(getTranslatedText(null, "tiffNotSupportedAlert", false, "TIFF format not supported... PNG instead.")); effectiveFormat = 'png'; } showLoading("downloadingImages", "Downloading Images for ZIP..."); const zip = new JSZip(); const imagesToProcess = []; let imgCounter = 1; document.querySelectorAll('#tab-content-visuals .image-placeholder img[src], #tab-content-moodboard .image-placeholder img[src]').forEach(imgEl => { if (imgEl.src && !imgEl.src.startsWith('data:')) { const isMoodboard = imgEl.closest('#tab-content-moodboard'); const figcaption = imgEl.closest('.image-placeholder')?.querySelector('figcaption'); let nameHint = figcaption ? figcaption.innerText.trim().split('\n')[0].substring(0, 30) : (isMoodboard ? 'mood' : 'key'); nameHint = nameHint.replace(/[^\w\s-]/g, '').replace(/\s+/g, '_').toLowerCase(); if (!nameHint) nameHint = (isMoodboard ? 'moodboard_item_' : 'key_image_'); imagesToProcess.push({ url: imgEl.src, baseFilename: `${nameHint}_${imgCounter++}` }); } }); if (imagesToProcess.length === 0) { displayError(getTranslatedText(null, "noImagesToDownload", false, "No images found to download."), "noImagesToDownload"); hideLoading(); return; } const convertAndAddToZip = async (imageData) => { try { const response = await fetch(imageData.url); if (!response.ok) throw new Error(`HTTP error ${response.status} for ${imageData.url}`); const originalBlob = await response.blob(); const img = new Image(); const loadedPromise = new Promise((resolve, reject) => { img.onload = () => resolve(); img.onerror = (errEvent) => { console.error('Image load error:', imageData.url, errEvent); reject(new Error('Image load error: ' + imageData.url)); }; img.src = URL.createObjectURL(originalBlob); }); await loadedPromise; URL.revokeObjectURL(img.src); const canvas = document.createElement('canvas'); canvas.width = img.naturalWidth; canvas.height = img.naturalHeight; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0); let mimeType = 'image/png'; let quality = undefined; let newExtension = '.png'; if (effectiveFormat === 'jpg') { mimeType = 'image/jpeg'; quality = 0.90; newExtension = '.jpg'; } else if (effectiveFormat === 'webp') { mimeType = 'image/webp'; quality = 0.90; newExtension = '.webp'; } const convertedBlob = await new Promise((resolve, reject) => { canvas.toBlob(blob => { if (blob) resolve(blob); else reject(new Error('Canvas toBlob failed: ' + imageData.url)); }, mimeType, quality); }); const finalFilename = imageData.baseFilename + newExtension; zip.file(finalFilename, convertedBlob); } catch (error) { console.error(`Failed image ${imageData.url}:`, error); const errorFilename = imageData.baseFilename + '_ERROR.txt'; zip.file(errorFilename, `Could not download/convert: ${imageData.url}\nError: ${error.message}`); } }; try { await Promise.all(imagesToProcess.map(convertAndAddToZip)); const content = await zip.generateAsync({ type: "blob" }); const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = "mv_concept_images.zip"; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); } catch (error) { console.error("ZIP creation error:", error); displayError(getTranslatedText(null, "errorZipCreation", false, "Error creating ZIP file."), "errorZipCreation"); } finally { hideLoading(); } }

        function updatePlayPauseMusicButtonUI(isPlaying) { if (playPauseMusicButton) { playPauseMusicButton.innerHTML = isPlaying ? svgIconPause : svgIconPlay; const labelKey = isPlaying ? 'pauseMusic' : 'playMusic'; const fallbackLabel = isPlaying ? 'Pause Music' : 'Play Music'; playPauseMusicButton.setAttribute('aria-label', getTranslatedText(null, labelKey, false, fallbackLabel)); } }
        function initializeMusicPlayer() { if (backgroundMusic && volumeSlider && playPauseMusicButton && !musicInitialized) { const savedVolume = localStorage.getItem('musicVolume'); if (savedVolume !== null) { backgroundMusic.volume = parseFloat(savedVolume); volumeSlider.value = parseFloat(savedVolume) * 100; } else { backgroundMusic.volume = 0.5; volumeSlider.value = 50; } musicInitialized = true; backgroundMusic.play().then(() => { console.log("Background music autoplay initiated."); }).catch(error => { console.warn("Background music autoplay prevented:", error); updatePlayPauseMusicButtonUI(false); }); } updatePlayPauseMusicButtonUI(!backgroundMusic.paused && backgroundMusic.duration > 0 && !backgroundMusic.ended); }

        // --- Floating Image Logic ---
        function initFloatingImages() {
            const imageInfos = [
                { id: 'parallax-speaker', baseTop: 20, baseLeft: 10 },
                { id: 'parallax-dj', baseTop: 50, baseLeft: 5 },
                { id: 'parallax-cutscene', baseTop: 15, baseRight: 8 },
                { id: 'parallax-soundcard', baseTop: 60, baseRight: 12 },
                { id: 'parallax-headphones', baseTop: 35, baseRight: 15 }
            ];

            imageInfos.forEach(info => {
                const el = document.getElementById(info.id);
                if (el) {
                    const topOffset = (Math.random() - 0.5) * 8;
                    const sideOffset = (Math.random() - 0.5) * 5;

                    if (info.baseLeft !== undefined) {
                        el.style.left = `calc(${info.baseLeft + sideOffset}% - ${el.offsetWidth / 2}px)`;
                    } else if (info.baseRight !== undefined) {
                        el.style.right = `calc(${info.baseRight + sideOffset}% - ${el.offsetWidth / 2}px)`;
                    }
                    el.style.top = `calc(${info.baseTop + topOffset}% - ${el.offsetHeight / 2}px)`;

                    const randomDuration = 5 + Math.random() * 3;
                    const randomDelay = Math.random() * 2;

                    el.style.animationDuration = `${randomDuration}s`;
                    el.style.animationDelay = `-${randomDelay}s`;
                    el.style.opacity = '0.85';
                }
            });
        }

        // --- MODIFIED navLinks event listener & Hamburger Functionality ---
        function setupEventListeners() {
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageTarget = link.getAttribute('data-page');
                    const scrollToTargetId = link.getAttribute('data-scroll-to');
                    const isExternalLink = link.getAttribute('target') === '_blank'; // Check for external links

                    playSound(hoverSound);

                    if (pageTarget) {
                        e.preventDefault();
                        showPage(pageTarget);
                        navLinks.forEach(nl => {
                            if (nl.getAttribute('data-scroll-to')) { // Deactivate any "About" like links
                                nl.classList.remove('active');
                            }
                             // Remove active from external links when a page link is clicked
                            if (nl.getAttribute('target') === '_blank') {
                                nl.classList.remove('active');
                            }
                        });
                        // Make sure the clicked page link is active
                        link.classList.add('active');
                    } else if (scrollToTargetId) {
                        e.preventDefault();
                        if (activePage !== 'home') {
                            showPage('home');
                            setTimeout(() => {
                                document.getElementById(scrollToTargetId)?.scrollIntoView({ behavior: 'smooth' });
                                navLinks.forEach(nl => nl.classList.remove('active'));
                                document.querySelector('.nav-link[data-page="home"]')?.classList.add('active');
                                link.classList.add('active');
                            }, 150);
                        } else {
                            document.getElementById(scrollToTargetId)?.scrollIntoView({ behavior: 'smooth' });
                            navLinks.forEach(nl => nl.classList.remove('active'));
                            document.querySelector('.nav-link[data-page="home"]')?.classList.add('active');
                            link.classList.add('active');
                        }
                    } else if (isExternalLink) {
                        // For external links like "Feedback", don't prevent default.
                        // Optionally, you could remove 'active' from other links if desired,
                        // but typically external links don't maintain an active state within the site's nav.
                        // For this case, we'll just let it open in a new tab.
                        // No specific active state management for external links themselves.
                    }
                     // Close mobile nav if open
                    if (mainNavUl && mainNavUl.classList.contains('mobile-nav-open')) {
                        mainNavUl.classList.remove('mobile-nav-open');
                        hamburgerButton.setAttribute('aria-expanded', 'false');
                    }
                });
                link.addEventListener('mouseenter', () => playSound(hoverSound));
            });

            if (hamburgerButton && mainNavUl) {
                hamburgerButton.addEventListener('click', () => {
                    playSound(clickSound);
                    const isExpanded = mainNavUl.classList.toggle('mobile-nav-open');
                    hamburgerButton.setAttribute('aria-expanded', isExpanded.toString());
                });
            }


            if (exploreButton) { exploreButton.addEventListener('click', () => { playSound(clickSound); showPage('feature'); }); exploreButton.addEventListener('mouseenter', () => playSound(hoverSound)); }
            backButtons.forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); playSound(hoverSound); showPage('home'); }); button.addEventListener('mouseenter', () => playSound(hoverSound)); });
            if (generateConceptButton) { generateConceptButton.addEventListener('click', () => { playSound(clickSound); handleGenerateConcept(); }); generateConceptButton.addEventListener('mouseenter', () => playSound(hoverSound)); }
            if (generateLyricsButton) { generateLyricsButton.addEventListener('click', () => { playSound(hoverSound); generateRandomLyrics(); }); generateLyricsButton.addEventListener('mouseenter', () => playSound(hoverSound)); }
            if (pickConceptButton) { pickConceptButton.addEventListener('click', () => { playSound(clickSound); handlePickConcept(); }); pickConceptButton.addEventListener('mouseenter', () => playSound(hoverSound)); }
            if (regenerateConceptButtonAlt) { regenerateConceptButtonAlt.addEventListener('click', () => { playSound(hoverSound); handleRegenerateConceptAlt(); }); regenerateConceptButtonAlt.addEventListener('mouseenter', () => playSound(hoverSound)); }
            if (recordAudioButton) recordAudioButton.addEventListener('mouseenter', () => playSound(hoverSound));
            if (languageSelect) { languageSelect.addEventListener('change', (e) => { playSound(hoverSound); updateLanguage(e.target.value); saveLanguagePreference(e.target.value); }); }
            if (howToUseButton) { howToUseButton.addEventListener('click', () => { playSound(hoverSound); showGuideModal(); }); howToUseButton.addEventListener('mouseenter', () => playSound(hoverSound)); }
            if (closeGuideModal) { closeGuideModal.addEventListener('click', () => { playSound(hoverSound); hideGuideModal(); }); closeGuideModal.addEventListener('mouseenter', () => playSound(hoverSound)); }
            if (guideModal) guideModal.addEventListener('click', (e) => { if (e.target === guideModal) { hideGuideModal(); } });

            tabLinks = resultsTabsContainer?.querySelectorAll('.tab-link');
            if (tabLinks) {
                 tabLinks.forEach(link => {
                     link.addEventListener('click', (e) => {
                         if (isTextDownloadModeActive) {
                             e.preventDefault();
                             playSound(clickSound);
                             const targetTabId = link.dataset.tabTarget;
                             if (tabTargetToSectionKey[targetTabId]) {
                                 link.classList.toggle('selected-for-download');
                                 updateFinalizeButtonState();
                             } else {
                                 console.log(`Tab ${targetTabId} is not selectable for text download.`);
                             }
                         } else {
                             playSound(hoverSound);
                             activateTab(link);
                         }
                     });
                     link.addEventListener('mouseenter', () => {
                         if (!isTextDownloadModeActive) {
                             playSound(hoverSound);
                         }
                     });
                 });
            }

            if (prepareTextDownloadButton) {
                 prepareTextDownloadButton.addEventListener('click', () => {
                     playSound(clickSound);
                     toggleTextDownloadMode();
                 });
                 prepareTextDownloadButton.addEventListener('mouseenter', () => playSound(hoverSound));
            }
            if (finalizeTextDownloadButton) {
                 finalizeTextDownloadButton.addEventListener('click', () => {
                     playSound(clickSound);
                     handleFinalizeTextDownload();
                 });
                 finalizeTextDownloadButton.addEventListener('mouseenter', () => playSound(hoverSound));
            }
            if (downloadAllImagesButton) {
                 downloadAllImagesButton.addEventListener('click', () => {
                     playSound(clickSound);
                     handleDownloadAllImages();
                 });
                 downloadAllImagesButton.addEventListener('mouseenter', () => playSound(hoverSound));
            }
            if (imageDownloadFormatSelect) { imageDownloadFormatSelect.addEventListener('change', () => playSound(hoverSound)); }

            if (settingsTriggerButton) {
                // Inject PNG image instead of SVG
                const settingsIconImg = document.createElement('img');
                settingsIconImg.src = 'gear.png';
                settingsIconImg.alt = 'Settings Icon';
                settingsIconImg.classList.add('settings-icon-png'); // Add class for styling
                settingsTriggerButton.innerHTML = ''; // Clear previous content
                settingsTriggerButton.appendChild(settingsIconImg);

                settingsTriggerButton.addEventListener('click', () => {
                    playSound(hoverSound);
                    if (settingsModal) settingsModal.classList.add('show');
                    updateLanguage(currentLang);
                });
                settingsTriggerButton.addEventListener('mouseenter', () => playSound(hoverSound));
            }
            if (closeSettingsModal) {
                closeSettingsModal.addEventListener('click', () => {
                    playSound(hoverSound);
                    if (settingsModal) settingsModal.classList.remove('show');
                });
                 closeSettingsModal.addEventListener('mouseenter', () => playSound(hoverSound));
            }
            if (settingsModal) {
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) {
                        settingsModal.classList.remove('show');
                    }
                });
            }

            if (playPauseMusicButton && backgroundMusic) { playPauseMusicButton.addEventListener('click', () => { playSound(clickSound); if (backgroundMusic.paused) { backgroundMusic.play().catch(error => console.warn("Play failed:", error)); } else { backgroundMusic.pause(); } }); playPauseMusicButton.addEventListener('mouseenter', () => playSound(hoverSound)); }
            if (volumeSlider && backgroundMusic) { volumeSlider.addEventListener('input', () => { const newVolume = volumeSlider.value / 100; backgroundMusic.volume = newVolume; try { localStorage.setItem('musicVolume', newVolume.toString()); } catch(e) { console.warn("Cannot save volume", e); } }); }
            if (backgroundMusic) { backgroundMusic.addEventListener('play', () => { musicIsPlaying = true; updatePlayPauseMusicButtonUI(true); }); backgroundMusic.addEventListener('pause', () => { musicIsPlaying = false; updatePlayPauseMusicButtonUI(false); }); }

            pricingColumns.forEach(column => {
                column.addEventListener('click', () => {
                    playSound(clickSound);
                    pricingColumns.forEach(col => col.classList.remove('highlighted'));
                    column.classList.add('highlighted');
                });
                 column.addEventListener('mouseenter', () => playSound(hoverSound));
            });
            window.addEventListener('resize', onWindowResize, false);
        }

        let scene, camera, renderer, model, clock; let modelVelocity = new THREE.Vector3(); let modelSize = new THREE.Vector3(); let boundaries = { x: 0, y: 0 }; const modelSpeed = 1.5;
        function init3DBackground() { if (!bgCanvas) { console.error("BG canvas not found!"); return; } console.log("Init 3D background..."); scene = new THREE.Scene(); clock = new THREE.Clock(); camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.z = 10; renderer = new THREE.WebGLRenderer({ canvas: bgCanvas, alpha: true, antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); scene.add(new THREE.AmbientLight(0xffffff, 1.5)); const dirLight = new THREE.DirectionalLight(0xffffff, 2); dirLight.position.set(5, 10, 7.5); scene.add(dirLight); const loader = new GLTFLoader(); const modelPath = '/mascot.glb'; loader.load(modelPath, (gltf) => { console.log("Model loaded."); model = gltf.scene; const box = new THREE.Box3().setFromObject(model); box.getSize(modelSize); const maxDim = Math.max(modelSize.x, modelSize.y, modelSize.z); const scaleFactor = 2.5 / maxDim; model.scale.set(scaleFactor, scaleFactor, scaleFactor); model.position.set(0, 0, 0); box.setFromObject(model); box.getSize(modelSize); console.log("Scaled Size:", modelSize); calculateBoundaries(); modelVelocity.set(Math.random() - 0.5, Math.random() - 0.5, 0).normalize().multiplyScalar(modelSpeed); scene.add(model); animate3D(); }, undefined, (error) => { console.error('Error loading model:', error); bgCanvas.style.display = 'none'; }); }
        function calculateBoundaries() { if (!camera) return; const distance = camera.position.z; const vFOV = THREE.MathUtils.degToRad(camera.fov); const height = 2 * Math.tan(vFOV / 2) * distance; const width = height * camera.aspect; boundaries.x = width / 2; boundaries.y = height / 2; }
        function onWindowResize() {
            if (!camera || !renderer) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            calculateBoundaries();

            // Close mobile nav if window is resized above mobile breakpoint
            if (window.innerWidth > 768 && mainNavUl && mainNavUl.classList.contains('mobile-nav-open')) {
                mainNavUl.classList.remove('mobile-nav-open');
                if (hamburgerButton) hamburgerButton.setAttribute('aria-expanded', 'false');
            }
        }
        function animate3D() { if (!renderer || !scene || !camera) return; requestAnimationFrame(animate3D); const delta = clock.getDelta(); if (model && modelSize.x > 0) { model.position.x += modelVelocity.x * delta; model.position.y += modelVelocity.y * delta; model.rotation.y += 0.1 * delta; model.rotation.x += 0.05 * delta; const halfWidth = modelSize.x / 2; const halfHeight = modelSize.y / 2; if (model.position.x + halfWidth > boundaries.x || model.position.x - halfWidth < -boundaries.x) { modelVelocity.x *= -1; model.position.x = THREE.MathUtils.clamp(model.position.x, -boundaries.x + halfWidth, boundaries.x - halfWidth); } if (model.position.y + halfHeight > boundaries.y || model.position.y - halfHeight < -boundaries.y) { modelVelocity.y *= -1; model.position.y = THREE.MathUtils.clamp(model.position.y, -boundaries.y + halfHeight, boundaries.y - halfHeight); } } renderer.render(scene, camera); }

        // --- Initialize ---
        init3DBackground();
        setupEventListeners();
        injectCheckmarks();
        initFloatingImages();
        const initialLangLoaded = loadLanguagePreference();
        updateLanguage(initialLangLoaded);
        initializeMusicPlayer();
        showPage('home');

        console.log("MV Generator Initialized. Lang:", initialLangLoaded, "Speech Support:", isSpeechRecognitionSupported);
         if (recordAudioButton && recordAudioButton.disabled && (!navigator.mediaDevices?.getUserMedia || !isSpeechRecognitionSupported)) { const errorKey = !navigator.mediaDevices?.getUserMedia ? 'statusAudioNotSupported' : 'statusSpeechRecNotSupported'; const errorMsg = getTranslatedText(null, errorKey, false, 'Audio/Speech input not supported.'); updateRecordStatus(errorMsg, 'error', true, errorKey); }

    }); // End DOMContentLoaded
    </script>

</body>
</html>
